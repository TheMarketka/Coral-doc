%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

\chapter{Classes \& Objects}

\syntax\begin{lstlisting}
Tmpl_Def ::= ['case'] 'class' Class_Def
           | ['case'] 'object' Object_Def
           | 'trait' Trait_Def
           | 'protocol' Pro_Def
           | ['case'] 'interface' Ifc_Def
           | 'refinement' Refinement_Def
           | 'type' Const_Type_Def 'end' ['type']
\end{lstlisting}

% TBD: | 'aspect' Aspect_Def

Classes (\sref{sec:class-definitions}) \& objects (\sref{sec:object-definitions}) are both defined in terms of {\em templates}. 





\section{Templates}
\label{sec:templates}

\syntax\begin{lstlisting}
Class_Parents  ::= Constr {['prepend'] 'with' Annot_Type} 
Trait_Parents  ::= Annot_Type {['prepend'] 'with' Annot_Type}
Template_Body  ::= [Self_Type] Template_Stat {semi Template_Stat}
Self_Type      ::= 'requires' 'self' ':' Type semi
                 | 'requires' [variable_id ':'] Type semi
                 | 'use' ['self'] 'as' variable_id [':' Type] semi
\end{lstlisting}

A template defines the type signature, behaviour and initial state of a trait, class of objects or of a single object. Templates for part of instance creation expressions (constructors, see \sref{sec:constructor-invocations} \& \sref{sec:constructor-destructor-def}), class definitions and object definitions. A template ~\lstinline!$sc$ with $mt_1$ with $\ldots$ with $mt_n$ { $\stats$ }!~ consists of constructor invocation $sc$, which defines the template's {\em superclass}, trait references $mt_1 \commadots mt_n$ $(n \geq 0)$, which statically define the template's included traits\footnote{Including protocols, which are also traits.}, and a statement sequence $\stats$, which contains initialization code and additional member definitions \& declarations for the template. Unlike in Scala, all trait references in class/trait parents need not to be exhaustive, as more prepended/included traits may be defined as a part of the template body. Trait references declared using \code{prepend with} are prepended to the template body instead of included (\sref{sec:include-classes}). 

Each trait reference $mt_i$ that is not prepended must denote a trait (\sref{sec:traits}). By contrast, the superclass constructor $sc$ normally refers to a class which is not a trait. It is possible to write a list of parents that starts with a trait reference, e.g. ~\lstinline!$mt_1$ with $\ldots$ with $mt_n$!~. In that case, the list of parents is implicitly extended to include the supertype of $mt_1$ as first parent type. This new supertype must have at least one constructor that does not take parameters and is accessible to the subclass (\sref{sec:modifiers}). 

The list of parents of a template must be well-formed, i.e. the class denoted by the superclass constructor $sc$ must be a subclass (or the superclass itself) of the superclasses of all the traits $mt_1 \commadots mt_n$. 

The {\em least proper supertype} of a template is the class type or compound type (\sref{sec:compound-types}) consisting of all its parent class types. 

The statement sequence $\stats$ contain member definitions that define new members or overwrite members in the parent classes. It is called also the {\em class-level block}, as it does not need to contain only member definitions for the template, but also arbitrary other expressions that construct the class object and that are executed while the class is being loaded, in the context of the class. If the template forms part of an abstract class or trait definition, the statement part $\stats$ may also contain declarations of abstract members. If the template forms part of a concrete class definition, $\stats$ may still contain declarations of abstract type members, but not of abstract term members. Unlike in Scala, the expressions in $\stats$ are not forming the primary constructor of the class, but a multi-constructor\footnote{The classes are open in Coral, a single class may have its statements spread across multiple source files (\sref{sec:open-templates}).} of the class itself. 

The sequence of template statements may be prefixed with a formal parameter definition prefixed with \code{requires} or \code{use}, i.e. ~\lstinline!use self as $x$!, ~\lstinline!use self as $x$: $T$!, ~\lstinline!requires $T$!~ or ~\lstinline!requires $x$: $T$!. If a formal parameter $x$ is given, it can be used as an alias for the reference \code{self} throughout the body of the template, including any nested types. If the formal parameter $x$ comes with a type $T$, this definition affects the {\em self type} $S$ of the underlying class or objects as follows: Let $C$ be the type of the class or trait or object defining the template. If a type $T$ is given for the formal self parameter, $S$ is the greatest lower bound of $T$ and $C$. If no type $T$ is given, $S$ is simply $C$. Inside the template, the type of \code{self} is assumed to be $S$. 

The self type of a class or object must conform to the self types of all classes which are inherited by the template $t$. 

A second form of self type definition reads just ~\lstinline!requires self: $S$!~. It prescribes the type $S$ for \code{self} without introducing an alias name for it. 

% TBD: add distinction between use/requires to coral naming guidelines (use-rename, requires-affect self type)

\example Consider the following class definitions:
\begin{lstlisting}
class Base extends Object; $\ldots$ end
trait Mixin extends Base; $\ldots$ end
object O extends Mixin; $\ldots$ end
\end{lstlisting}
In this case, the definition of \code{O} is expanded to be:
\begin{lstlisting}
object O extends Base with Mixin; $\ldots$ end
\end{lstlisting}





\subsection{Open Templates}
\label{sec:open-templates}

Unlike in Java, Scala or any other language that does not feature open classes, and similar to Ruby's open classes or C\#'s partial classes, Coral has a feature of open templates. This means that a single template (be it a class or a trait) can have its definition spread across several source files. 

An open template has a {\em leading template}, which is the template that specifies the base class -- a property that can't be changed once set, and any number of {\em auxiliary templates}, which have only the limitation of not being able to define the base class (and a primary constructor, including a parent constructor invocation). However, it is possible for the auxiliary templates to define additional traits applied or prepended to the template. 

Auxiliary templates do not need to be eager loaded. There are basically three major ways to make use of an auxiliary template:
\begin{itemize}
\item Eager loaded auxiliary template, using the construct ~\lstinline!include 'path/to/file'!. This way the auxiliary template is loaded along with the leading template.
\item Autoload (\sref{sec:autoloading}) of the auxiliary template. 
\item On-demand load of the auxiliary template via independent ~\lstinline!VM.load 'path/to/file'!, after the leading template is defined.  
\end{itemize}

To declare a template as an open template, the following annotations are available. All templates are implicitly open, so the annotations are only useful to prevent implicit inheriting from \code{Object}, if the intended leading template inherits from a different base class. 
\begin{lstlisting}
@{Open_Template :leading}
@{Open_Template :auxiliary}
\end{lstlisting}






\subsection{Autoloading}
\label{sec:autoloading}

Autoloading is a mechanism of putting code from different source files and source directories together in runtime. There are two kinds of autoloading.

\paragraph{Implicit autoloading}
This kind of autoloading is basically the expected layout of source files, source directories and terms inside of a directory. Given that a root directory represents a module sources root, each template definition is expected to appear in a file that directly appears in this directory, preferably with a name of the included template. If multiple templates appear in one source file, then the implicit autoloading uses the mechanism of template index to track location of these templates. However, if the name of the template is generated dynamically in runtime (i.e. not via template definition or a constant initialization), then it needs to be loaded using explicit autoloading. Also, if the source file is used as a script, every such term needs to be loaded using explicit autoloading, since the compiler does not know about anything that hasn't been yet loaded or otherwise defined and is not in the same source file. 

\paragraph{Explicit autoloading}
This kind of autoloading is basically a custom definition of the layout of source files, source directories and terms inside of a directory. Explicit autoloading happens every time a member is accessed in a template and it is not defined. Explicit autoloading is defined in means of using the \code{autoload} method, provided by the \code{Class} class, and therefore available inside of any template definition. The method has the following overloaded declarations: 
\begin{lstlisting}
type Autoloaded_Term is union of ( Symbol, Regexp )
end type
def autoload (term: Autoloaded_Term, 
              path: String): Unit
end def
def autoload (term: Autoloaded_Term := nil, 
              callback: (t: Autoloaded_Term) -> Boolean): Unit
end def
\end{lstlisting}
The first overloaded variant generates an autoloading record that will autoload the source file from the given path. The second overloaded variant expects a callback that will return a boolean indicating whether the term was successfully autoloaded or not, also having the actual autoloaded term as an optional argument -- if the argument is omitted, then the callback is registered for every autoloading attempt.

With explicit autoloading, the runtime is allowed to keep track of templates that make use of explicit autoloading to optimize member resolution. If an explicit autoloading is added in runtime, the version number of the template has to be updated to invalidate member caches. 







\subsection{Constructor Invocations}
\label{sec:constructor-invocations}

\syntax\begin{lstlisting}
Constr ::= Annot_Type {'(' [Exprs] ')'}
         | '(' ')'
\end{lstlisting}

Constructor invocations define the type, members and initial state of objects created by an instance creation expression, or of parts of an object's definition, which are inherited by a class or object definition. A constructor invocation is a function application ~\lstinline!$c$[$\targs$]@[$\dargs$][<$\uomargs$>]($\args_1$)$\ldots$($\args_n$)!~, where $c$ is a path to the superclass or an alias for the superclass, $\targs$ is a type argument list, $\dargs$ is an indexing argument list, $\uomargs$ is a units of measure argument list, $\args_1 \commadots \args_n$ are argument lists, and there is a constructor of that class which is applicable to the given arguments. 

A type argument list can be only given if the class $c$ takes type parameters. An indexing argument list can be only given if the class $c$ takes indexing parameters. A units of measure argument list can be only given if the class $c$ is a class aggregated with units of measure. If no explicit arguments are given, an empty list ~\lstinline!()!~ is implicitly supplied, unless an explicit primary constructor definition is given, calling explicitly a super-constructor -- in that case, the constructor invocation only defines the superclass, and the invocation itself is deferred to the explicit primary constructor. 

The superclass constructor is implicitly invoked before any code that the primary constructor defines, but not before early definitions are evaluated. 





\subsection{Metaclasses \& Eigenclasses}
\label{sec:metaclasses}
\label{sec:eigenclasses}

\paragraph{\em Metaclasses}
A {\em metaclass} is a class whose instances are classes. Just as an ordinary class defines the behavior and properties of its instances, a metaclass defines the behavior of its class. Classes are first-class citizens in Coral. 

Everything is an object in Coral. Every object has a class that defines the structure (i.e. the instance variables) and behavior of that object (i.e. the messages the object can receive and the way it responds to them). Together this implies that a class is an object and therefore a class needs to be an instance of a class (called metaclass). 

Class methods actually belong to the metaclass, just as instance methods actually belong to the class. All metaclasses are instances of only one class called \code{Metaclass}, which is a subclass of the class \code{Class}. 

In Coral, every class (except for the root class \code{Object}) has a superclass. The base superclass of all metaclasses is the class \code{Class}, which describes the general nature of classes. 

The superclass hierarchy for metaclasses parallels that for classes, except for the class \code{Object}. The following holds for the class \code{Object}:
\begin{lstlisting}[deletekeywords={class}]
Object.class = Class[Object]
Object.superclass = nil
\end{lstlisting}

Classes and metaclasses are ``born together''. Every \code{Metaclass} instance has a method \code{this_class}, which returns the conjoined class. 

\paragraph{\em Eigenclasses}
Coral further purifies the concept of metaclasses by introducing {\em eigenclasses}, borrowed from Ruby, but keeping the \code{Metaclass} known from Smalltalk-80. Every metaclass is an eigenclass, either to a class, to a terminal object, or to another eigenclass\footnote{Eigenclasses of eigenclasses (``higher-order'' eigenclasses) are supposed to be rarely needed, but are there for conceptual integrity, establishing infinite regress.}. 

\begin{table}[ht]
  \centering
  \caption{Of objects, classes \& eigenclasses}
  \renewcommand{\arraystretch}{1.7}
  \begin{tabular}{ | >{\centering}m{3.5cm} | >{\centering}m{3.5cm} | >{\centering\arraybackslash}m{6cm} | }
  	\hline
    Classes & Eigenclasses of classes & \multirow{2}{*}{Eigenclasses of eigenclasses} \\ \cline{1-2}
    Terminal objects & Eigenclasses of terminal objects & \\
    \hline
  \end{tabular}
\end{table}

Eigenclasses are manipulated indirectly through various syntax features of Coral, or directly using the \code{eigenclass} method. This method can possibly trigger creation of an eigenclass, if the receiver of the \code{eigenclass} message did not previously have its own (singleton) eigenclass (because it was a terminal object whose eigenclass was a regular class, or the reciever was an eigenclass itself). 

Another way to access an eigenclass is to use the \lstinline!class << obj; $\ldots$; end! construct. The block of code inside runs is evaluated in the scope of the eigenclass of \code{obj}. 

\paragraph{\em Metaclass Access}
Metaclasses of classes may be accessed using the following language construct. 

\syntax\begin{lstlisting}
Metaclass_Access ::= 'class' '<<' Metaclass_Obj semi 
                     [Exprs] 'end'
Metaclass_Obj    ::= Type | Path | 'self' | variable_id
\end{lstlisting}

\example The following code shows how metaclasses are nested in case of \code{Object} type. Don't try this at home though. 
\begin{lstlisting}
class << Object
  self = Metaclass[Object]
  class << self
    self = Metaclass[Metaclass[Object]]
    class << self
      self = Metaclass[Metaclass[Metaclass[Object]]]
    end
  end
end
\end{lstlisting}

\example The following code shows what \code{self} references when inside of a class definition, but outside of any defined methods. 
\begin{lstlisting}
class Object extends ()
  self = Class[Object]
  class << self
    self = Metaclass[Object]
  end
end
\end{lstlisting}

\example Direct access to the eigenclass of any object, here a class' eigenclass:
\begin{lstlisting}
class A
begin
  class << self
    def a_class_method
      "A.a_class_method"
    end def
  end
end class
\end{lstlisting}
Class \code{A} uses the \lstinline!class << obj; $\ldots$; end! construct to get direct access to the eigenclass. The keyword \code{self} inside the block is bound to the eigenclass object. 

\example Alternative direct access to the eigenclass of any object, here a class' eigenclass:
\begin{lstlisting}
class B
begin
  self.eigenclass do
    def a_class_method
      "B.a_class_method"
    end def
  end
end class
\end{lstlisting}
Class \code{B} uses the \code{eigenclass} method, which---given a block---evaluates the block in the scope of the eigenclass of \code{self}, which is bound to the class \code{B}. The keyword \code{self} inside the block is again bound directly to the eigenclass object. 

\example Indirect access to the eigenclass using a singleton method definition:
\begin{lstlisting}
class C
begin
  def self.a_class_method
    "C.a_class_method"
  end def
end class
\end{lstlisting}
Class \code{C} uses singleton method definition to add methods to the eigenclass of the class \code{C}. The keyword \code{self} is bound to the class object in the class-level block and in the new method as well, but the eigenclass is accessed only indirectly. 

\example Indirect access to the eigenclass using a class object definition:
\begin{lstlisting}
class D
begin
  object D
    def a_class_method
      "D.a_class_method"
    end def
  end object
end class
\end{lstlisting}
Class \code{D} uses the recommended approach, utilizing standard ways of adding methods to the eigenclass of the class \code{D}. Here, the eigenclass instance itself is not accessed directly.  

\example Alternative indirect access to the eigenclass using a class object definition:
\begin{lstlisting}
object E
  def a_class_method
    "E.a_class_method"
  end def
end object
\end{lstlisting}
Class \code{E} uses a similar recommended approach, utilizing standard ways of adding methods to the eigenclass of the class \code{E} and neither declaring nor defining anything for its own instances. Here, the eigenclass instance itself is not accessed directly. 





\subsection{Class Linearization}
\label{sec:class-linearization}

The classes reachable through transitive closure of the direct inheritance relation from a class $C$ are called the {\em base classes} of $C$. Because of traits, the inheritance relationship on base classes forms in general a directed acyclic graph. A linearization of this graph is defined as follows. 

\newcommand{\uright}{\;\vec +\;}
\newcommand{\lin}[1]{{\cal L}(#1)}

\begin{definition}
Let base classes of a class $C$ be the list of every superclass of $C$ with every trait that these classes include and/or prepend and every protocol that these classes implement. Let $C$ be a class with base classes ~\lstinline!$C_1$ with $C_2$ with $\ldots$ with $C_n$!. The {\em linearization} of $C$, $\lin C$ is defined as follows:
\bda{rcl}
\lin C &=& C\ , \ \lin{C_n} \uright \ldots \uright \lin{C_1}
\eda
Here $\uright$ denotes concatenation, where elements of the right operand replace identical elements of the left operand:
\bda{lcll}
\{a, A\} \uright B &=& a, (A \uright B)  &{\bf if}~a \not\in B \\
                 &=& A \uright B       &{\bf if}~a \in B
\eda
\end{definition}

\example Consider the following class definitions.\footnote{Here we say ``class'', but that term includes now traits as well.}
\begin{lstlisting}
class Abstract_Iterator extends Object; $\ldots$ end
trait Rich_Iterator extends Abstract_Iterator; $\ldots$ end
class String_Iterator extends Abstract_Iterator; $\ldots$ end
class Iterator extends String_Iterator with Rich_Iterator; $\ldots$ end
\end{lstlisting}
Then the linearization of class \code{Iterator} is
\begin{lstlisting}
{ Iterator, Rich_Iterator, String_Iterator, Abstract_Iterator, 
  Object }
\end{lstlisting}

Note that the linearization of a class refines the inheritance relation: if $C$ is a subclass of $D$, then $C$ precedes $D$ in any linearization where both $C$ and $D$ occur. Also note that whether a trait is included or prepended is irrelevant to linearization, but essential to function applications (\sref{sec:function-applications}).





\subsection{Inheritance Trees \& Include Classes}
\label{sec:inheritance-trees}
\label{sec:include-classes}

\paragraph{\em Include classes}
A mechanism that allows arbitrary including and prepending of trait into classes and inheritance binary trees\footnote{Yes, trees, not chains: prepended traits make the inheritance game stronger by forking the inheritance chain at each class with prepended traits, forming a shape similar to a rake.} uses a transparent structure called {\em include class}. Include classes are always defined indirectly.

Every class has a link to its superclass. In fact, the link is made up of an include class structure, which itself holds an actual link to the superclass. That superclass has its own link to its superclass and this chain goes forever until the \code{Object} class is encountered, which has no superclass. 

\paragraph{\em Included traits}
When a trait $M$ is included into a class, a new include class $Im_i$ is inserted between the target class and the include class $Is$ that holds a link to its superclass (or to a previously included trait $Im_{i+1}$). This include class $Im_i$ then holds a link to the included trait. Every class that includes the trait $M$ is available via the \code{included_in} method of $M$. 

If a trait $M$ is already (included in or prepended to)\footnote{This is important since both included and prepended traits act like superclasses to every subclass.} any of the superclasses, then it is not included again. Included traits act like superclasses of the class they are included in, and they {\em overlay} the superclasses. 

\example A sample trait schema:
\begin{lstlisting}
class C extends D with Some_Trait
end

C $\rightarrow$ [Some_Trait] $\rightarrow$ [D]
D $\rightarrow$ [Object]
\end{lstlisting}
Include classes are depicted by the brackets, with their link value inside. Note that include classes only know their super-type (depicted by the arrow ``$\rightarrow$'') and their link value (inside brackets). 

\paragraph{\em Prepended traits}
When a trait $M$ is prepended to a class, a new include class $Im_i$ is inserted between the target class and its last prepended trait, if any. Prepended traits are stored in a secondary inheritance chain just for prepended traits, forming an inheritance tree. Every class that has $M$ prepended is available via the \code{prepended_in} method of $M$. The effect of prepending a trait in a class or a trait is named {\em overlaying}. 

If a trait $M$ is already prepended to any of the superclasses, it has to be prepended again, since the already prepended traits of superclasses are in super-position to the class or trait that gets $M$ prepended. Prepended traits of superclasses do not {\em overlay} child classes. Prepended traits are inserted into the inheritance tree more like subclasses than superclasses. 

\paragraph{\em Nested includes}
% TBD: add the algorithm like with nested prepends, but this one is simpler
When a trait $M$ itself includes one or more traits $M_1 \commadots M_n$, then these included traits are inserted between the included trait $M$ and the superclass, unless they are already respectively included by any of the superclasses. If $M$ with included $M_1 \commadots M_n$ is prepended to $C$, then $M_1 \commadots M_n$ are inserted before the superclass of $C$, if not already included in any of the superclasses. It is an error if nested includes form a dependency cycle: any {\em auto-included} trait must not require to include a trait that triggered the auto-include. The order in which traits are included in another trait may change when included in a class, i.e. if the class includes two traits $A$ and $B$ that themselves include the same two traits $D$ and $E$ in reverse order ($A$ includes $D$, then $E$, but $B$ includes $E$, then $D$): the order is then defined by the first trait that included the two auto-included traits and subsequently included traits can not change this order in any way. 

\example Take the following trait and class definitions, where $S$ is the superclass of the class $C$:
\begin{lstlisting}
trait D end
trait E end

trait A extends D with E; end
trait B extends E with D; end

class C extends S with A with B; end
\end{lstlisting}
Then traits are auto-included in the following order:
\begin{itemize}
\item
\lstinline!C $\rightarrow$ [S]! \\
First, the superclass is added. 

\item
\lstinline!C $\rightarrow$ [A] $\rightarrow$ [S]! \\
Then, trait $A$ is included, unless already included in $S$. 

\item
\lstinline!C $\rightarrow$ [A] $\rightarrow$ [E] $\rightarrow$ [S]! \\
Including of trait $A$ triggers auto-include of traits included in $A$. Start with the first one in chain of $A$: $E$. 

\item
\lstinline!C $\rightarrow$ [A] $\rightarrow$ [E] $\rightarrow$ [D] $\rightarrow$ [S]! \\
Then, $A$ has $D$ in its chain. 

\item
\lstinline!C $\rightarrow$ [B] $\rightarrow$ [A] $\rightarrow$ [E] $\rightarrow$ [D] $\rightarrow$ [S]! \\
Finally include $B$. $B$ triggers auto-include, but both of its included traits are already included in the chain, so nothing more happens. 
\end{itemize}
Note that the order of $E$ and $D$ is reversed, since later includes move the trait closer to the including class or trait, and therefore \code{super} calls go through traits that were included before. Also, if $B$ was included sooner than $A$, then $D$ and $E$ would appear in reverse order in the chain. 

\paragraph{\em Nested prepends}
When a trait $M$ itself prepends one or more traits $M_1 \commadots M_n$, then nothing happens to the class or the trait that $M$ is included in. If $M$ is prepended to $C$, then every trait $M_1 \commadots M_n$ prepended to $M$ is automatically prepended to $C$ in this way:
\begin{enumerate}
\item
Establish a list of traits that triggered auto-prepend, named here $tp$. This list is in ideal case empty, so it's actually ok for the runtime to wait with its creation until needed and only increase its size in very small steps. 

\item
Establish a list of traits that are scheduled to be auto-prepended, named here $sp$. This list is in ideal case empty, again. 

\item
There is a {\em prepend chain} in the class that prepends $M$. If no trait was prepended so far, create it. The chain's head is the element that is the farthest from the class $C$, the chain's tail is right before the class $C$. Traits closer to this chain's head are searched for method overlays sooner in runtime than traits closer to the tail (and the class respectively). 

\item
Insert $M$ at the chain's head, unless $M$ already is in the chain. If it is, then halt. 

\item 
If $M$ has itself prepended traits, insert $M$ into $tp$ (triggered prepend). 

\item
For traits $M_1 \commadots M_n$ that are prepended in $M$, test if each $M_i$ already appears in the chain. If it does, move $M$ up the chain towards the chain's tail, right until $M$ is closer to the chain's tail than $M_i$. If it does not, add $M_i$ to $sp$, unless $M_i$ is in $tp$. If it is, then it is an error\footnote{Trait cycle dependency detected.}. 

\item
If $M$ has included traits, include them in $C$ in the already described way now. 

\item
If $sp$ is not empty, then for each $M_i$ in $sp$, remove $M_i$ from $sp$ and recursively apply steps starting with 4 on it. Keep both $sp$ and $tp$ shared for recursive calls. If $M_i$ moves closer to the chain's tail than $M$ or any other trait prepended in prepending of the original $M$\footnote{This can be achieved by having a third list of traits that were prepended.}, it is an error\footnote{Trait composition design flaw detected.}. 
\end{enumerate}

\paragraph{\em Traits \& Metaclasses}
Since traits may contain ``class'' methods as well as instance methods, all the operations with include classes are mirrored on the respective metaclasses.\footnote{This makes Coral in no need of constructs like \lstinline[language=Ruby]!module ClassMethods!, known from Ruby.}





\subsection{Class Members}
\label{sec:class-members}

A class $C$ defined by class definition can define members in its class-level block, can inherit members from all parent classes\footnote{Including an interface and any number of protocols.} and included traits, and can have its members overlayed by all prepended traits. 

Member definitions fall basically into two categories: {\em concrete} \& {\em abstract}. Members of the class $C$ are either {\em directly defined}, {\em overlayed} or {\em inherited}. 

Concrete members are those that have a definition, abstract members are those that are only declared without any subsequent or preceding definition.\footnote{There is a special case, when a protocol introduces an abstract member, but the class that implements this protocol already inherited or directly defined the matching member.}

Members are instance variables, class instance variables, types, methods \& messages. 





\subsection{Overriding}
\label{sec:overriding}

A member $M$ of a class $C$ that matches a member $M'$ of a base class of $C$ is said to {\em override} that member. In this case the binding of the overriding member $M$ must conform (\sref{sec:conformance}) to the binding of the overridden member $M'$. Furthermore, the following restrictions on modifiers apply to $M$ and $M'$: 
\begin{itemize}
\item 
$M'$ must not be labeled \lstinline!final!. 

\item 
$M$ must not be \lstinline!private!. 

\item 
If $M$ is labeled \lstinline!private[$C$]! for some enclosing class or module $C$, then $M'$ must be labeled \lstinline!private[$C'$]!, where $C'$ equals $C$ or $C$ is contained in $C'$. % TBD: review the last few words

\item 
If $M$ is labeled \lstinline!protected!, then $M'$ must also be labeled \lstinline!protected!. 

\item 
If $M'$ is labeled \lstinline!protected!, then $M'$ must also be labeled \lstinline!protected! or \lstinline!public!. 

\item
If $M'$ is not an abstract member, then $M$ should be labeled \lstinline!override! or annotated \lstinline!@{Override}!. Furthermore, one of the possibilities must hold:
\begin{itemize}
\item either $M$ is defined in a subclass of the class where $M'$ is defined,
\item or both $M$ and $M'$ override a third member $M''$, which is defined in a base class of both the classes containing $M$ and $M'$.
\end{itemize}

\item 
If $M'$ is labeled \lstinline!private!, then $M'$ must be labeled \lstinline!private!, \lstinline!protected! or \lstinline!public!. 

\item
If $M'$ is incomplete (\sref{sec:modifiers}) in $C$, then $M$ should be labeled \lstinline!abstract override!. 

\item
If $M$ and $M'$ are both concrete value definitions, then either none of them is marked \lstinline!lazy!, or both must be marked \lstinline!lazy!. 
\end{itemize}

To generalize the conditions, the modifier of $M$ must be the same or less restrictive than the modifier of $M'$. 

An overriding method, unlike in Scala, does not inherit any default arguments from the definition in the superclass, but, as a convenience, if the default argument is specified as ~`\lstinline!_!', then it gets inherited. 





\subsection{Inheritance Closure}
\label{sec:inheritance-closure}

\newcommand{\inheritclosure}{{\cal S}}

Let $C$ be a class type. The {\em inheritance closure} of $C$ is the smallest set $\inheritclosure$ of types such that
\begin{itemize}
\item If $T$ is in $\inheritclosure$, then every type $T'$ which forms syntactically a part of $T$ is also in $\inheritclosure$. 
\item If $T$ is a class type in $\inheritclosure$, then all parents of $T$ (\sref{sec:templates}) are also in $\inheritclosure$. 
\end{itemize}
It is an error if the inheritance closure of a class type consists of an infinite number of types. 






\subsection{Early Definitions}
\label{sec:early-defs}

\syntax\begin{lstlisting}
Early_Defs ::= '{' [Early_Def {semi Early_Def}] '}' 
               'with'
Early_Def  ::= {Annotation} {Modifier} Pat_Var_Def
\end{lstlisting}

A template may start with an {\em early definition} clause, which serves to define certain field values before the supertype constructor is called. In a template
\begin{lstlisting}
{
  val $p_1$: $T_1$ := $e_1$
  $\ldots$
  val $p_n$: $T_n$ := $e_n$
} with $sc$ with $mt_1$ with $\ldots$ with $mt_n$
\end{lstlisting}
The initial pattern definitions of $p_1 \commadots p_n$ are called {\em early definitions}. They define fields which form part of the template. Every early definition must define at least one field. 

Any reference to \code{self} in the right-hand side of an early definition refers to the identity of \code{self} just outside the template, not inside of it. As a consequence, it is impossible for any early definition to refer to the object being constructed by the template, or refer to any of its fields, except for any other preceding early definition in the same section. 







\section{Modifiers}
\label{sec:modifiers}

\syntax\begin{lstlisting}
Modifier         ::= Local_Modifier
                   | Access_Modifier
                   | 'override'
Local_Modifier   ::= 'implicit'
                   | 'lazy'
                   | 'final'
                   | 'sealed'
                   | 'abstract'
Access_Modifier  ::= 'public'
                   | ('protected' | 'private') [Access_Qualifier]
Access_Qualifier ::= '[' (constant_id | 'self') ']'
\end{lstlisting}

Access modifiers may appear in two forms:

\paragraph{\em Accessibility flag modifier}
Such a modifier appears in a template (\sref{sec:templates}) or a module definition (\sref{sec:module-definitions}) alone on a single line. All subsequent members in the same class-level block than have accessibility of this modifier applied to them, if allowed to (does not apply to destructors). Only access modifiers can be used this way. 

\paragraph{\em Directly applied modifier}
Such a modifier appears on a line preceding a member to which the modifier is solely applied, or a list of arguments with symbols that the modifier will be applied to. A directly applied modifier expression has a return type of \code{Symbol}, so that it may be used as a regular function and chained. 

\example An example of an accessibility flag modifier:
\begin{lstlisting}
class C
begin
  public
    def hello; end
  private
    def private_hello; end
end class
\end{lstlisting}

\example An example of directly applied modifier:
\begin{lstlisting}
class C
begin
  def hello; end
  def private_hello; end
  def salute; end
  public :hello
  private :private_hello, :salute
  protected def goodbye; end
end class
\end{lstlisting}

By default\footnote{That is, without any explicit modifier being applied.}, the \code{public} access modifier affects every member of the class type, except for instance variables and class instance variables, which are object-private (\lstinline!private[self]!). 

Modifiers affect the accessibility and usage of the identifiers bound by them. If several modifiers are given, their order does not matter, but the same modifier may not occur more than once and combinations of \code{public}, \code{protected} \& \code{private} are not allowed (using them as accessibility flag modifiers overwrites the previous accessibility, not combines them). If a member declaration has a modifier applied to it, then the subsequent member definition has the same modifier already applied to it as well, without the need to explicitly state that. It is an error if the modifier applied to the member definition would contradict the modifier applied to the member declaration. 

Accessibility modifiers can not be applied to instance variables and class instance variables (both declarations and definitions). These are by default {\em instance-private}. This is a sort of relaxation in access restriction, say, every method that is at least {\em public} and at most {\em object-private} restricted, and that has the instance as a receiver, can access the instance variable or the class instance variable. Any other method that does not have the particular instance as the receiver, does not have any access to the instance variable or the class instance variable, even if the method is a method of the same class as the particular instance. 

The rules governing the validity and meaning of a modifier are as follows: 
\begin{itemize}
\item
The \code{private} access modifier can be used with any declaration or definition in a class. Such members can be accessed only from within the directly enclosing class, the class object (\sref{sec:object-definitions}) and any member of the directly enclosing class, including inner classes. They are not inherited by subclasses and they may not override definitions in parent classes. 

The modifier may be {\em qualified} with an identifier $C$ (e.g. \lstinline!private[$C$]!) that must denote a class or a module enclosing the declaration or definition. Members labeled with such a modifier are accessible respectively only from code inside the module $C$ or only from code inside the class $C$ and the class object $C$ (\sref{sec:object-definitions}). 

A different form of qualification is \lstinline!private[self]!. A member $M$ marked with this modifier is called {\em object-private}; it can be accessed only from within the object in which it is defined. That is, a selection \lstinline!$p$.$M$! is only legal if the prefix ends with \code{this} or \code{self} and starts with $O$ for some class $O$ enclosing the reference. . Moreover, the restrictions for unqualified \code{private} apply as well. 

Members marked \code{private} without any qualifier are called {\em class-private}. A member {\em is private} if it is either class-private or object-private, but not if it is marked \lstinline!private[$C$]!, where $C$ is an identifier, in the latter case the member is called {\em qualified private}. 

Class-private and object-private members must not be \code{abstract}, since there is no way to provide a concrete implementation for them, as private members are not inherited. Moreover, modifiers \code{protected} \& \code{public} can not be applied to them (that would be a contradiction\footnote{E.g., a member can not be public and private at the same time.}), and the modifier \code{override} can not be applied to them as well\footnote{Otherwise, if a private member could override an inherited member, that would mean there is an inherited member that could be overridden, but private members can not override anything: only protected and public members can be overridden. If a member was overriding an inherited member, the parent class would {\em lose access} to it.}. 

\item
The \code{protected} access modifier can be used with any declaration or definition in a class. Protected members of a class can be accessed from within: 
\begin{itemize}
\item the defining class
\item all classes that have the defining class as a base class
\item all class objects of any of those classes
\end{itemize}

A \code{protected} access modifier can be qualified with an identifier $C$ (e.g. \lstinline!protected[$C$]!) that must denote a class or module enclosing the definition. Members labeled with such a modifier are {\em also}\footnote{In addition to unqualified \code{protected} access.} accessible respectively from all code inside the module $C$ or from all code inside the class $C$ and its class object $C$ (\sref{sec:object-definitions}). 

A protected identifier $x$ can be used as a member name in a selection \lstinline!$r$.$x$! only if one of the following applies: 
\begin{itemize}
\item The access is within the class defining the member, or, if a qualification $C$ is given, inside the module $C$, the class $C$ or the class object $C$, or
\item $r$ ends with one of the keywords \code{this}, \code{self} or \code{super}, or
\item $r$'s type conforms to a type-instance of the class which has the access to $x$. 
\end{itemize}

A different form of qualification is \lstinline!protected[self]!. A member $M$ marked with this modifier can be accessed only from within the object in which it is defined, including methods from inherited scope. That is, a selection \lstinline!$p$.$M$! is only legal if the prefix ends with \code{this}, \code{self} or \code{super} and starts with $O$ for some class $O$ enclosing the reference. Moreover, the restrictions for unqualified \code{protected} apply. 

\item
The \code{override} modifier applies to class member definitions and declarations. It is never mandatory, unlike in Scala or C\# (in further contrast with C\#, every method in Coral is virtual, so Coral has no need for a keyword ``\code{virtual}''). On the other hand, when the modifier is used, it is mandatory for the superclass to define or declare at least one matching member (either concrete or abstract). 

\item
The \code{override} modifier has an additional significance when combined with the \code{abstract} local modifier. That modifier combination is only allowed for members of traits. 

We call a member $M$ of a class or trait {\em incomplete} if it is either abstract (i.e. defined by a declaration), or it is labeled \code{abstract} and \code{override} and every member overridden by $M$ is again incomplete. 

The \code{abstract override} modifier combination does not influence the concept whether a member is concrete or abstract. A member is {\em abstract} if only a declaration is given for it; it is {\em concrete} if a full definition is given. This behavior can be turned off only in tests, if needed, and is implicitly turned on. 

The \code{abstract override} modifier combination can be thus used with a full definition in a trait and yet affect the class or trait with which it is used, so that a member access to member \code{abstract override $M$}, such as \lstinline!super.$M$!, is legal. But, the \code{abstract override} modifier combination does not need to be applied to a definition, a declaration is good enough for it. 

Additionally, an annotation \lstinline!@[Override]! exists for class members that triggers only warnings in case the member has no inherited member to override, but does not prevent the class from being created. Thus, the annotation only signals an intention, the keyword modifier signals a requirement. 

\item
The \code{abstract} local modifier is used in class declarations. It is never mandatory for classes with incomplete members or for declarations and definitions. It is implied (and therefore redundant) for traits. Abstract classes can not be instantiated (an exception is raised if tried to do so), unless provided with traits and/or a refinement which override all incomplete members of the class. Only abstract classes and (all) traits can have abstract term members. This behaviour can be turned off only in tests, if needed, and is implicitly turned on. 

The \code{abstract} local modifier can be used with conjunction with \code{override} modifier for class member definitions. 

Additionally, an annotation \lstinline!@[Abstract]! exists for classes and class members that triggers only warnings in case of instantiation, but does not prevent the instantiation. Thus, the annotation only signals an intention, the keyword modifier signals a requirement. 

\item
The \code{final} local modifier applies to class members definitions and to class definitions. Every \code{final} class member can not be overridden in subclasses. Every \code{final} class can not be inherited by a class or trait. Members of final classes are implicitly also final. Note that \code{final} may not be applied to incomplete members, and can not be combined in one modifier list with the \code{sealed} local modifier. 

Additionally, an annotation \lstinline!@[Final]! exists for classes and class members that triggers only warnings in case of inheriting or overriding respectively, but does not prevent the inheritance or overriding respectively. Thus, the annotation only signals an intention, the keyword modifier signals a requirement. 

\item
The \code{sealed} local modifier applies to class definitions. A \code{sealed} class can not be directly inherited, except if the inheriting class or trait is defined in the same source file as the inherited sealed class. However, subclasses of a sealed class have no restriction in inheritance, unless they are final or sealed again. 

Additionally, an annotation \lstinline!@[Sealed]! exists for classes and class members that triggers only warnings in case of inheriting outside the same source file, but does not prevent the inheritance. Thus, the annotation only signals an intention, the keyword modifier signals a requirement. 

\item
The \code{lazy} local modifier applies to value definitions. A \code{lazy} value is initialized the first time it is accessed (which might eventually never happen). Attempting to access a lazy value during its initialization is a blocking invocation until the value is initialized of failed to initialize. If an exception is thrown during initialization, the value is considered uninitialized and the initialization is restarted on later access, re-evaluating its right hand side. 

\example The following code illustrates the use of qualified and unqualified private: 
\begin{lstlisting}
module Outer_Mod.Inner_Mod
  class Outer
  begin
    class Inner
    begin
      private[self] def e() end def
      private def f() end def
      private[Outer] def g() end def
      private[Inner_Mod] def h() end def
      private[Outer_Mod] def i() end def
    end class
  end class
end module
\end{lstlisting}
Here, accesses to the method \code{e} can appear anywhere within the instance of \code{Inner}, provided that the instance is also the receiver at the same time. Accesses to the method \code{f} can appear anywhere within the class \code{Inner}, including all receivers of the same class. Accesses to the method \code{g} can appear anywhere within the class \code{Outer}, but not outside of it. Accesses to the method \code{h} can appear anywhere within the module \code{Outer_Mod.Inner_Mod}, but not outside of it, similar to package-private methods in Java. Finally, accesses to the method \code{h} can appear anywhere within the module \code{Outer_Mod}, including modules and classes contained in it, but not outside of these.

\end{itemize}

A rule for access modifiers in scope of overriding: Any overriding member may be defined with the same access modifier, or with a less restrictive access modifier. No overriding member can have more restrictive access modifier, since the parent class would {\em lose access} to the member, and that is unacceptable. 
\begin{itemize}
\item Modifier \code{public} is less restrictive than any other access modifier. 
\item Qualified modifier \code{protected} is less restrictive than an unqualified \code{protected}, only if the class that the modifier is qualified with is among base classes of the original class -- the original class must not lose access. 
\item Qualified modifier \code{protected} is less restrictive than object-protected, only if the class that the modifier is qualified with is among base classes of the original class -- the original class must not lose access. 
\item While \code{protected} is certainly less restrictive than \code{private}, private members are not inherited and thus can not be overridden. 
\item While qualified \code{private} is certainly less restrictive than unqualified \code{private}, private members are not inherited and thus can not be overridden. 
\end{itemize}
The relaxations of access modifiers for overriding members are then available as follows: 
\begin{itemize}
\item \lstinline!protected[self] $\rightarrow$ { protected, protected[$C$], public }!
\item \lstinline!protected $\rightarrow$ { protected[$C$], public }!
\item \lstinline!protected[$C$] $\rightarrow$ { protected[$D$], public }!

This is only for the case where $C$ is accessible from within $D$. 
\item \lstinline!protected[$C$] $\rightarrow$ { public }!
\item \lstinline!public $\rightarrow$ { public }!

This is just for the sake of completeness, since change from public to public is not much of a relaxation. 
\end{itemize}






\section{Class Definitions}
\label{sec:class-definitions}

\syntax\begin{lstlisting}
Tmpl_Def            ::= 'class' Class_Def
Class_Def           ::= constant_id [Type_Param_Clause] 
                        [Dep_Params] [UoM_Params]
                        [Class_Param_Clauses] Class_Tmpl_Env
Class_Param_Clauses ::= {Annotation} [Access_Modifier] 
                        {Class_Param_Clause}
                        ['(' 'implicit' Class_Params ')']
Class_Param_Clause  ::= '(' [Class_Params] ')'
Class_Params        ::= Class_Param {',' Class_Param}
Class_Param         ::= {Annotation} [{Modifier} ('val' | 'var')]
                        variable_id [':' Param_Type] [':=' Expr]
Class_Tmpl_Env      ::= 'extends' [Early_Defs] Class_Parents
                        semi [Template_Body] 'end' ['class']
                      | ['extends' [Early_Defs]] 
                        '{' [Template_Body] '}'
                      | ['begin' [Template_Body]] 'end' ['class']
\end{lstlisting}

A class definition defines the type signature, behavior and initial state of a class of objects (the instances of the defined class) and of the class object, which is the class instance itself, with behavior defined in its metaclass (\sref{sec:metaclasses}). 

The most general form of a class definition is
\begin{lstlisting}
class $c$ [$\tps$] @[$\dps$] [<$\uomps$>] 
  $\as$ $m$($\ps_1$)$\ldots$($\ps_n$)
  extends $t$
\end{lstlisting}
for $n \geq 0$. 

Here, 
\begin{itemize}
\item[]
$c$ is the name of the class to be defined. 

\item[]
$\tps$ is a non-empty list of type parameters of the class being defined. The scope of a type parameter is the whole class definition including the type parameter section itself. It is an error to define two type parameters with the same name. The type parameter section \lstinline![$\tps$]! may be omitted. A class with a type parameter section is called {\em polymorphic}, a class without a type parameter section is called otherwise {\em monomorphic}. Type arguments are reified in Coral, i.e. type arguments are preserved in runtime\footnote{Unlike in Java or Scala, which both perform type erasure.}, generating a new concrete subtype of the original generic class. This ensures type safety in a dynamic environment of Coral in runtime. 

\item[]
$\dps$ is a non-empty list of indexing parameters for dependent types (\sref{sec:dependent-types-decl}). The indexing parameter section \lstinline!@[$\dps$]! may be omitted. A class with an indexing parameter section is called {\em indexed}. Indexing arguments are reified in Coral, i.e. indexing arguments are preserved in runtime. 

\item[]
$\uomps$ is a non-empty list of unit of measure parameters for aggregated types (\sref{sec:units-of-measure}). The unit of measure parameter section \lstinline![<$\uomps$>]! may be omitted. A class with a unit of measure parameter section is called {\em aggregated with units of measure}. Units of measure arguments are reified in Coral, i.e. units of measure arguments are preserved in runtime. 

\item[]
$\as$ is a possibly empty sequence of annotations (\sref{sec:annotations}). If any annotations are given at this point, they apply to the primary constructor of the class. 

\item[]
$m$ is an access modifier (\sref{sec:modifiers}), such as \code{private} or \code{protected} (\code{public} is implied otherwise), possibly with a qualification. If such an access modifier is given, it applies to the primary constructor of the class. 

\item[]
$(\ps_1)\ldots(\ps_n)$ are formal value parameter clauses for the {\em primary constructor} of the class. The scope of a formal value parameter includes all subsequent parameter sections and the template $t$. However, a formal value parameter may not form part of the types of any of the parent classes or members of the class template $t$ -- only parameters from $\tps$ may form part of the types of any of the parent classes or members of the class template $t$. It is illegal to define two formal value parameters with the same name. If no formal parameter sections are given, an empty parameter section \lstinline!()! is implied. 

\item[]
If a formal parameter declaration ~\lstinline!$x$: $T$!~ is preceded by a \code{val} or \code{var} keyword, an accessor (getter) definition (\sref{sec:value-dcl-def}) for this parameter is implicitly added to the class. The getter introduces a value member $x$ of class $c$ that is defined as an alias of the parameter. Moreover, if the introducing keyword is \code{var}, a setter accessor ~\lstinline!$x$_=($e$)!~ is also implicitly added to the class. The formal parameter declaration may contain modifiers, which then carry over to the accessor definition(s). A formal parameter prefixed by \code{val} or \code{var} may not at the same time be a call-by-name parameter (\sref{sec:by-name-parameters}). 

\item[]
If a formal value parameter is a part of the definition of a property (a property getter and/or a property value), then these accessors are not implicitly added, as the arguments may be traced into the properties. The same applies to instance value definitions that have a formal value parameter forming a part of it. In any case, every formal value parameter is implicitly added as an instance value definition of  a \code{val} or \code{var} type respectively. 

\item[]
$t$ is a template (\sref{sec:templates}) of the form
\begin{lstlisting}
$sc$ with $mt_1$ with $\ldots$ with $mt_n$ { $\stats$ }
\end{lstlisting}
for $(n \geq 0)$, which defines the base classes, behavior and initial state of objects of the class. The extends clause ~\lstinline!extends $sc$ with $mt_1$ with $\ldots$ with $mt_n$!~ can be omitted, in which case ~\lstinline!extends Object!~ is implied. The only class that defines $sc$ as ~\lstinline!()!~ is \code{Object} (meaning that it has no superclass) and it is an error if any other class attempts to do the same. 

% TBD: add explicit primary `constructor (_)`
\end{itemize}

This class definition defines a type ~\lstinline!$c$[$\tps$]@[$\dps$][<$\uomps$>]!~ and a primary constructor, which, when applied to arguments conforming to types $\ps$, initializes instances of type ~\lstinline!$c$[$\tps$]@[$\dps$][<$\uomps$>]!~ by evaluating the primary constructor parts defined in the template $t$. 

\example The following example illustrates \code{val} and \code{var} parameters of a class \code{C}: 
\begin{lstlisting}
class C (x: Integer, val y: String, var z: List[String]) end
val c := C.new(1, "abc", List[String].new)
c.z := c.y ~> c.z
\end{lstlisting}

\example The following class can be created only from its class object. 
\begin{lstlisting}
class Sensitive private () {
  $\ldots$
}
object Sensitive {
  def make_sensitive (credentials: Certificate): Sensitive := {
    if credentials.admin?
      Sensitive.new
    else 
      raise SecurityViolationException
    end
  }
}
\end{lstlisting}






\subsection{Constructor \& Destructor Definitions}
\label{sec:constructor-destructor-def}

\paragraph{\em Primary constructor}
The primary constructor is a special function, more special in its syntax than any other function in Coral. Its definition can spread across three syntactically different places inside of a class definition: formal value parameters, explicit field declarations, explicit primary constructor body. Primary constructor without explicitly defined parameters is equivalent to the default constructor. 

\paragraph{\em Primary constructor parameters}
These are described as a part of class definitions (\sref{sec:class-definitions}). Technically, a primary constructor is happy being left with nothing but the parameter definitions, since these are automatically mapped to instance values\footnote{Making this behavior overrideable may be discussed, but it might interfere with case classes.} and also implicitly adds accessor methods to the class with appropriate visibility, defined explicitly by accessor modifiers (\sref{sec:modifiers}) or implicitly as \code{public}. 

\paragraph{\em Explicit primary constructor fields}
These are instance value definitions inside the class template (\sref{sec:templates}) that use the formal value parameters either with or without any modification. Formal value parameter used without any modification is equivalent to the expression defining the value of an instance value being only the parameter itself. If the parameter is used without modification, it becomes an alias to the instance value implicitly defined by the primary constructor parameter. As the explicit field can be expected to be accessed more often than the original parameter, a Coral VM implementation may opt in to make the implicit instance value being the alias, instead of the explicit field. 
\example An example of an explicit primary constructor field. 
\begin{lstlisting}
class C (val y: String) {
  val @x := y                // without modification
  val @z := y + "_modified"  // with modification
}
\end{lstlisting}

\paragraph{\em Explicit primary constructor body}
If a primary constructor should do something more than simply map parameters to instance values, then its explicit body comes in. It may co-exist with explicit primary constructor fields, which are then executed right after a call to the super-constructor (either in implicit position, or an explicit one). 
\syntax\begin{lstlisting}
Def             ::= PCtor_Def
PCtor_Def       ::= 'constructor' PCtor_Fun_Def
PCtor_Fun_Def   ::= '(' '_' ')' (':=' Constr_Expr | Constr_Block)
Constr_Expr     ::= Self_Invocation
                  | Constr_Block2
Self_Invocation ::= 'self' Argument_Exprs {Argument_Exprs}
                  | Sup_Invocation
Sup_Invocation  ::= 'super' [Argument_Exprs {Argument_Exprs}]
Constr_Block    ::= Constr_Block1 | Constr_Block2
Constr_Block1   ::= [semi Constr_Block3] 'end' ['constructor']
Constr_Block2   ::= '{' [Constr_Block3] '}'
Constr_Block3   ::= [[Block_Stat {semi Block_Stat} semi] 
                    Self_Invocation semi] 
                    Block_Stat {semi Block_Stat}
                  | Self_Invocation
\end{lstlisting}

\paragraph{Auxiliary constructors}
Besides the primary constructor, a class may define additional constructors with different parameter sections, that form together with the primary constructor an overloaded constructor definition. Every auxiliary constructor is constrained in means that it has to either invoke another constructor defined before itself, or any superclass constructor. Therefore classes in Coral have multiple entry point, but with great power comes great responsibility: user must ensure that every constructor path defines all necessary members. It is an error if a constructor invocation leads to an instance with abstract members. If a constructor does not explicitly invoke another constructor, an invocation of the implicit constructor is inserted implicitly as the first invocation in the constructor. 

\syntax\begin{lstlisting}
Ctor_Def     ::= 'constructor' Ctor_Fun_Def
Ctor_Fun_Def ::= [Param_Clauses] (':=' Constr_Expr | Constr_Block)

Dtor_Def     ::= 'destructor' Dtor_Fun_Def
Dtor_Fun_Def ::= (':=' Dtor_Expr | Dtor_Block)
Dtor_Expr    ::= Sup_Invocation
               | Dtor_Block2
Dtor_Block   ::= Dtor_Block1 | Dtor_Block2
Dtor_Block1  ::= [semi Dtor_Block3] 'end' ['destructor']
Dtor_Block2  ::= '{' [Dtor_Block3] '}'
Dtor_Block3  ::= [[Block_Stat {semi Block_Stat} semi] 
                 Sup_Invocation semi] 
                 Block_Stat {semi Block_Stat}
               | Sup_Invocation
\end{lstlisting}

\paragraph{\em Default constructor}
A default constructor of a class is the explicit parameterless constructor. This differs from Java or C\#. The default root constructor of \code{Object} carries the modifier \code{public} (\sref{sec:modifiers}), and therefore to explicitly disallow direct object creating, custom constructors have to be explicitly more restrictive than \code{public}. 

\paragraph{\em Implicit constructor}
An implicit constructor is an automatically generated bridge constructor to the parameterless default constructor. This is what Java and C\# call ``default constructor''. An implicit constructor ``does nothing'' but invokes the super-constructor and initializes all members specific to the constructed object to their default values (either implicit one, which is \code{nil}, or explicit ones used in their definitions). 

\paragraph{\em Convenience constructor}
A convenience constructor is any other constructor than the parameterless default constructor, including the primary constructor, if it has parameters. 

\paragraph{\em Accessibility of constructors}
Constructors may have modified accessibility, so that only certain functions can invoke them indirectly. The accessibility is then transitioned from the calling context. 

\example An example of a convenience constructor of class $C$.
\begin{lstlisting}
class $C$
  constructor (param)
    // super is invoked implicitly here
    val @resource := param
  end constructor
end class
\end{lstlisting}

\example An example of a pair of constructors of class $C$. 
\begin{lstlisting}
class $C$
  constructor := self(42)
  constructor (param)
    // super is invoked implicitly here
    val @resource := param
  end constructor
end class
\end{lstlisting}

\paragraph{\em Explicit destructor}
An explicit destructor does not have any accessibility. The super-destructor is invoked implicitly at the end of its execution, unless explicitly invoked earlier. Destructors are parameterless and have a further requirement that they can not increment the reference count of the object being destructed -- doing so could result in zombie objects. 

\paragraph{\em Implicit destructor}
An implicit destructor is an automatically generated bridge destructor to the parameterless super-destructor. An implicit destructor ``does nothing'' but release all members specific to the destructed object and invoke super-destructor afterwards. The destructor of \code{Object} releases every remaining member of the destructed object. A class can only have a single destructor, either an explicit or an implicit one. 

\paragraph{\em Accessibility of destructors}
Destructors, unlike constructors, can not have any accessibility modifiers. They ignore the current accessibility flag of their class-block and trigger a warning if a modifier is used directly with the destructor. Destructors may be invoked independently on the context in which the object is destructed. 

\example An example of an explicit destructor of class $C$. 
\begin{lstlisting}
class $C$
  destructor
    @resource.close unless @resource.closed?
    // super is invoked implicitly here
  end destructor
end class
\end{lstlisting}






\subsection{Clone Constructor Definitions}
\label{sec:clone-def}

\syntax\begin{lstlisting}
CCtor_Def     ::= 'clone' CCtor_Fun_Def
CCtor_Fun_Def ::= [Param_Clauses] 
                  (':=' Constr_Expr | Constr_Block)
\end{lstlisting}

Clone constructors are pretty much like constructor, except for they are not invoked indirectly by \code{allocate} on \code{Class}, but by \code{clone} on the cloned instance. Regular constructors are not invoked on the cloned objects, since they were already invoked on the original object. 

Clone constructor implicitly returns the new cloned object, unless returning explicitly a different object (which would possibly invoke its regular constructors). The original object is available with the \code{self} and \code{this} keywords, the new cloned object is available with the ~\lstinline!self[cloned]!~ construct. The ~\lstinline!self[cloned]!~ construct is only legal in a body of the clone constructor. Clone constructors are invoked in the context of the original object, and ~\lstinline!self[cloned]!~ is the only allowed prefix to instance values and variables, allowing to define new instance values or variables in the clone. 

Clone constructors pass on the eigenclass (if any) of the original object to the cloned object, thus elevating it to an almost regular class -- a prototype class, a class that resides not in a constant, but in a class instance, in an object (but that original object may be still assigned to a constant anyway). 

A different clone constructor of the same class may be invoked by using the \code{self} keyword as a function name. If a clone constructor invokes a different clone constructor of the same class this way, the super-clone-constructor is not implicitly invoked (since it is invoked in the other clone constructors). 

\paragraph{\em Default clone constructor}
A default clone constructor of a class is the explicit parameterless clone constructor. The \code{Object} class has a default root clone constructor, which carries the modifier \code{protected} (\sref{sec:modifiers}). Therefore, any custom clone constructor has to be explicitly protected in a less restrictive way, or public, in order to allow direct object cloning from outside of the class that defines it. 

\paragraph{\em Implicit clone constructor}
An implicit clone constructor is an automatically generated bridge clone constructor to the parameterless default clone constructor. An implicit clone constructor ``does nothing'' but invokes the super-clone-constructor and makes a shallow copy of every member specific to the cloned object. 

\paragraph{\em Convenience clone constructor}
A convenience clone constructor is any other clone constructor than the parameterless default clone constructor. The \code{clone} method of objects can accept any number of arguments that are then passed into the clone constructor and the clone constructor is resolved based on these passed arguments. 

\paragraph{\em Accessibility of clone constructors}
Clone constructors may have modified accessibility, so that only certain functions can invoke them indirectly. The accessibility is then transitioned from the calling context. 

\example An example of a default clone constructor of class $C$, performing a deep copy. 
\begin{lstlisting}
class $C$
  clone
    // super is invoked implicitly here
    self[cloned].@resource := @resource.clone
  end constructor
end class
\end{lstlisting}






\subsection{Case Classes}
\label{sec:case-classes}

\syntax\begin{lstlisting}
Tmpl_Def ::= 'case' 'class' Class_Def
\end{lstlisting}

If a class definition is prefixed with \code{case}, the class is said to be a {\em case class}. 

The formal parameters are handled differently from regular classes. The formal parameters in the first parameter section of a case class are called {\em elements} and are treated specially:
\begin{itemize}
\item[] First, the value of such a parameter can be extracted as a field of a constructor pattern. 
\item[] Second, a \code{val} prefix is implicitly added to such a parameter, unless the parameter already carries a \code{val} or \code{var} modifier. Hence, an accessor definition for the parameter is generated (\sref{sec:class-definitions}). 
\end{itemize}

A case class definition of \lstinline!$c$[$\tps$]@[$\dps$][<$\uomps$>]($\ps_1$)$\ldots$($\ps_n$)! with type parameters $\tps$, indexing parameters $\dps$, aggregated with units of measure $\uomps$ and value parameters $\ps$ implicitly adds some methods to the corresponding class object, making it suitable as an extractor object (\sref{sec:extractor-patterns}), and are defined as follows:\footnote{Notice that indexing parameters are not present. These are used for type definitions only, and are not intended to be used in general expressions like instance creation.} 
\begin{lstlisting}
object $c$ {
  def apply[$\tps$][<$\uomps$>]($\ps_1$)$\ldots$($\ps_n$): $c$[$\tps$] := 
      $c$[$\Ts$][<$\UoMs$>].new($xs_1$)$\ldots$($xs_n$)
  def unapply[$\tps$][<$\uomps$>]($x$: $c$[$\tps$][<$\uomps$>]): Option[$e$] :=
      unless x = nil
        Some($x$.$xs_{11} \commadots x$.$xs_{1k}$)
      else
        None
      end
}
\end{lstlisting}

Here, $\Ts$ stands for the vector of types defined in the type parameter section $\tps$, $\UoMs$ stands for the vector of units of measure defined in the units of measure parameter section $\uomps$, each $xs_i$ denotes the parameter names of the parameter section $\ps_i$, $xs_{11} \commadots xs_{1k}$ denote the names of all parameters in the first parameter section $xs_1$, and $e$ denotes the type that \code{Option} is parameterized with. If a type parameter section is missing in the class $c$, it is also missing in the \code{apply} and \code{unapply} methods. The definition of \code{apply} is missing also if the class $c$ is marked \code{abstract}.\footnote{Because the implied \code{apply} method creates new objects and abstract classes can't have any instances of themselves.}

If the case class definition contains an empty value parameter list, the \code{unapply} returns a \code{Boolean} instead of an \code{Option} type and is defined as follows:
\begin{lstlisting}
def unapply[$\tps$][<$\uomps$>]($x$: $c$[$\tps$][<$\uomps$>]): Boolean := x != nil
\end{lstlisting}

For each case of a value parameter list of $n$ parameters, the \code{unapply} returns these types: 
\begin{itemize}
\item
For $n = 0$, ~\lstinline!Boolean!~ is the return type. 

\item
For $n = 1$, ~\lstinline!Option[$\Tp_1$]!~ is the return type, where $\Tp_1$ is the type of the only parameter in the first parameter section. 

\item
For $n \geq 1$, ~\lstinline!Option[($\Tp_1 \commadots \Tp_n$)]!~ is the return type, where $\Tp_i$ is the type of the $i^{\superth}$ parameter of the first parameter section. Notice that the \code{Option} is parameterized with a tuple type (\sref{sec:tuple-types}). This allows for the \code{apply} method of \code{Some} to accept a tuple of arguments while accepting a single argument only. 
\end{itemize}

A method named \code{copy} is implicitly added to every case class, unless the case class already has a matching one, or the class has a repeated parameter. The method is defined as follows:
\begin{lstlisting}
def copy [$\tps$][<$\uomps$>]($\ps'_1$)$\ldots$($\ps'_n$): $c$[$\tps$][<$\uomps$>] :=
    $c$[$\Ts$][<$\UoMs$>].new($xs_1$)$\ldots$($xs_n$)
\end{lstlisting}
$\Ts$ stands for the vector of types defined in the type parameter section $\tps$ and $\UoMs$ stands for the vector of units of measure arguments defined in the units of measure parameter section $\uomps$. Each $xs_i$ denotes the parameter names of the parameter section $\ps'_i$.  Each value parameter of the first parameter list $\ps'_1$ has the form ~\lstinline!:$x_{1,j}$ : $T_{1,j}$ := self.$x_{1,j}$!, and the other parameters $\ps'_{i,j}$ of the clone constructor are defined as ~\lstinline!:$x_{1,j}$ : $T_{1,j}$!. Note that these parameters are defined as named parameters (\sref{sec:named-parameters}), and that the parameters of the first value parameter section have default values using \code{self}, which is available, since the copied object is already ``complete''. 

A clone constructor is also implicitly added to every case class, but limited to the first value parameter section. The following definition of the implicitly added clone constructor shares the definition of parameters: 
\begin{lstlisting}
clone [$\tps$][<$\uomps$>]($\ps'_1$): $c$[$\tps$][<$\uomps$>]
  self[cloned].@$xs_{1,1}$ := $xs_{1,1}$
  $\ldots$
  self[cloned].@$xs_{1,n}$ := $xs_{1,n}$
end clone
\end{lstlisting}
Here, $xs_{1,n}$ denotes the (named) parameter names of the first (and only) parameter section. 

Every case class implicitly overrides some method definitions of class \code{Object}, unless a definition of the same method is already given in the case class itself or a concrete definition of the same method is given in some base class (including traits) of the case class, different from \code{Object}. Namely: 
\begin{itemize}
\item[]
Method ~\lstinline!equals: (Object) $\mapsto$ Boolean!~ (equivalent to operator ``\lstinline!=!'') is structural equality, where two instances are equal if they both belong to the case class in question and they have equal (with respect to \code{equals}) elements. 

\item[]
Method ~\lstinline!hash_code: () $\mapsto$ Number.Integer_Unsigned!~ computes a hash code. 

\item[]
Method ~\lstinline!to_string: () $\mapsto$ String!~ returns a string representation which contains the name of the case class and its elements. 
\end{itemize}






\subsection{Traits}
\label{sec:traits}

\syntax\begin{lstlisting}
Tmpl_Def       ::= 'trait' Trait_Def
Trait_Def      ::= constant_id [Type_Param_Clause] [UoM_Params] 
                   Trait_Tmpl_Env
Trait_Tmpl_Env ::= 'extends' [Early_Defs] Trait_Parents
                   semi [Template_Body] 'end' ['trait']
                 | ['extends' [Early_Defs]] 
                   '{' [Template_Body] '}'
                 | ['begin' [Template_Body]] 'end' ['trait']
\end{lstlisting}

A trait is a class that is meant to be injected into some other class as a mixin (including another traits). Unlike normal classes, traits can not be instantiated alone. 

Assume a trait $D$ defines some aspect of an instance $x$ of type $C$ (i.e. $D$ is a base class of $C$). Then the {\em actual supertype} of $D$ in $x$ is the compound type consisting of all the base classes in $\lin{C}$ that succeed $D$. The actual super type gives the context for resolving a \code{super} reference in a trait (\sref{sec:self-this-super}). Note that the actual supertype depends on the type to which the trait is added in a trait composition; it is not statically known at the time the trait is defined (the trait must exist before being added anywhere). 

If $D$ is not a trait, then its actual supertype is simply its least proper supertype (which is statically known). 

\example The following trait defines the property of being comparable to objects of some type. It contains an abstract operator \lstinline!<! and default implementations of the other comparison operators \lstinline!<=!, \lstinline!>! and \lstinline!>=!. Operators are methods, too. The trait also requires the self-type to be \lstinline[mathescape=false]!$T!. 
\begin{lstlisting}[mathescape=false]
trait Comparable[$T <: Comparable[$T]] {
  requires $T
  operator < (that: $T): Boolean end
  operator <=(that: $T): Boolean := self < that || self = that
  operator > (that: $T): Boolean := that < self
  operator >=(that: $T): Boolean := that <= self
}
\end{lstlisting}






\subsection{Refinements}
\label{sec:refinements}

There are two separate branches of refinements in Coral, both are quite similar, but used for different purposes. Refinements are kind of a trait (\sref{sec:traits}). The branches are as follows:
\begin{itemize}
\item[]
First, refinements as part of the type system. Those refinements present only declarations and further type restrictions as part of compound types (\sref{sec:compound-types}).

\item[]
Second, refinements that are basically traits designed to be locally prepended to classes. The second branch is described here. 
\end{itemize}

\syntax\begin{lstlisting}
Tmpl_Def            ::= 'refinement' Refinement_Def
Refinement_Def      ::= constant_id 'refine' constant_id 
                        Refinement_Tmpl_Env
Refinement_Tmpl_Env ::= '{' [Template_Body] '}'
                      | (semi | 'begin') [Template_Body] 
                        'end' ['refinement']
\end{lstlisting}

Such a refinement does not declare any type, indexing or units of measure parameters, since those are already declared on the type that it refines. Therefore, the type and units of measure parameters are made available to the refinement in order to allow it to override the class methods type-correctly. 

Refinements need to be ``activated'' in the scope for it to take effect (\sref{sec:use-expressions}).

If a refinement refines a parameterized type, then the refinement only activates for this parameterized type (\sref{sec:parameterized-types}). A refinement can also refine a constrained type (\sref{sec:constrained-types}), and the refinement then again only applies to values that conform to this constrained type. 

A refinement is not allowed to include or prepend any new traits to the type that it refines. It is an error if it attempts to do so. 

A refinement is though allowed to refine classes that are \code{final} or \code{sealed}. 






\subsection{Protocols}
\label{sec:protocols}

\syntax\begin{lstlisting}
Tmpl_Def     ::= 'protocol' Pro_Def
Pro_Def      ::= constant_id [Type_Param_Clause] [UoM_Params]
                 Pro_Tmpl_Env
Pro_Tmpl_Env ::= 'extends' Trait_Parents
                 semi [Template_Body] 'end' ['trait']
               | ['extends'] '{' [Template_Body] '}'
               | ['begin' [Template_Body]] 'end' ['trait']
\end{lstlisting}

Protocols express the contracts that other classes have to implement, and are added to classes with the keyword ``\code{implements}''. 

Protocols are basically traits (\sref{sec:traits}) that are stripped of some features, namely: 
\begin{itemize}
\item
Only declarations are allowed as the template body. If a method definition is needed, use a trait instead. 

\item
Protocols can't declare anything for the class or metaclass of the class that implements them. If this is needed, use a trait instead. 

\item
Protocols don't have early definitions (\sref{sec:early-defs}). If this is needed, again, use a trait instead. 
\end{itemize}

Protocol references are preferred to traits to be used by library designers to declare contracts for the code that uses them. 







\subsection{Interfaces}
\label{sec:interfaces}

\syntax\begin{lstlisting}
Tmpl_Def      ::= ['case'] 'interface' [Ifc_Qualifier] Ifc_Def
Ifc_Qualifier ::= '[' Ifc_Kind ']'
Ifc_Kind      ::= 'class' | 'trait' | 'object'
Ifc_Def       ::= constant_id [Type_Param_Clause] 
                  [Dep_Params] [UoM_Params]
                  [Class_Param_Clauses] Ifc_Tmpl_Env
Ifc_Tmpl_Env  ::= 'extends' Class_Parents
                  semi [Template_Body] 'end' ['interface']
                | ['extends'] '{' [Template_Body '}'
                | ['begin' [Template_Body]] 'end' ['interface']
\end{lstlisting}

Interfaces are filtered versions of classes and traits with only declarations and without early definitions or any definitions at all, except for auxiliary constructor definitions that become empty constructor declarations (without function bodies). Interfaces can be generated from classes or traits by simple transformations and manually edited as needed. Their only purpose is to be used in {\em module interfaces}, so that implementation is not distributed along, but only declarations in interfaces and protocols are. 






\section{Object Definitions}
\label{sec:object-definitions}

\syntax\begin{lstlisting}
Object_Def ::= constant_id (Class_Template | Trait_Template)
\end{lstlisting}

Object definitions define singleton instances. If no superclass is given, \code{Object} is implied, unless the object definition has the same name as an existing or enclosing class -- then \lstinline!Class[$C$]! is implied and the object definition is called a {\em class object}. If the class definition is not connected to a class, then rules from compound types apply (\sref{sec:compound-types}), the object definition is simply called a {\em singleton object definition} and is a single object of a new (anonymous) class. This is unlike in Scala, where objects are defined as terms, in a scope separate from types: Coral has one scope for both types and terms. 

It's most general form is ~\lstinline!object $m$ extends $t$!. Here, $m$ is the name of the object to be defined (or of the class object, which is the same as the related class), and $t$ is a template (\sref{sec:templates}) of one of the following forms:

\paragraph{\em Singleton object form}
This is a form of objects that are not class objects (not instances of ~\lstinline!Class[$C$]!). 
\begin{lstlisting}
$sc$ with $mt_1$ with $\ldots$ with $mt_n$ { $\stats$ }
\end{lstlisting}

\paragraph{\em Class object form}
This is a form of objects that are class objects, therefore instances of ~\lstinline!Class[$C$]!. 
\begin{lstlisting}
$mt_1$ with $\ldots$ with $mt_n$ { $\stats$ }
\end{lstlisting}

Every trait applied to a class object does not affect the associated class itself -- here, the class object is the object that inherits features of the included/prepended traits, not the class instances; and the trait is included/prepended in the metaclass of the class object. This also has an implication on self types of traits (\sref{sec:traits}) that are to be included in a class object of class $C$: the self type would have to be ~\lstinline!Class[$C$]!, not just $C$. 

\subsection{Case Objects}
\label{sec:case-objects}

\syntax\begin{lstlisting}
Tmpl_Def ::= 'case' 'object' Object_Def
\end{lstlisting}

Case objects are pretty much similar to case classes (\sref{sec:case-classes}). Case objects can not be class objects at the same time. Their template (\sref{sec:templates}) is the singleton object form of an object definition (\sref{sec:object-definitions}). 






\section{Unions}
\label{sec:unions}

\syntax\begin{lstlisting}
Const_Type_Def ::= constant_id 'is' 'union' 'of'
                   '(' Type {semi Type} ')'
\end{lstlisting}

Union types represent multiple types, possibly unrelated. Union types are abstract by nature and can not be instantiated, only the types that they contain may, if these are instantiable. For type safety, bindings of union types should be matched for the actual type prior to usage. 






\section{Enums}
\label{sec:enums}

\syntax\begin{lstlisting}
Const_Type_Def ::= constant_id [Superclass] 'is' ['bitfield'] 
                   'enum' '(' Enum_Field {semi Enum_Field} ')'
Enum_Field     ::= constant_id [':=' scalar_literal]
\end{lstlisting}

% TODO: when primary constructors are introduced, add them to enums as well

Enums (short for Enumerations) are types that contain constants. Bitfield enums may be combined to still produce a single enum value. Every enum constant is a singleton instance of the enum class. 






\section{Dependent Type Declarations}
\label{sec:dependent-types-decl}

Dependent types consist of three kinds of types in Coral. First, there are {\em indexed types} (\sref{sec:indexed-types}), that are at the core of dependent types. Not every type in Coral is indexed. Secondly, there are two types that are similar and sometimes interchangeable: {\em constrained types} (\sref{sec:constrained-types}) and {\em range types} (\sref{sec:range-types}), each making use of indexed types in a specific way. Arguments applied to these types are then described in \sref{sec:dependent-types}. 

Dependent types are neither concrete nor abstract. They only add a way of indexing existing types and defining subsets of all instances. As a side-effect of this restriction, variables involved in dependent type declarations are not involved in the rest of the class declarations and definitions, and for that reason don't need to be distinguished from other variables. 

Dependent types (\sref{sec:dependent-types}) are allowed in these positions: 
\begin{enumerate}
\item Function parameters. 
\item Function return types. 
\item Variable declarations and definitions. 
\item Type conversions. 
\end{enumerate}






\subsection{Indexed Types}
\label{sec:indexed-types}

\syntax\begin{lstlisting}
Dep_Params         ::= '@[' Index_Param {',' Index_Param} ']'
Index_Param        ::= variable_id [':' Simple_Type]
Indexed_Class_Expr ::= Class_Expr
                     | Indexed_By_Clause
Indexed_By_Clause  ::= 'indexed-with' Indexing_Expr
Indexing_Expr      ::= '{|' Index_Param {',' Index_Param} '|'
                       [Index_Exprs] '}'
                     | '(' Index_Param {',' Index_Param} ')' '->'
                       '{' [Index_Exprs] '}'
Index_Exprs        ::= Index_Expr {[semi] Index_Expr}
Index_Expr         ::= Index_Var Index_Op Index_Val
                     | Index_Val [Index_Op Index_Var]
                     | '(' Index_Var Index_Op Index_Var ')'
                     | '(' Index_Expr [Index_Con Index_Expr] ')'
Index_Var          ::= variable_id 
                     | ivar_id
                     | 'self'
Index_Val          ::= variable_id 
                     | ivar_id 
                     | literal
                     | constant_id
                     | Index_Fun '(' Index_Var {',' Index_Var} ')'
\end{lstlisting}

Indexed types declare what their index is, based on combinations of their input (indexing) variables, instance variables and operators and functions working with these. Since the scope of testing these {\em indexing constraints} is limited to cases listed in \sref{sec:dependent-types-decl}, independent on the intrinsic state of the instances, the instances may appear in states that do not conform to the constraints in between each indexing constraint test, but to pass as the dependent type, they must conform to the indexing constraint at the time the test is invoked, that is: 
\begin{enumerate}
\item Method resolution time (function parameters). 
\item Returning from a function (function return types). 
\item Getting assigned to a variable. 
\item Getting converted to a type (unless the conversion is implicit to a different type). 
\end{enumerate}

Indexed types basically render {\em subsets of the original type}, each such subset may or may not overlay any previous subsets (based on the ordering of chosen sorts) -- that is up to the indexing expressions to define. 

Note that implicit conversions (\sref{sec:implicit-conversions}) can't apply to dependent types, since that would be a conversion from the same type to a subset of the same type. 

\paragraph{\em Sorts}
This part of Coral is inspired by the ATS language. ``Sorts'' are a types for which the language knows ordering of their values implicitly:
\begin{itemize}
\item \code{Boolean}.
\item \code{Integer}.
\item \code{Float}.
\item \code{Char}.
\item Every \code{enum} type (\sref{sec:enums}), where the ordering is given by the order in which each enumerated value appears. 
\item Every type constrained from a pre-existing sort (\sref{sec:constrained-types}).
\end{itemize}

See references of these ``sort'' types for more details on their particular ordering. 

``Sorts'' are the types allowed as types of {\em indexing variables} (see \code{Index_Param} syntax). If no type is specified, \code{Integer} ``sort'' is implied. 

For the mentioned reasons, \code{Dep_Sort_Val} (used in \sref{sec:dependent-types}) are values that are members of ``sorts''. 

Note that the \code{Index_Exprs} are optional -- meaning that the entire ``sort'' is used for indexing, not only a subset of it. 

\paragraph{\em Indexing Operators}
Indexing operators used to declare indexing constraints are the following for the \code{Index_Op} syntax:
\begin{itemize}
\item \lstinline!~! (bitwise negation): \lstinline!(Number) $\mapsto$ Number!
\item \lstinline!+! (addition): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!-! (subtraction): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!*! (multiplication): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!**! (exponentiation): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!/! (division): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!%! (modulo): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!>! (greater than): \lstinline!(Number, Number) $\mapsto$ Boolean!
\item \lstinline!>=! (greater than or equal to): \lstinline!(Number, Number) $\mapsto$ Boolean!
\item \lstinline!<! (less than): \lstinline!(Number, Number) $\mapsto$ Boolean!
\item \lstinline!<=! (less than or equal to): \lstinline!(Number, Number) $\mapsto$ Boolean!
\item \lstinline!=! (equal to): \lstinline!(Number, Number) $\mapsto$ Boolean!)
\item \lstinline!<>! (not equal to): \lstinline!(Number, Number) $\mapsto$ Boolean!
\item \lstinline@!=@ (not equal to): \lstinline!(Number, Number) $\mapsto$ Boolean!
\item \lstinline@!@ (boolean negation): \lstinline!(Boolean) $\mapsto$ Boolean!
\item \lstinline!||! (boolean disjunction): \lstinline!(Boolean, Boolean) $\mapsto$ Boolean!
\item \lstinline!&&! (boolean conjunction): \lstinline!(Boolean, Boolean) $\mapsto$ Boolean!
\item \lstinline!^^! (boolean exclusive disjunction): \lstinline!(Boolean, Boolean) $\mapsto$ Boolean!
\item \lstinline!|! (bitwise or): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!&! (bitwise and): \lstinline!(Number, Number) $\mapsto$ Number!
\item \lstinline!^! (bitwise xor): \lstinline!(Number, Number) $\mapsto$ Number!
\end{itemize}
These operators are static\footnote{That is, not overridable by user programs.}. In the list, \code{Number} can also be replaced by \code{Char}, but not by \code{Complex}. 

\paragraph{\em Indexing Functions}
Functions that can be used to constrain the indexing are also static and limited to work only with a restricted number of types:
\begin{itemize}
\item \lstinline!size: (List) $\mapsto$ Number!
\item \lstinline!length: (String) $\mapsto$ Number!
\item \lstinline!empty?: (List) $\mapsto$ Boolean!
\item \lstinline!empty?: (String) $\mapsto$ Boolean!
\item \lstinline!max: (*Number) $\mapsto$ Number!
\item \lstinline!min: (*Number) $\mapsto$ Number!
\item \lstinline!avg: (*Number) $\mapsto$ Number!
\item \lstinline!sum: (*Number) $\mapsto$ Number!
\item \lstinline!abs: (*Number) $\mapsto$ Number!
\item \lstinline!sgn: (Number) $\mapsto$ Number!
\item \lstinline!log: (Number, Number) $\mapsto$ Number!
\item \lstinline!ln: (Number) $\mapsto$ Number!
\item \lstinline!even?: (Number) $\mapsto$ Boolean!
\item \lstinline!odd?: (Number) $\mapsto$ Boolean!
\item \lstinline!concat: (*String) $\mapsto$ String!
\item \lstinline!coalesce: (*Object) $\mapsto$ Object!
\item \lstinline!lowercase: (String) $\mapsto$ String!
\item \lstinline!uppercase: (String) $\mapsto$ String!
\end{itemize}

\paragraph{\em Indexing Constraint Concatenation}
If there are multiple indexing constraints separated by the \lstinline![semi]! syntax, boolean conjunction is implied. Indexing constraints may be joined by a different boolean operations (\code{Index_Con}): 
\begin{itemize}
\item \lstinline!||! (boolean disjunction): \lstinline!(Boolean, Boolean) $\mapsto$ Boolean!
\item \lstinline!&&! (boolean conjunction): \lstinline!(Boolean, Boolean) $\mapsto$ Boolean!
\item \lstinline!^^! (boolean exclusive disjunction): \lstinline!(Boolean, Boolean) $\mapsto$ Boolean!
\end{itemize}

\example The following is an example on how a \code{String} type might index itself: 
\begin{lstlisting}
class String @[length: Integer]
  indexed-with (length) -> {@length = length}
end
\end{lstlisting}






\subsection{Constrained Types}
\label{sec:constrained-types}

\syntax\begin{lstlisting}
Type_Def      ::= constant_id [Type_Param_Clause] ':=' 
                  Type [Dep_Params_C]
Dep_Params_C  ::= '@[|' Index_Param {',' Index_Param} '|'
                  [Index_Exprs_C] ']'
                | '@(' Index_Param {',' Index_Param} ')'
                  '->' '{' [Index_Exprs_C] '}'
Index_Exprs_C ::= Index_Expr_C {[semi] Index_Expr_C}
Index_Expr_C  ::= Index_Var_C Index_Op Index_Val_C
                | Index_Val_C [Index_Op Index_Var_C]
                | '(' Index_Var_C Index_Op Index_Var_C ')'
                | '(' Index_Expr_C 
                  [Index_Con Index_Expr_C] ')'
Index_Var_C   ::= variable_id
Index_Val_C   ::= variable_id
                | literal
                | constant_id
                | Index_Fun '(' Index_Var_C 
                  {',' Index_Var_C} ')'
\end{lstlisting}

Constrained types are basically manipulations over the indexing types, constraining the indexing parameters of the indexed type, where the order of the parameters is the same as of the original indexed type (and the actual used parameter name is irrelevant, but is better to be the same). 

No additional instance variable can be constrained by a constrained type directly. 

The number of the parameters for every constrained type must be the same as the number of the parameters of the original indexed type, but it is irrelevant if any of these parameters is used in the constraining expression (but for it to make sense, at least one should be used). If the constraining expression is of the form ~\lstinline!$p_i$ = $j_i$! for every parameter $p_i$ (without any further constraints), the constrained type is equivalent to the dependent type (\sref{sec:dependent-types}) ~\lstinline!$T$@[$j_1 \commadots j_n$]! for $n$ indexing parameters. 

The type of the indexing variable is implied to be the same as of the original indexed type. 

\example Here is an example of how Coral might declare the \code{Char} type:
\begin{lstlisting}
type Char := String @[|length| length = 1]
type Char := String @(length) -> {length = 1}
\end{lstlisting}
Notice how the constraint only uses the already existing indexing variable. This is in turn equivalent to the dependent type:
\begin{lstlisting}
type Char := String @[1]
\end{lstlisting}

\example Here is an example of how Coral might declare simply ``short'' strings type:
\begin{lstlisting}
type Short_String := String @[|length| length <= 255]
type Short_String := String @(length) -> {length <= 255}
\end{lstlisting}

\example Here is an example of a different constrained type: 
\begin{lstlisting}
type Even_Positive_Integers := Integer @[|i| even?(i); i >= 0]
type Even_Positive_Integers := Integer @(i) -> {even?(i); i >= 0}
\end{lstlisting}
This constrained type declares \code{Even_Positive_Ints} to be positive integers that are even at the same time. 






\subsection{Range Types}
\label{sec:range-types}

\syntax\begin{lstlisting}
Const_Type_Def ::= constant_id 'is' 'range' 
                   (Range_Expr 
                 | '(' Range_Expr ')' [':' Path])
\end{lstlisting}

Range types are similar to constrained types, but limited in a few ways: they can constrain only indexed types that are indexed with exactly one indexing variable. The range expression is converted into the corresponding indexing constraint. 

\example An example of a constrained type interchangeable with a range type:
\begin{lstlisting}
type Positive_Integers := Integer @(i) -> {i >= 0}
type Positive_Integers is range 
  (0 .. +Integer.Infinity) : Integer 
end type
type Positive_Integers is range
  0 .. +Integer.Infinity
end type
\end{lstlisting}

Types that do not require the ``\code{constant_id}'' are those that are ``sorts'' at the same time, so that the indexed type can be inferred. 






\section{Units of Measure}
\label{sec:units-of-measure}

\syntax\begin{lstlisting}
Const_Type_Def ::= Unit_Name 'is' ['abstract'] 'unit-of-measure' 
                   [semi Unit_Convs {semi Unit_Convs}]
Unit_Name      ::= variable_id | constant_id
                   ['extends' Superunit_Name]
Superunit_Name ::= variable_id | constant_id
Unit_Convs     ::= Unit_Name ':=' Unit_Conv
Unit_Conv      ::= '(' Unit_Conv ')'
                 | Unit_Elem [Unit_Op Unit_Elem]
                 | Unit_Conv Unit_Op Unit_Conv
Unit_Elem      ::= number_literal | Unit_Name
Unit_Op        ::= '*' | '/' | '**'
\end{lstlisting}

Numbers in Coral can have associated units of measure, which are typically used to indicate length, volume, mass, distance and so on. By using quantities with units, the runtime is allowed to verify that arithmetic relationships have the correct units, which helps prevent programming errors. 

\example The following defines the measure \code{cm} (centimeter).
\begin{lstlisting}
type cm is unit-of-measure
end type
\end{lstlisting}

\example The following defines the measure \code{ml} (milliliter) as a cubic centimeter (\lstinline!cm ** 3!).
\begin{lstlisting}
type ml is unit-of-measure
  ml := cm ** 3
end type
\end{lstlisting}

\example The following shows possible usage of abstract units of measure. 
\begin{lstlisting}
type distance is abstract unit-of-measure
end type

type m extends distance is unit-of-measure
  m := km / 1000
end type

type km extends distance is unit-of-measure
  km := m * 1000
end type

type mi extends distance is unit-of-measure
  mi := km * 0.621
  mi := (m * 1000) * 0.621 // this can be inferred!
end type
\end{lstlisting}
This enables types aggregated with units of measure require a number tagged with any distance unit of measure and still work with correct units. 

Every unit of measure is defined in the same scope as any other type would be, but the application of units of measure to numbers or {\em aggregated unit types} require to import units of measure by name into the scope where a unit of measure from a different unrelated module would be used. 

\paragraph{\em Types Aggregated with Units of Measure}
In addition to type parameters and dependency parameters of each type, every type may be parameterized with a units of measure aggregation. It is recommended to avoid mixing these three together. 

\syntax\begin{lstlisting}[mathescape=false]
UoM_Params ::= '[<' UoM_Param {',' UoM_Param} '>]'
UoM_Param  ::= '$' Unit_Name
\end{lstlisting}

Names of unit of measure parameters must not clash with names of type parameters, otherwise it is a compile-time error. 

\paragraph{\em Persistence of Units of Measure}
There is a huge difference between the way F\# handles units of measure and Coral's way. In F\#, the unit of measure information is lost after compilation, but persists in Coral in runtime, since verification of units of measure is deferred also to runtime, as it is limited during compilation. This also means that the information may be accessed in runtime, e.g. using it to print the unit information on screen.






\section{Record Types}
\label{sec:record-types}

\syntax\begin{lstlisting}
Const_Type_Def    ::= Record_Name 'is' ['abstract'] 'record'
                      [semi] Record_Components
Record_Name       ::= constant_id [Type_Param_Clause] [Param_Clause]
Record_Components ::= Record_Component {semi Record_Component}
                      [Superclass]
Record_Component  ::= 'val' Val_Dcl
                    | 'var' Var_Dcl
                    | 'case' variable_id semi 
                      {'when' constant_id 
                      ('then' | nl) 
                      Record_Components} 'end' ['case']
\end{lstlisting}

Record types are simple syntax sugar for classes that represent {\em data objects}, i.e., objects that don't really care about behaviour, their only purpose is to store data. 

Record types can appear in three different forms: {\em basic records}, {\em discriminated records} and {\em variant records}.\footnote{Note that the syntax for record types in Coral differs from Ada's \lstinline[language=Ada]!type Record_Name is record $\ldots$ end record;!. Coral ends a type, not a record. This difference appears in more places than just this syntax.}

\paragraph{\em Basic Records}
Basic records have no discriminating parameters, and can have only type parameters. Their structure is always the same. 

\paragraph{\em Discriminated Records}
Discriminated records are similar to variant records, they can have discriminating parameters and a discriminated record may also be a variant record. Discriminating parameters are to be used in conjunction with dependent types (\sref{sec:dependent-types-decl}) of the record's components. Discriminating a record type does the same thing as declaring a dependent type: it creates a subset of instances of the original record type. 

\paragraph{\em Variant Records}
Variant records are similar to discriminated records, they can have discriminating parameters and a discriminated record may also be a discriminated record. Variant parameters are enums (\sref{sec:enums}). Variant records render new subtypes of the original record type, similar to a concrete type constructor.

\example The following example defines a variant record. 
\begin{lstlisting}
type Traffic_Light is bitfield enum
  Red
  Yellow
  Green
end type

type Variant_Record (option: Traffic_Light) is record
  val a: A
  var b: B
  case option
  when Red
    val c: C
  when Yellow
    var d: D
  when Green
    val e: E
  end case
end type

let vr := Variant_Record(Traffic_Light.Red).
  new(a: A.new, b: B.new, c: C.new)
\end{lstlisting}

\section{Nullability}
\label{sec:nullability}

Every type in Coral conforms to \code{Object}. In turn, \code{Nothing} conforms to any type. But, the only instance of \code{Nothing}, which is a singleton accessed with the keyword \code{nil}, can not be assigned to every typed variable. If a type is declared as nullable, then it can. If a type is declared as not-nullable, which is the implicit preference for every type, then it can not.\footnote{An original idea was to make every type not-nullable and force users to use the \code{Option} type for every no-object scenario. But then, what would \code{nil} be good for?}

The implicit preference may be changed in two levels. These levels are {\em preferred nullability} and {\em explicit nullability} (\sref{sec:nullable-types}). 

Preferred nullability is switched by annotations on each class: \code{Nullable}. The annotation has one positional parameter of type \code{Boolean} defining what the nullability will be (\code{yes} for nullable types, \code{no} for not-nullable types), and a named parameter \lstinline[deletekeywords={override}]!:override! of type \code{Boolean}, defining whether subclasses may override this preference, and implicitly set to \code{yes}, meaning that subclasses may override this preference by default. 

All types in Coral are not-nullable implicitly to prevent \code{Method_Not_Found_Error}s, resulting from sending messages to \code{nil}. But it is clear that for some cases, nullability of types may be desired, such as with dictionaries, so that \code{nil} can be returned for keys that have no value in the dictionary. However, it is preferred to use the \code{Option} type wherever possible to indicate that the value may not be present, and moreover, the \code{Option} type can be used in pattern matching even for values that are not of the \code{Option} type, utilizing an extractor pattern (\sref{sec:extractor-patterns}) with \code{Some} and a constant pattern (\sref{sec:constant-patterns}) with \code{None}, instead of constructor patterns (\sref{sec:constructor-patterns}). This is again different from Scala, where \code{Some} and \code{None} can't be used to match any value, only \code{Option} values. This difference in Coral makes nullable types and the \code{Option} type interoperable in pattern matching. 

\example Here are all four versions of the nullability annotation. 
\begin{lstlisting}[deletekeywords={override}]
@{Nullable yes, override: yes}
@{Nullable yes, override: no}
@{Nullable no, override: yes}
@{Nullable no, override: no}
\end{lstlisting}




