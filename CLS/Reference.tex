%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

\section*{Preface}

Coral is a Ruby-like programming language which enhances advanced object-oriented programming with elements of functional programming. Everything is an object, in this sense it's a pure object-oriented language. Object blueprints are described by classes. Classes can be composed in multiple ways – classic inheritance and/or mixin composition, along with prototype-oriented inheritance.

Coral is also a functional language in the sense that every function is also an object, and generally, everything is a value. Therefore, function definitions can be nested and higher-order functions are supported out-of-the-box. Coral also has a limited support for pattern matching, which can emulate the algebraic types used in other functional languages.

Coral has been developed since 2012 in a home environment out of pure enthusiasm for programming and out of a desire for a truly versatile language. This document is a work in progress and will stay that way forever. It acts as a reference for the language definition and some core library classes.

Some of the languages that had major influence on the development of Coral, including syntax and behavior patterns, are Ruby, Ada, Scala, Java, C\#, F\# and Clojure. Coral tries to inherit their good parts and put them together in its own way.

The vast majority of Coral's syntax is inspired by \emph{Ruby}. Coral uses keyword program parentheses in Ruby fashion. There is \lstinline@class@ \ldots \lstinline@end@, \lstinline@def@ \ldots \lstinline@end@, \lstinline@do@ \ldots \lstinline@end@, \lstinline@loop@ \ldots \lstinline@end@. Ruby itself is inspired by other languages, so this relation is transitive and Coral is inspired by those languages as well (for example, Ada). 

Coral is inspired by \emph{Ada} in the way that user identifiers are formatted: \lstinline@Some_Constant_Name@ and — unlike in Ada, but quite similar to it — \lstinline@some_method_name@. Also, some control structures are inspired by Ada, such as loops, named loops, return expressions and record types. Pretty much like in Ada, Coral's control structures can be usually ended the same way: \lstinline@class@ \ldots \lstinline@end class@ etc. 

\emph{Scala} influenced the type system in Coral. Syntax for existential types comes almost directly from it. However, Coral is a rather dynamically typed language, so the type checks are made eventually in runtime (but some limited type checks can be made during compile time as well). Moreover, the structure of this mere specification is inspired by Scala's specification. 

From \emph{F\#}, Coral borrows some functional syntax (like function composition) and F\# also inspired the feature of~\nameref{sec:unitsofmeasuresyntax}. 

\emph{Clojure} inspired Coral in the way functions can get their names. Coral realizes that turning function names into sentences does not always work, so it is possible to use dashes, plus signs and slashes inside of function names. Therefore, \lstinline@call/cc@ is a legit function identifier. Indeed, binary operators are required to be properly surrounded by whitespace or other non-identifier characters. 

\chapter{Lexical Syntax}

Coral programs are written using the Unicode character set; Unicode supplementary characters are supported as well. Coral programs are preferably encoded with the UTF-8 character encoding. While every Unicode character is supported, usage of Unicode escapes is encouraged, since fonts that IDEs might use may not support the full Unicode character set.

Grammar of lexical tokens is given in the following sections. These tokens are then used as terminal symbols of the semantical grammar. 

\newpage

\section{Identifiers}\label{sec:identifiers}

\syntax\begin{lstlisting}
simple_id     ::= (lower | '_') [id_rest]
variable_id   ::= simple_id | '_' | '`' simple_id '`'
ivar_id       ::= '@' simple_id
cvar_id       ::= '@@' simple_id
function_id   ::= simple_id [id_rest_fun]
                | '`' simple_id [id_rest_fun] '`'
constant_id   ::= upper [id_rest_con]
                | '`' upper [id_rest_con] '`'
id_rest       ::= {letter | digit | '_'}
id_rest_con   ::= id_rest [id_rest_mid]
id_rest_fun   ::= id_rest [id_rest_mid] ['?' | '!' | '=']
id_rest_mid   ::= id_rest {('/' | '+' | '-') id_rest}
importable_id ::= simple_id
                  | function_id
                  | constant_id
\end{lstlisting}

There are three kinds of identifiers.

First, \textit{variable identifiers}, which are simply a lower-case letter followed by arbitrary sequence of letters (any-case), digits and underscores, or just one underscore (which has special meaning). Additionally, \textit{instance variable identifiers} are just prepended with a ``\lstinline|@|'' sign and \textit{class instance variable identifiers} are just prefixed with ``\lstinline|@@|''. 

Second, \textit{function identifiers}, which are the most complicated ones. They can start as a variable identifier, then optionally followed by one of ``\lstinline@/@'', ``+'' and ``\lstinline@-@'', and then optionally ended with ``\lstinline@?@'', ``\lstinline@!@'' or ``\lstinline@=@''. Furthermore, function identifiers ending with ``\lstinline@=@'' are never used at call site with this last character, but without it and as a target of an assignment expression (they are naming simple setters). 

And third, \textit{constant identifiers}, which are just like function identifiers, but starting with an upper-case letter, never just an underscore and never ending with ``\lstinline@?@'', ``\lstinline@!@'' or ``\lstinline@=@''.

An identifier may also be formed by an identifier between back-quotes (``\lstinline!$~$`$~$!''), to resolve possible name clashes with Coral keywords. Instance variable names (\code{ivar_id}) and class instance variable names (\code{cvar_id}) never clash with a keyword name, since these are distinguished by the preceding ~``\lstinline!@!''~ and ~``\lstinline!@@!''~ respectively. 

Coral programs are parsed greedily, so that a longest match rule applies. Letters from the syntax may be any Unicode letters, but English alphabet letters are recommended, along with English names.

\section{Keywords}\label{sec:keywords}

A set of identifiers is reserved for language features instead of for user identifiers. However, unlike in most other languages, keywords are not being recognized inside of paths, except for a few specific cases.

The following names are the reserved words.

\begin{lstlisting}
abstract    alias       annotation  as          begin
bitfield    break       case        cast        catch
class       clone       cloned      constant    constructor
declare     def         destructor  do          else
elsif       end         ensure      enum        final
for         for-some    function    get         goto
if          implements  implicit    in          include
interface   is          lazy        let         loop
match       memoize     message     method      mixin
module      native      next        nil         no
object      of          opaque      operator    out
override    prepend     private     property    protected
protocol    public      raise       range       record
redo        refine      rescue      retry       return
requires    sealed      self        set         singleton-type
skip        step        struct      super       template
test        then        this        throw       transparent
type        undef       unless      until       union
unit-of-measure         use         val         var
yes         weak        when        while       with
yield
\end{lstlisting}

Not every reserved word is a keyword in every context, this behavior will be further explained. For example, the bitfield reserved word is only recognized as a keyword inside an enumeration definition context, in a specific place. Every reserved word may be used as a function identifier, with a little work-around when used with an implicit receiver.

\section{Newline Characters}\label{sec:newlinecharacters}

\syntax\begin{lstlisting}
semi ::= nl {nl} | ';'
\end{lstlisting}

Coral is a line-oriented language, in which statements are expressions and may be terminated by newlines, as well as by semi-colon operator. A newline in a Coral source file is treated as the special separator token \lstinline@nl@ if the following criterion is satisfied:

\begin{enumerate}
\item The token immediately preceding the newline can terminate an expression.
\end{enumerate}

Since Coral may be interpreted in a REPL\footnote{Read-Eval-Print Loop} fashion, there are no other suitable criteria. Such a token that can terminate an expression is, for instance, not a binary operator or a message sending operator, which both require further tokens to create an expression. Keywords that expect any following tokens also can not terminate expressions. Coral interpreters and compilers do not look-ahead beyond newlines.

If the token immediately preceding the newline can not terminate an expression and is followed by more than one newline, Coral still sees that as only a one significant newline, to prevent any confusion.

Keywords that can terminate an expression are: \lstinline@break@, \lstinline@end@, \lstinline@opaque@, \lstinline@native@, \lstinline@next@, \lstinline@nil@, \lstinline@no@, \lstinline@redo@, \lstinline@retry@, \lstinline@return@, \lstinline@self@, \lstinline@skip@, \lstinline@super@, \lstinline@this@, \lstinline@transparent@, \lstinline@yes@, \lstinline@yield@.

\section{Operators}\label{sec:operators}

A set of identifiers is reserved for language features, some of which may be overridden by user space implementations. Operators have language-defined precedence rules that are supposed to usually comply to user expectations (principle of least surprise), and another desired precedence may be obtained by putting expressions with operators inside of parenthesis pairs. 

The following character sequences are the operators recognized by Coral. 

\begin{lstlisting}
:=     +=     -=     *=     **=    /=     %=     ||=    &&=    ^^= 
|=     &=     |=     :[     ^=     ~=     <<     >>     <<<    >>> 
<<=    >>=    <<<=   >>>=   ;      =      !=     ==     !==    === 
!===   =~     !~     <>     <      >      <=     >=     <=>    + 
-      *      **     /      div    %      mod    ||     or     && 
and    !      not    ^^     xor    |      &      ^      ~      .. 
...    ,      ->     <-     ~>     <~     =>     ::     :      <: 
:>     <<|    |>>    <|     |>     (      )      [      ]      { 
}      .      [<     >]     >:     .?     .!
\end{lstlisting}

Some of these operators have multiple meanings, usually up to two. Some are binary, some are unary, none is ternary. 

Binary (infix) operators have to be separated by whitespace or non-letter characters on both sides, unary operators on left side – the right side is what they are bound to. 

Unary operators are: \lstinline@+@, \lstinline@-@, \lstinline@&@, \lstinline@not@, \lstinline@!@ and \lstinline@~@. The first three of these are binary as well. The \lstinline@;@ operator is used to separate expressions (see \nameref{sec:newlinecharacters}). Parentheses are postcircumfix operators. Coral has no postfix operators. 

Coral allows for custom user-defined operators, but those have the lowest precedence and need to be parenthesized in order to express any precedence. Such custom operators can't be made of letter characters. 

\section{Literals}\label{sec:literals}

There are literals for numbers (including integer, floating point and complex), characters, booleans, strings, symbols, regular expressions and collections (including tuples, lists, dictionaries and bags). 

\syntax\begin{lstlisting}
literal ::= integer_literal
	| floating_point_literal
	| complex_literal
	| character_literal
	| string_literal
	| symbol_literal
	| regular_expression_literal
	| collection_literal
	| 'nil'
\end{lstlisting}

\subsection{Integer Literals}\label{sec:integerliterals}

\syntax\begin{lstlisting}
integer_literal     ::= ['+' | '-'] (decimal_numeral
	| hexadecimal_numeral
	| octal_numeral
	| binary_numeral)
decimal_numeral     ::= '0' | non_zero_digit {['_'] digit}
hexadecimal_numeral ::= '0x' | hex_digit {['_'] hex_digit}
digit               ::= '0' | non_zero_digit
non_zero_digit      ::= '1' | … | '9'
hex_digit           ::= '1' | … | '9' | 'a' | … | 'f'
octal_numeral       ::= '0' oct_digit {'_' oct_digit}
oct_digit           ::= '0' | … | '7'
binary_numeral      ::= '0b' bin_digit {['_'] bin_digit}
bin_digit           ::= '0' | '1'
\end{lstlisting}

Integers are usually of type \lstinline@Number@, which is a class cluster of all classes that can represent numbers. Unlike Java, Coral supports both signed and unsigned integers directly. Usually integer literals that are obviously unsigned integers are automatically represented internally by a class that stores the integer unsigned, like \lstinline@Integer_64_Unsigned@. Math operations on numbers are handled internally in such a way that the user does't need to worry about the actual types of the numbers — when an integer overflow would occur, the result is stored in a larger container type. 

Underscores used in integer literals have no special meaning, other than to improve readability of larger literals, i.e., to separate thousands.

Integral members of the \lstinline@Number@ class cluster include the following container types. 

\begin{enumerate}

\item \lstinline@Integer_8@ ($-2^{7}$ to $2^{7}-1$), alias \lstinline@Byte@

\item \lstinline@Integer_8_Unsigned@ ($0$ to $2^{8}$), alias \lstinline@Byte_Unsigned@

\item \lstinline@Integer_16@ ($-2^{15}$ to $2^{15}-1$), alias \lstinline@Short@

\item \lstinline@Integer_16_Unsigned@ ($0$ to $2^{16}$), alias \lstinline@Short_Unsigned@

\item \lstinline@Integer_32@ ($-2^{31}$ to $2^{31}-1$)

\item \lstinline@Integer_32_Unsigned@ ($0$ to $2^{32}$)

\item \lstinline@Integer_64@ ($-2^{63}$ to $2^{63}-1$), alias \lstinline@Long@

\item \lstinline@Integer_64_Unsigned@ ($0$ to $2^{64}$), alias \lstinline@Long_Unsigned@

\item \lstinline@Integer_128@ ($-2^{127}$ to $2^{127}-1$), alias \lstinline@Double_Long@

\item \lstinline@Integer_128_Unsigned@ ($0$ to $2^{128}$), alias \lstinline@Double_Long_Unsigned@

\item \lstinline@Decimal@ ($-\infty$ to $\infty$)

\item \lstinline@Decimal_Unsigned@ ($0$ to $\infty$)

\end{enumerate}

The special \lstinline@Decimal@ \& \lstinline@Decimal_Unsigned@ container types are also for storing arbitrary precision floating point numbers. All the container types are constants defined in the \lstinline@Number@ class and can be imported into scope if needed. 

Moreover, a helper type \lstinline@Number::Unsigned@ exists, which can be used for type casting in cases where an originally signed number needs to be treated as unsigned. 

Weak conformance applies to the inner members of \lstinline@Number@ class. 

For use with range types, \lstinline@Number::Integer@ and \lstinline@Number::Integer_Unsigned@ exist, to allow constraining of the range types to integral numbers.

\subsection{Floating Point Literals}\label{sec:floatliterals}

\syntax\begin{lstlisting}
float_literal ::= ['+' | '-'] non_zero_digit 
		{['_'] digit} '.' digit {['_'] digit}
		[exponent_part] [float_type]
	| ['+' | '-'] digit {['_'] digit} exponent_part [float_type]
	| ['+' | '-'] digit {['_'] digit} [exponent_part] [float_type]
	| ['+' | '-'] '0x' hex_digit
		{['_'] hex_digit} '.' hex_digit {['_'] hex_digit}
		[float_type]
	| ['+' | '-'] '0b' bin_digit
		{['_'] bin_digit} '.' bin_digit {['_'] bin_digit}
		[float_type]
exponent_part ::= 'e' ['+' | '-'] digit {['_'] digit}
float_type    ::= 'f' | 'd' | 'q'
\end{lstlisting}

Floating point literals are of type \lstinline@Number@ as well as integral literals, and have fewer container types. Compiler infers the precision automatically, unless the \lstinline@float_type@ part is present. 

\begin{enumerate}

\item \lstinline@Float_32@ (IEEE 754 32-bit precision), alias \lstinline@Float@. 

\item \lstinline@Float_64@ (IEEE 754 64-bit precision), alias \lstinline@Double@.

\item \lstinline@Float_128@ (IEEE 754 128-bit precision).

\item \lstinline@Decimal@ ($-\infty$ to $\infty$).

\item \lstinline@Decimal_Unsigned@ ($0$ to $\infty$).

\end{enumerate}

Letters in the exponent type and float type literals have to be lower-case in Coral sources, but functions that parse floating point numbers do support them being upper-case for compatibility. 

\subsection{Imaginary Number Literals}\label{sec:imaginaryliterals}

\syntax\begin{lstlisting}
imaginary_literal ::= real_number_literal 'i'
complex_literal ::= real_number_literal ('+' | '-') imaginary_literal
	| imaginary_literal ('+' | '-') real_number_literal
real_number_literal ::= integer_literal | float_literal
number_literal ::= real_number_literal
	| imaginary_literal
	| complex_literal
\end{lstlisting}

\subsection{Units of Measure}\label{sec:unitsofmeasuresyntax}

Coral has an addition to number handling, called \textit{units of measure}. Number instances can be annotated with a unit of measure to ensure correctness of arithmetic operations. 

\syntax\begin{lstlisting}
annotated_number ::= number_literal '[<' units_of_measure_expr '>]'
\end{lstlisting}

\subsection{Character Literals}\label{sec:characterliterals}

\syntax\begin{lstlisting}
character_literal ::= '%'' (character | unicode_escape) '''
\end{lstlisting}

\subsection{Boolean Literals}\label{sec:booleanliterals}

\syntax\begin{lstlisting}
boolean_literal ::= 'yes' | 'no'
\end{lstlisting}

Both literals are members of type \lstinline@Boolean@. The \lstinline@no@ literal has also a special behavior when being compared to \lstinline@nil@: \lstinline@no@ equals to \lstinline@nil@, while not actually being \lstinline@nil@. Identity equality is indeed different. The implication is that both \lstinline@nil@ and \lstinline@no@ are false conditions in \lstinline@if@-expressions. 

\subsection{String Literals}\label{sec:stringliterals}

\syntax\begin{lstlisting}
string_literal              ::= simple_string_literal 
                              | interpolable_string_literal
simple_string_literal       ::= ''' {string_element} '''
string_element              ::= printable_char | char_escape_seq
interpolable_string_literal ::= '"' {int_string_element} '"'
int_string_element          ::= string_element | interpolated_expr
interpolated_expr           ::= '#{' expr '}'
\end{lstlisting}

String literals are members of the type \lstinline@String@. Single quotes in simple string literals have to be escaped (\lstinline@\'@) and double quotes in interpolable string literals have to be escaped (\lstinline@\"@). Interpolated expression can be preceded only by an even number of escape characters (backslashes, \lstinline@\@), so that the \lstinline@#@ does't get escaped. This is a special \textit{requirement} for any Coral compiler. 

\subsection{Symbol Literals}\label{sec:symbolliterals}

\syntax\begin{lstlisting}
symbol_literal       ::= simple_symbol | quoted_symbol
simple_symbol        ::= ':' simple_id
quoted_symbol        ::= simple_quoted_symbol | interpolable_symbol
simple_quoted_symbol ::= ':'' {string_element} '''
interpolable_symbol  ::= ':"' {int_string_element} '"'
\end{lstlisting}

Symbol literals are members of the type \lstinline@Symbol@. They differ from \nameref{sec:stringliterals} in the way runtime handles them: while there may be multiple instances of the same string, there is always up to one instance of the same symbol. Unlike in Ruby, they do get released from memory when no code references to them anymore, so their object id (sometimes) varies with time. Coral does not require their ids to be constant in time. 

\subsection{Type Parameters}\label{sec:typeparameterliterals}

\syntax\begin{lstlisting}[mathescape=false]
type_param ::= '$' (simple_id | constant_id)
\end{lstlisting}

Type parameters are not members of any type, rather they stand-in for a real type, like a variable which only holds types. 

\subsection{Regular Expression Literals}\label{sec:regexpliterals}

\syntax\begin{lstlisting}
regexp_literal ::= '%/' regexp_content_int '/' [regexp_flags]
	| '%r/' regexp_content_int '/' [regexp_flags]
	| '%r#' regexp_content '#' [regexp_flags]
	| '%r~' regexp_content_int '~' [regexp_flags]
regexp_content_int ::= regexp_element_int {regexp_element_int}
regexp_element_int ::= string_element | int_string_element
regexp_content ::= string_element {string_element}
\end{lstlisting}

Regular expression literals are members of the type \lstinline@Regular_Expression@ with alias of \lstinline@Regexp@. 

\subsection{Collection Literals}\label{sec:collectionliterals}

Collection literals are paired syntax tokens and as such, they are a kind of parentheses in Coral sources. 

\syntax\begin{lstlisting}
collection_literal ::= tuple_literal
	| list_literal
	| dictionary_literal
	| bag_literal
tuple_literal ::= '(' exprs ')'
list_literal ::= '%' collection_flags '[' exprs ']'
dictionary_literal ::= '%' collection_flags '{' dict_exprs '}'
bag_literal ::= '%' collection_flags '(' exprs ')'
exprs ::= expr {',' expr}
dict_exprs ::= dict_expr {',' dict_expr}
dict_expr ::= expr '=>' expr
	| simple_id ':' expr
collection_flags ::= printable_char {printable_char}
\end{lstlisting}

Tuple literals are members of the \lstinline@Tuple@ type family. List literals are members of the \lstinline@List@ type, usually \lstinline@Array_List@ with alias of \lstinline@Array@. Dictionary literals are members of the \lstinline@Dictionary@ type with alias of \lstinline@Map@, usually \lstinline@Hash_Dictionary@ with alias of \lstinline@Hash_Map@. Bag literals are members of the \lstinline@Bag@ type, usually \lstinline@Hash_Bag@ or \lstinline@Hash_Set@. Collection flags may change the actual class of the literal, along with some other properties, described in the following text. 

List literal collection flags: 

\begin{enumerate}
\item Flag \lstinline@i@ = \textbf{i}mmutable, makes the list frozen. 
\item Flag \lstinline@l@ = \textbf{l}inked, makes the list a member of \lstinline@Linked_List@. 
\item Flag \lstinline@w@ = \textbf{w}ords, the following expressions are treated as words, converted to strings for each word separated by whitespace. 
\end{enumerate}

Dictionary literals collection flags:

\begin{enumerate}
\item Flag \lstinline@i@ = \textbf{i}mmutable, makes the dictionary frozen. 
\item Flag \lstinline@l@ = \textbf{l}inked, makes the dictionary a member of \lstinline@Linked_Hash_Dictionary@ (also has alias \lstinline@Linked_Hash_Map@).
\item Flag \lstinline@m@ = \textbf{m}ulti-map, the dictionary items are then either the items themselves, if there is only one for a particular key, or a set of items, if there is more than one item for a particular key. The dictionary is then a member of \lstinline@Multi_Hash_Dictionary@ (alias \lstinline@Multi_Hash_Map@) or \lstinline@Linked_Multi_Hash_Dictionary@ (alias \lstinline@Linked_Multi_Hash_Map@). 
\end{enumerate}

Bag literal collection flags:

\begin{enumerate}
\item Flag \lstinline@i@ = \textbf{i}mmutable, makes the bag frozen. 
\item Flag \lstinline@s@ = \textbf{s}et, the collection is a set instead of a bag (a specific bag, such that for each item, its tally is always $0$ or $1$, thus each item is in the collection up to once). 
\item Flag \lstinline@l@ = \textbf{l}inked, makes the collection linked, so either a member of \lstinline@Linked_Hash_Bag@ in case of a regular bag, or \lstinline@Linked_Hash_Set@ in case of a set. 
\end{enumerate}

Linked collections have a predictable iteration order in case of bags and dictionaries, or are simply stored differently in case of lists.  

\section{Whitespace \& Comments}\label{sec:whitespacecomments}

Tokens may be separated by whitespace characters and/or comments. Comments come in two forms: 

A single-line comment is a sequence of characters that starts with \lstinline@//@ and extends to the end of the line. 

A multi-line comment is a sequence of characters between \lstinline@/*@ and \lstinline@*/@. Multi-line comments may be nested. 

Documentation comments are multi-line comments that start with \lstinline@/*!@. 

\chapter{Identifiers, Names \& Scopes}

Names in Coral identify various types, values, methods and constants, which are the \emph{entities}. Names are introduced by local definitions and declarations, inheritance, use clauses or module clauses, which are the \emph{bindings}. 

Bindings of different kinds have a different precedence defined on them: 

\begin{enumerate}
\item Definitions and declarations that are local have the highest precedence. 
\item Explicit \lstinline@use@ clauses (imports) have the next highest precedence.\footnote{Explicit imports have such high precedence in order to allow binding of different names than those that would be otherwise inherited.} 
\item Inherited definitions and declarations have the next highest precedence. 
\item Definitions and declarations made available by module clause have the next highest precedence. 
\item Definitions and declarations that are not in the same compilation unit (a different script or a different module) have the next highest precedence. 
\item Definitions and declarations that are not bound have the lowest precedence. This happens when the binding simply can't be found anywhere, and probably will result in a name error (if not resolved dynamically), while being inferred to be of type \lstinline@Object@. 
\end{enumerate}

There is only one root name space, in which a single fully-qualified binding designates always up to one entity. 

Every binding has a \emph{scope} in which the bound entity can be referenced using a simple name (unqualified). Scopes are nested, inner scopes inherit the same bindings, unless shadowed. A binding in an inner scope \emph{shadows} bindings of lower precedence in the same scope (and nested scopes) as well as bindings of the same or lower precedence in outer scopes. Shadowing is a partial order, and bindings can become ambiguous -- fully qualified names can be used to resolve binding conflicts. This restriction is checked in limited scope during compilation\footnote{This is due to the hybrid typing system in Coral, to make use of all the available information as soon as possible.} and fully in runtime. 

If at any point of the program execution a binding would change (e.g., by introducing a new type in a superclass that is closer in the inheritance tree to the actual class than the previous binding), and such a change would be incompatible with the previous binding, then a warning\footnote{TBD -- shouldn't that be an error?} will be issued by the runtime. Also, if a new binding would be ambiguous\footnote{Coral runtime actually checks for bindings until the binding-candidate would not be able to shadow the already found binding-candidates and caches the result.}, then it is an error. 

As shadowing is only a partial order, in a situation like

\begin{lstlisting}
var x := 1
use p::x
x
\end{lstlisting}

neither binding of $x$ shadows the other. Consequently, the reference to $x$ on the third line above is ambiguous and the compiler will happily refuse to proceed. 

A reference to an unqualified identifier $x$ is bound by a unique binding, which

\begin{enumerate}
\item defines an entity with name $x$ in the same scope as the identifier $x$, and
\item shadows all other bindings that define entities with name $x$ in that name scope.
\end{enumerate}

It is syntactically not an error if no such binding exists, thanks to the dynamic features of the language (unbound references are implicitly bound to the same scope and are resolved by dynamic method callbacks). The same applies to fully qualified bindings that don't resolve into any entity. However, it is an error if a binding is ambiguous or fails to get resolved dynamically.

If $x$ is bound by explicit \lstinline@use@ import clause, then the simple name $x$ is consided to be equivalent to the fully-qualified name to which $x$ is mapped by the import clause. If $x$ is bound by a definition or declaration, then $x$ refers to the entity introduced by that binding, thus the type of $x$ is the type of the referenced entity. 

\chapter{Types}

When we say \textit{type} in the context of Coral, we are talking about a blueprint of an entity, while the type itself is an entity. Every type in Coral is backed by a \textit{class}, which is an instance of the type \lstinline@Class@. 

We distinguish a few different properties of types in Coral. There are first-order types and type constructors, which take type parameters and yield new types. A subset of first-order types called \textit{value types} represents set of first-class values. Value types are either \textit{concrete} or \textit{abstract}. 

Concrete value types can be either a \textit{class type} (e.g. referenced with a type designator, referencing a class or maybe a mixin), or a \textit{compound type} representing an intersection of types, possibly with a refinement that further constrains the types of its members. Both class types and compound types may be bound to a constant, but only class types referencing a concrete class can be blueprints of values -- \textit{objects}. Compound types can only constrain bindings to a subset of other types. 

Non-value types capture properties of identifiers that are not values. For instance, a type constructor does not directly specify a type of values, but a type constructor, when applied to the correct type arguments, yields a first-order type, which may be a value type. Non-value types are expressed indirectly in Coral. In example, a method type is described by writing down a method signature, which is not a real type itself, but it creates a corresponding method type. 

\section{About Coral's Type System}

There are two main streams of typing systems out there -- statically typed and dynamically typed. Static typing in a language usually means that the language is compiled into an executable with a definite set of types and every operation is type checked. Dynamic typing means that these checks are deferred until needed, in runtime. 

Let's talk about Java. Java uses static typing -- but, in a very limited and unfriendly way, you may use class loaders and a lot of type casts to dynamically load a new class. And then possibly endure a lot of pain using it. 

Let's talk about Ruby. Ruby uses dynamic typing -- but, using types blindly can possibly lead to some confusion. Ruby is amazing though, because you can write programs with it really fast and enjoy the process at the same time. But when it comes to type safety, you need to be careful. 

And now, move on to Coral. Coral uses hybrid typing. In its core, it uses dynamic typing all the way. But, it allows to opt-in for some limited static typing\footnote{This feature is expected to be gradually improved and un-limited.}. Unlike in Ruby, you can overload methods (not just override!). You can constrain variables, constants, properties, arguments and return types to particular types. But you don't have to. Types in Coral were heavily inspired by Scala's type system, but modified for this dynamic environment that Coral provides. Unlike in Ruby, you can have pure interfaces (called protocols\footnote{Interfaces in Coral are used to extract the \textit{public interface} of classes in modules, so that only a small amount of code may be distributed along with the module to allow binding to it.}), or interfaces with default method implementations (similar to Java 8). Unlike in Java, you can have mixins, union types and much more. Unlike in Java, you may easily modify classes, even from other modules (\textit{pimp my library!}). You may even easily add more classes if needed, and possibly shadow existing ones. In face of static typing in Coral, \textit{no type} specified is saying that the value is of any type. 

While Coral is so dynamic, it also needs to maintain stability and performance. Therefore, it ``caches'' its bindings and tracks versions of each type\footnote{Versions are simply integers that are incremented with each significant change to the type and distributed among its subtypes.}. If a \textit{cached binding} would change, it is ok -- as long as the new binding would conform to the old one. Practically, the code that executes first initiates the binding -- first to come, first to bind. Bindings are also cached, so that the Coral interpreter does not need to traverse types all the time -- it only does so if the needed binding does not exist (initial state), or if the cached version does not match the actual version of the bound type. This mechanism is also used for caching methods, not only types. Moreover, this mechanism ensures that type projections (\sref{sec:type-projection}) are valid at any time of execution, even if their binding changes. 

Types in Coral are represented by objects that are members of the \code{Class} type. 

\section{Paths}
\label{sec:type-paths}

\syntax\begin{lstlisting}
Path             ::= Stable_Id
                   | 'this'
                   | [constant_id '#'] 'self'
Stable_Id        ::= constant_id
                   | ['::'] Path '::' constant_id
                   | [constant_id '#'] 'super' [Class_Qualifier] 
                      '::' constant_id
Class_Qualifier  ::= '[' constant_id ']'
\end{lstlisting}

Paths are not types themselves, but they can be a part of named types and in that function form a role in Coral's type system. 

A path is one of the following: \footnote{This section might need a review of what a path is, since we claim that the referenced entity is a member, yet the syntax only mentions \code{constant_id}.}

\begin{itemize}
\item 
The empty path $\epsilon$ (which can not be written explicitly in user programs). 

\item 
\code{this}, which references the directly enclosing class. 

\item 
\lstinline@$C$#self@, where $C$ references a class or a mixin. The path \code{self} is taken as a shorthand for \lstinline@$C$#self@, where $C$ is the name of the class directly enclosing the reference. 

\item 
\lstinline@$p$::$x$@, where $p$ is a path and $x$ is a member of $p$. Additionally, $p$ allows modules to appear instead of references to classes or mixins, but no module reference can follow a class or a mixin reference: \lstinline@{module_ref '::'} {(class_ref|mixin_ref) '::'} …@. 

\item
\lstinline@$C$#super::$x$@ or \lstinline@$C$#super[$M$]::$x$@, where $C$ references a class or a mixin and $x$ references a member of the superclass or designated parent class $M$ of $C$. The prefix \code{super} is taken as a shorthand for \lstinline@$C$#super@, where $C$ is the name of the class directly enclosing the reference, and \lstinline@super[$M$]@ as a shorthand for \lstinline@$C$#super[$M$]@, where $C$ is yet again the name of the class directly enclosing the reference. 
\end{itemize}

\section{Value Types}

Every value in Coral has a type which is of one of the following forms. 

\subsection{Value \& Singleton Type}
\label{sec:value-types}
\label{sec:singleton-types}

\syntax\begin{lstlisting}
Simple_Type ::= Path '#' 'type'
Simple_Type ::= Path '#' 'singleton-type'
\end{lstlisting}

A singleton type is of the form \lstinline@$p$#singleton-type@ and a special type that denotes the set of values consisting of \code{nil} and the value denoted by $p$. A value type, on the other hand, is a special type that denotes the set of values consisting of \code{nil} and every value that conforms to the type of value denoted by $p$.\footnote{This is useful when using a value as prototype of new values.}

\subsection{Type Projection}
\label{sec:type-projection}

\syntax\begin{lstlisting}
Simple_Type ::= Simple_Type '#' constant_id
\end{lstlisting}

A type projection \lstinline@$T$#$x$@ references type member named $x$ of type $T$. \footnote{Type projection operator \lstinline@#@ is a language construct and can't be overridden by user programs. There is a similarity between this construct and the \lstinline@::@ scope operator. The difference is, type projection operator is expected to be rarely needed, but it does provide a type projection and can refer in a stable way to a type of anything. Scope operator, on the other hand, does not care about types, it merely resolves a member of a particular expression at runtime.}

\subsection{Type Designators}

\syntax\begin{lstlisting}
Simple_Type ::= Stable_Id
\end{lstlisting}

A type designator refers to a named value type. It can be simple or qualified. All such type designators are shorthands for type projections. 

Specifically, the unqualified type name $t$ where $t$ is bound in some class, object or module $C$ is taken as a shorthand for \lstinline@$C$#self#type#$t$@. If $t$ is not bound in a class, object or module, then $t$ is taken as a shorthand for \lstinline@$\epsilon$#type#$t$@. 

A qualified type designator has the form \lstinline@$p$::$t$@, where $p$ is a path (\sref{sec:type-paths}) and $t$ is a type name. Such a type designator is equivalent to the type projection \lstinline@$p$#type#$t$@. 

\subsection{Parameterized Types}
\label{sec:parameterized-types}

\syntax\begin{lstlisting}
Simple_Type ::= Simple_Type Type_Args
Type_Args   ::= ':[' Types ']'
Types       ::= Type {',' Type}
\end{lstlisting}

A parameterized type\footnote{The `\lstinline@:[@' and `\lstinline@]@' token pairs were selected after many considerations. The original idea was to use the same pair as Java or C\#: `\lstinline@<@' and `\lstinline@>@', but this has the drawback of injecting an exception into the parser. Then Scala's `\lstinline@[@' and `\lstinline@]@' were considered, but they kind of collide with an operator that uses the same pair and therefore expressions could become ambiguous. Finally an idea emerged to use `\lstinline@:[@' and `\lstinline@]@', since the `\lstinline@:@' in it hints that it is related to the type system, and `\lstinline@[@' and `\lstinline@]@' lack the drawbacks of `\lstinline@<@' and `\lstinline@>@' (collision with comparison operators).} $T:[T_1 \commadots T_n]$ consists of a type designator $T$ and type parameters $T_1 \commadots T_n$, where $n \geq 1$. $T$ must refer to a type constructor which takes exactly $n$ type parameters $a_1 \commadots a_n$. 

Say the type parameters have lower bounds $L_1 \commadots L_n$ and upper bounds $U_1 \commadots U_n$. The parameterized type is well-formed if each actual type parameter {\em conforms to its bounds}, so that $L_i <: \sigma a_i <: U_i$, where $\sigma$ is the substitution $[a_1 := T_1 \commadots a_n := T_n]$. Also, $U_i$ must never be a subtype of $L_i$, since no other type ever would be able to fulfil the bounds ($U_i$ and $L_i$ may be the exact same type though, but in that case the type parameter would be invariant and the whole point of having a parameterized type would be useless). 

\example
\label{example:parameterized-types}
Given the generic type definitions: 

\begin{lstlisting}[escapechar=@]
class Tree_Map:[@\$@A <: Comparable:[@\$@A], @\$@B] $\ldots$ end
class List:[@\$@A] $\ldots$ end
class I; implements Comparable:[I]; $\ldots$ end

class F:[@\$@M:[_], @\$@X] $\ldots$ end
class S:[@\$@K <: String] $\ldots$ end
class G:[@\$@M:[@\$@Z <: @\$@I], @\$@I] $\ldots$ end
\end{lstlisting}

the following parameterized types are well-formed: 

\begin{lstlisting}
Tree_Map:[I, String]
List:[I]
List:[List:[Boolean]]

F:[List, Number]
G:[S, String]
\end{lstlisting}

\example
\label{example:parameterized-types-mal}

Given the type definitions of the previous example, the following types are malformed: 

\begin{lstlisting}
Tree_Map:[I]               // wrong number of parameters
Tree_Map:[List:[I], Number] // type parameter List not within bound

F:[Number, Boolean]        // Number is not a type constructor
F:[Tree_Map, Number]       // Tree_Map takes two parameters, 
                          //   F expects a type constructor taking one

G:[S, Number]              // type S constrains its parameter to
                          //   conform to String, 
                          // G expects type constructor with a parameter
                          //   that conforms to Number
\end{lstlisting}

\subsection{Tuple Types}

\syntax\begin{lstlisting}
Simple_Type ::= '(' Types ')'
\end{lstlisting}

A tuple type ($T_1 \commadots T_n$) is an alias for the class \lstinline@Tuple_$n$:[$T_1 \commadots T_n$]@, where $n \geq 2$. 

Tuple classes are available as patterns for pattern matching. The properties can be accessed as methods \lstinline@[1]$ \commadots $[$n$]@ (using an ``offset'' that is outside of the tuple's size results in a method-not-found error, not offset-out-of-bounds -- tuple classes do not implement the operator \lstinline@[i]@ for arbitrary $i$). 

Tuple classes are generated lazily by the runtime as needed, so that the language does not constrain users to tuples of only limited sizes, but allows any size. 

An effort will be made to introduce a simple enough syntax for variable parameterized types, if possible, until then, \lstinline@Tuple_$i$@ are the only such types. 

\subsection{Annotated Types}

\syntax\begin{lstlisting}
Annot_Type ::= {Annotation} Simple_Type
\end{lstlisting}

An annotated type $a_1 \ldots a_n T$ attaches annotations $a_1 \commadots a_n$ to the type $T$. % TBD: add ref to a chapter about annotations.

\subsection{Compound Types}
\label{sec:compound-types}

\syntax\begin{lstlisting}
Compound_Type ::= Annot_Type {'with' Annot_Type} [Refinement]
                | Refinement
Refinement    ::= 'refine' '{' Refine_Stat {semi Refine_Stat} '}'
\end{lstlisting} % TBD: define Refine_Stat syntax

A compound type \lstinline@$T_1$ with $\ldots$ with $T_n$ {$R$}@ represents values with members as given in the component types $T_1 \commadots T_n$ and the refinement \lstinline@{$R$}@. A refinement \lstinline@{$R$}@ contains declarations and type definitions. 

If no refinement is given, the type is implicitly equivalent to the same type having an empty refinement. 

A compound type may also consist of just a refinement \lstinline@{$R$}@ with no preceding component types -- such a type has an implicit component type \code{Object} and describes the member values as ``any value, as long as it has what the refinement requires'', thus it works like an anonymous protocol. 

\subsection{Function Types}
\label{sec:function-types}

\syntax\begin{lstlisting}
Type          ::= [Function_Args {'->' Function_Args}] 
                '->' Return_Type
Function_Args ::= Type
                | '(' [Type {',' Type}] ')'
Return_Type   ::= Type | '()'
\end{lstlisting}

The type \lstinline@($T_1 \commadots T_n$) -> $R$@ represents the set of function values that take arguments of types $T_1 \commadots T_n$ and yield results of type $R$. In the case of exactly one argument, type \lstinline@$T$ -> $R$@ is a shorthand for \lstinline@($T$) -> $R$@. Empty arguments list is indeed also possible as \lstinline@-> $R$@, equivalent to \lstinline@() -> $R$@.

Function types associate to the right, e.g. \lstinline@($S$) -> ($T$) -> $R$@ is the same as \lstinline@($S$) -> (($T$) -> $R$)@. 

Function types are shorthands for class types that conform to the \lstinline@Function_$i$@ protocol -- i.e. having an \code{apply} function or simply {\em being} a function. The $n$-ary function type \lstinline@($T_1 \commadots T_n$) -> $R$@ is a shorthand for the protocol \lstinline@Function_$n$:[$T_1 \commadots T_n,R$]@. Such protocols are defined in the Coral library for any $n \ge 0$:

\begin{lstlisting}[escapechar=`]
protocol Function_$n$:[-`\$`$T_1 \commadots$ -`\$`$T_n$, +`\$`$R$]
  message apply ($x_1$ : `\$`$T_1 \commadots x_n$ : `\$`$T_n$): `\$`$R$
  $\ldots$
end protocol
\end{lstlisting}

Function types are covariant in their result type and contravariant in their argument types (\sref{sec:variance-of-type-parameters}).

\subsection{Existential Types}
\label{sec:existential-types}

\syntax\begin{lstlisting}[escapechar=@]
Type                ::= Compound_Type Existential_Clauses
Existential_Clauses ::= {'for-some' '{' Existential_Dcl
                        {semi Existential_Dcl} '}'}
Existential_Dcl     ::= 'type' Type_Dcl
\end{lstlisting}

An existential type has the form \lstinline@$T$ for-some {$Q$}@, where $Q$ is a sequence of type declarations. Let \lstinline@$t_1$:[$tps_1$] >: $L_1$ <: $U_1$ $\commadots$ $t_n$:[$tps_n$] >: $L_n$ <: $U_n$@ be the types declared in $Q$. 

A {\em type instance} of \lstinline@$T$ for-some {$Q$}@ is a type $\sigma T$, where $\sigma$ is a substitution over $t_1 \commadots t_n$, such that for each $i$, \lstinline@$L_i$ <: $t_i$ <: $U_i$@. The set of values denoted by the existential type \lstinline@$T$ for-some {$Q$}@ is the union of the set of values of all its type instances. 

\section{Non-Value Types}

The types explained in the following paragraphs do not appear explicitly in programs, they are internal and do not represent any type of value directly. 

\subsection{Method Types}
\label{sec:method-types}

A method type is denoted internally as $(Ps) \mapsto R$, where $(Ps)$ is a sequence of parameter names, types and extra properties $(ep_1 : T_1 \commadots ep_n : T_n)$ for some $n \geq 0$ and $R$ is a (value or method) type. This type represents named or anonymous methods that take arguments named $p_1 \commadots p_n$ of types $T_1 \commadots T_n$, have extra properties $e$ and return a result of type $R$. Names of parameters are either simple identifiers (for positional argument passing) or symbol literals (\sref{sec:symbolliterals}, for named arguments passing -- they make difference between method types with possibly same parameter types, therefore the name is a part of the method type along with the associated parameter type\footnote{This means that, for simplicity, if we have a method with one parameter, which is a named parameter, represented by having its name expressed with a symbol literal, and the parameters have an equivalent type, but different names, the method types are not equivalent.}). 

Method types associate to the right:\footnote{Like in Haskell or Scala.} \newline
$(Ps_1) \mapsto (Ps_2) \mapsto R$ is treated as $(Ps_1) \mapsto ((Ps_2) \mapsto R)$. 

A special case are types of methods without any parameters. They are written here as $() \mapsto R$. 

Another special case are types of methods without any return type. They are written here as $(Ps) \mapsto ()$. Methods that have this return type do not have an implicit return expressions and an attempt to return a value from it results in a compile-time error.\footnote{A compile-time error like this may happen during a runtime evaluation as well.}

Method types do not exist as types of values. If a method name is used as a value, its type is implicitly converted to a corresponding function type (\sref{sec:function-types}). 

Extra properties of parameters are as follows: a \lstinline@*@ for variable arguments, \lstinline@**@ for any named arguments and \lstinline@&@ for a captured block argument, or nothing for regular parameters. 

\example The declarations
\begin{lstlisting}
def a: -> Integer // or def a () -> Integer
def b (x : Integer): Boolean
def c (x : Integer): (y : String, z : String) -> String
def d (:x : Integer): Integer
def e (*x : Integer): Integer
def f (Integer): ()
def g (Integer)(Integer): Integer
def h (Integer): (Integer) -> Integer
\end{lstlisting}
produce the typings
\begin{lstlisting}
a : () $\mapsto$ Integer
b : (Integer) $\mapsto$ Boolean
c : (Integer) $\mapsto$ (String, String) $\mapsto$ String
d : (:x Integer) $\mapsto$ Integer
e : (*Integer) $\mapsto$ Integer
f : (Integer) $\mapsto$ ()
g : (Integer) $\mapsto$ (Integer) $\mapsto$ Integer
g : (Integer) $\mapsto$ (Integer) $\mapsto$ Integer
\end{lstlisting}

The difference between the ``\code{g}'' and ``\code{h}'' functions is that using the chain of return types as in function ``\code{g}'', the function body is automatically curried to return a function that is of type \lstinline@(Integer) $\mapsto$ Integer@. With the function ``\code{h}'', currying has to be implemented manually. 

\subsection{Polymorphic Method Types}
\label{sec:polymorphic-method-types}

A polymorphic method type is the same as a regular method type, but enhanced with a type parameters section. It is denoted internally as \lstinline@:[$tps$]$ \mapsto T$@, where \lstinline@:[$tps$]@ is a type parameter section \lstinline@:[$a_1$ >: $L_1$ <: $U_1$ $\commadots$ $a_n$ >: $L_n$ <: $U_n$]@ for some $n \geq 0$ and $T$ is a (value or method) type. This type represents (only\footnote{Not anonymous.}) named methods that take type arguments $S_1 \commadots S_n$, for which the lower bounds $L_1 \commadots L_n$ conform (\sref{sec:conformance}) to the type arguments and the type arguments conform and the upper bounds $U_1 \commadots U_n$ and that yield results of type $T$. No explicit lower bound implies \code{Nothing} to be the corresponding lower bound, no explicit upper bound implies \code{Object} to be the corresponding upper bound. As usual, lower bound must conform to the corresponding upper bound. 

\example The declarations
\begin{lstlisting}[escapechar=@,deletekeywords={union}]
def empty:[@\$@A]: List:[@\$@A]
def union:[@\$@A <: Comparable:[@\$@A]] (x : Set:[@\$@A], 
         xs : Set:[@\$@A]): Set:[@\$@A]
\end{lstlisting}
produce the typings
\begin{lstlisting}[escapechar=@,deletekeywords={union}]
empty : :[@\$@A >: Nothing <: Object] () $\mapsto$ List:[@\$@A]
union : :[@\$@A >: Nothing <: Comparable:[@\$@A]] (Set:[@\$@A], 
        Set:[@\$@A]) $\mapsto$ Set:[@\$@A]
\end{lstlisting}

\subsection{Type Constructors}
\label{sec:type-constructors}

A type constructor is in turn represented internally much like a polymorphic method type. \lstinline@:[$\pm a_1$ >: $L_1$ <: $U_1 \commadots \pm a_n$ >: $L_n$ <: $U_n$] $\mapsto T$@ represents a type that is expected by a type constructor parameter. The difference is that the represented internal entity is not a method, but a type, creating higher-kinded types. 

\section{Relations Between Types}

We define two relations between types. 
\begin{quote}\begin{tabular}{l@{\gap}l@{\gap}l}
\em Type equivalence & $T \equiv U$ & $T$ and $U$ are interchangeable
in all contexts.
\\
\em Conformance & $T \conforms U$ & Type $T$ conforms to type $U$.
\end{tabular}\end{quote}

\subsection{Type Equivalence}

Equivalence ($\equiv$) between types is the smallest congruence, such that the following statements are true:

\begin{itemize}
\item
If $t$ is defined by a type alias \lstinline@type t is T@, then $t$ is equivalent to $T$. 

\item
If a path $p$ has a singleton type \lstinline@$q$#singleton-type@, then \lstinline@$p$#singleton-type $\equiv$ $q$#singleton-type@. 

\item
Two compound types (\sref{sec:compound-types}) are equivalent, if the sequences of their components are pairwise equivalent, occur in the same order and their refinements are equivalent.

\item 
Two refinements (\sref{sec:compound-types} \& TBD: named refinements) are equivalent, if they bind the same names and the modifiers, types and bounds of every declared entity are equivalent in both refinements. Two equivalent refinements, both or one attached to a compound type, do not imply the compound types to be equivalent. This applies to both anonymous and named refinements. 

\item
Two method types (\sref{sec:method-types}) are equivalent, if they have equivalent return types, both have the same number of parameters and corresponding parameters have equivalent types and extra properties. Names of parameters matter for method type equivalence only with named parameters. 

\item
Two polymorphic method types (\sref{sec:polymorphic-method-types}) are equivalent, if they have the same number of type parameters, the return types are equivalent as well as lower and upper bounds of corresponding type parameters. 

\item
Two existential types (\sref{sec:existential-types}) are equivalent, if they have the same number of quantifiers and the quantified types as well as lower and upper bounds of corresponding quantifiers are equivalent. 

\item
Two type constructors (\sref{sec:type-constructors}) are equivalent, if they have the same number of type parameters, the return types are equivalent as well as variances, lower and upper bounds of corresponding type parameters. 

\end{itemize}

\subsection{Conformance}
\label{sec:conformance}

The conformance relation $(\conforms)$ is the smallest transitive relation that satisfies the following conditions:

\begin{itemize}

\item
Conformance includes equivalence, therefore if $T \equiv U$, then \lstinline@$T \conforms U$@. 

\item
For every value type $T$, \lstinline@Nothing $\conforms T \conforms$ Object@. 

\item
For every type constructor $T$ with any number of type parameters, \lstinline@Nothing $\conforms T \conforms$ Object@. 

\item
A type variable $t$ conforms to its upper bound and its lower bound conforms to $t$. 

\item
A class type or a parameterized type conforms to any of its base types. 

\end{itemize}

\subsection{Weak Conformance}

For now, {\em weak conformance} is a relation defined on members of the \code{Number} type as a relaxation of conformance. The relation is simple: a type $t$ weakly conforms to another type $u$ when $u$'s size contains all values of $t$ (we say that $t$ can be converted to $u$ without precision loss). 

Whether weak conformance will be available to be defined by users is up to further investigation. 

\chapter{Basic Declarations \& Definitions}

\syntax\begin{lstlisting}
Dcl         ::= [Val_Mod] 'val' Val_Dcl
              | 'var' Var_Dcl
              | 'def' Def_Dcl
              | 'type' Type_Dcl
Pat_Var_Def ::= [Val_Mod] 'val' Pat_Def
              | 'var' Var_Def
              | 'let' ['!'] Let_Def
Def         ::= Pat_Var_Def
              | 'def' Fun_Def
              | 'type' Type_Def
\end{lstlisting}

A {\em declaration} introduces names and assigns them types. Using another words, declarations are abstract members, working sort of like header files in C. 

A {\em definition} introduces names that denote terms or types. Definitions are the implementations of declarations. 

Both declarations and definitions produce {\em bindings} that associate type names with type definitions or bounds, and that associate term names with types. 

Even more simply put, declarations declare a binding with a type (or type-less), and definition defines the term behind that binding (along with the binding). 

% TBD: differences between val, var, def, type, let
% val: values, immutable variables, patterns, lazy values, constant values, parameterless functions that return a value
% var: mutable variables, patterns
% def: functions
% type: types, aliases
% let: immutable values, patterns
% let!: immutable values (see async...)

\section{Value Declarations \& Definitions}
\label{sec:value-dcl-def}

A value declaration \lstinline@val $x$ : $T$@ introduces $x$ as a name of a value of type $T$. May appear in any block of code and an attempt to use it prior to initialisation with a value is an error. More specifically, a value declaration \lstinline+val @$x$ : $T$+ introduces $x$ as a name of an instance value of type $T$, and a value declaration \lstinline+val @@$x$ : $T$+ introduces $x$ as a name of a class instance value of type $T$. 

A value definition \lstinline@val $x$ : $T$ := $e$@ defines $x$ as a name of the value that results from evaluation of expression $e$.

A value in this sense\footnote{Everything in Coral is a value -- remember, Coral is also a functional language, to some extent.} is an immutable variable. A declared value can be assigned just once\footnote{A similar way that \lstinline[language=Java]@final@ variables or members in Java can be assigned just once, but Java furthermore requires that this assignment will happen in every code path, Coral does not impose such requirement.}, a defined value is already assigned from its definition. 

The value type $T$ may be always omitted, in that case the type is inferred and bound to the name. If a type $T$ is omitted, the type of expression $e$ is assumed. If a type $T$ is given, then $e$ is expected to conform to it (\sref{sec:conformance}). 

Evaluation of the value definition implies evaluation of its right-hand side $e$, unless it has a modifier \code{lazy} -- in that case, evaluation is deferred to the first time the value is accessed. 

A {\em lazy value} is of the form
\begin{quote}\begin{lstlisting}
lazy val $x$ : $T$ := $e$
\end{lstlisting}\end{quote}

A lazy value may only be defined, and a value of the same name (binding) may be declared prior to the value definition, but never as a lazy value. 

The effect of the value definition is to bind $x$ to the value of $e$ converted to type $T$. 

A {\em constant value definition} is of the form 
\begin{quote}\begin{lstlisting}
let $x$ : $T$ := $e$
\end{lstlisting}\end{quote}
where $e$ is an expression that is supposed to be treated as constant in the same block from its occurrence on. Values defined with \code{let} have certain limitations and properties:

\begin{enumerate}
\item They can't use patterns as a name. 
\item They can't be lazy. 
\item They can't be used in a declaration, only in a definition. 
\item They can be used to redefine a variable (the name is then treated as a new binding in the scope). 
\item They can't define (class) instance variables. 
\item They can be used in workflows (\sref{sec:workflows}).\footnote{A pragma that would turn all values into lazy values might exist, and lazy values should never appear in workflows, so that's why \code{val} should not be allowed in workflows.}
\end{enumerate}

The type $T$ may be omitted. 

Value declarations \& definitions with the type $T$ omitted are of the form
\begin{quote}\begin{lstlisting}
val $x$
val @$x$
val @@$x$
val $x$ := $e$
val @$x$ := $e$
val @@$x$ := $e$
let $x$ := $e$
\end{lstlisting}\end{quote}

A value declaration without any type is basically only declaring the name, so that a binding is introduced and the actual value is for another code to define.\footnote{Usually, that another code should be a \code{constructor} or the class-level block in another file, maybe.}

A value definition can alternatively have a pattern (\sref{sec:patterns}) as left-hand side (the name). If $p$ is a pattern other than a simple name or a name followed by a colon and a type, then the value definition \lstinline@val $p$ := $e$@ is expanded as follows: 

\begin{enumerate}
\item
If the pattern $p$ has bound variables $x_1 \commadots x_n$ for some $n > 1$:
\begin{lstlisting}[escapechar=@]
val $x$@\$@ := match $e$
  when $p$ then ($x_1 \commadots x_n$)
end match
val $x_1$ := $x$@\$@[$1$]
$\ldots$
val $x_n$ := $x$@\$@[$n$]
\end{lstlisting}

\item
If $p$ has exactly one unique bound variable $x$:
\begin{lstlisting}
val $x$ := match $e$
  when $p$ then $x$
end match
\end{lstlisting}

\item
If $p$ has no bound variables:
\begin{lstlisting}
match $e$
  when $p$ then ()
end match
\end{lstlisting}
\end{enumerate}

\example The following are examples of value definitions. 

\begin{lstlisting}
val pi := 3.14159
val pi : Double := 3.14159
val Some(x) := f()
val x ~> xs := my_list
\end{lstlisting}

The last two definitions have the following expansions:

\begin{lstlisting}[escapechar=@]
val x := match f()
  when Some(x) then x
end match

val x@\$@ := match my_list
  when x ~> xs then (x, xs)
end match
val x := x@\$@[1]
val xs := x@\$@[2]
\end{lstlisting}

The name of any declared or defined value must not end with \lstinline@=@. 

A value declaration ~\lstinline@val $x_1 \commadots x_n$ : $T$@~ is a shorthand for the sequence of value declarations ~\lstinline@val $x_1$ : $T$; $\ldots$; val $x_n$ : $T$@. A value definition ~\lstinline@val $p_1 \commadots p_n$ := $e$@~ is a shorthand for the sequence of value definitions ~\lstinline@val $p_1$ := $e$; $\ldots$; val $p_n$ := $e$@. A value definition ~\lstinline@val $p_1 \commadots p_n : T$ := $e$@~ is a shorthand for the sequence of value definitions ~\lstinline@val $p_1 : T$ := $e$; $\ldots$; val $p_n : T$ := $e$@.

\section{Variable Declarations \& Definitions}
\label{sec:variable-dcl-def}

A variable declaration \lstinline@var $x$ : $T$@ introduces a mutable variable without a defined initial value of type $T$. More specifically, \lstinline+var @$x$ : $T$+ introduces a mutable instance variable of type $T$ and \lstinline+var @@$x$ : $T$+ introduces a mutable class instance variable of type $T$. 

A variable definition \lstinline@val $x$ : $T$ := $e$@ defines $x$ as a name of the value that results from evaluation of expression $e$. The type $T$ can be omitted, in that case the type of expression $e$ is assumed, but not bound to the variable -- the variable is only bound to \code{Object} then. If the type $T$ is given, then $e$ is expected to conform to it (\sref{sec:conformance}), as well as every future value of the variable. 

Variable definitions can alternatively have a pattern (\sref{sec:patterns}) as their left-hand side. A variable definition \lstinline@var $p$ := $e$@, where $p$ is a pattern other than a simple name followed by a colon and a type, is expanded in the same way (\sref{sec:value-dcl-def}) as a value definition \lstinline@val $p$ := $e$@, except that the free names in $p$ are introduced as mutable variables instead of values. 

The name of any declared or defined variable must not end with \lstinline@=@. 

A variable declaration ~\lstinline@var $x_1 \commadots x_n$ : $T$@~ is a
shorthand for the sequence of variable declarations ~\lstinline@var $x_1$ : $T$; $\ldots$; var $x_n$ : $T$@. A variable definition ~\lstinline@var $x_1 \commadots x_n$ = $e$@~ is a shorthand for the sequence of variable definitions ~\lstinline@var $x_1$ := $e$; $\ldots$; var $x_n$ := $e$@. A variable definition ~\lstinline@var $x_1 \commadots x_n : T$ := $e$@~ is a shorthand for the sequence of variable definitions ~\lstinline@var $x_1 : T$ := $e$; $\ldots$; var $x_n : T$ := $e$@.

\section{Property Declarations \& Definitions}
\label{sec:property-dec-dfn}

\syntax\begin{lstlisting}
Prop_Dcl   ::= 'property' ['(' Prop_Specs ')'] simple_id 
             [':' Type]
Prop_Specs ::= Prop_Spec {',' Prop_Spec}
Prop_Spec  ::= ([Access_Modifier] ('get' | 'set')) | 'weak'
Prop_Def   ::= 'property' ['(' Prop_Specs ')'] simple_id 
             [':' Type]
             '{' Prop_Impl {semi Prop_Impl} '}'
Prop_Impl  ::= ('get' [Prop_Get_Impl])
             | ('set' [Prop_Set_Impl])
             | ('val' ':=' Expr)
             | ('var' ':=' Expr)
\end{lstlisting} % TBD: syntax of property implementations

A property declaration \lstinline@property $x$ : $T$@ introduces a property without a defined initial value of type $T$. Property declaration does not specify any actual implementation details of how or where the declared value is stored.

A property definition \lstinline@property $x$ : $T$ {get $\ldots$; set $\ldots$}@ introduces a property with a possibly defined initial value of type $T$. Property definition may specify implementation details of the behavior and storage of a property, but may as well opt-in for auto-generated implementation, which is: 

\begin{enumerate}
\item 
Storage of the property's value is in an instance variable (or a class instance variable in case of class properties) of the same name as is the name of the property: \lstinline@property $x$@ is stored in an instance variable \lstinline+@$x$+. 

\item
Properties defined with only \code{get} are stored in immutable instance variables (\sref{sec:value-dcl-def}). 

\item
Properties defined with \code{set}\footnote{It is also possible to declare/define properties that are \code{set}-only. That makes them {\em write-only}, as opposed to {\em read-only} properties with \code{get}-only.} are stored in mutable instance variables (\sref{sec:variable-dcl-def}). 

\item
Properties defined with \code{weak} are stored as weak references. A property \lstinline@property $x$ : $T$@ is stored in an instance of type \lstinline@Weak_Reference:[$T$]@. 

\end{enumerate}

Declaring a property $x$ of type $T$ is equivalent to declarations of a {\em getter function} $x$ and a {\em setter function} \lstinline@$x$=@, declared as follows:

\begin{lstlisting}
def $x$ (): $T$; end
def $x$= (y: $T$): (); end
\end{lstlisting}

Assignment to properties is translated automatically into a setter function call and reading of properties does not need any translation. 

\section{Type Declarations \& Aliases}

\syntax\begin{lstlisting}
Dcl      ::= 'type' Type_Dcl
Type_Dcl ::= constant_id [Type_Param_Clause] ['>:' Type] 
           ['<:' Type]
Def      ::= 'type' Type_Def
Type_Def ::= constant_id [Type_Param_Clause] ':=' Type
\end{lstlisting}

A {\em type declaration} \lstinline@type $t$:[$tps$] >: $L$ <: $U$@ declares $t$ to be an abstract type with lower bound type $L$ and upper bound type $U$. If the type parameter clause \lstinline@:[$tps$]@ is omitted, $t$ abstracts over first-order type, otherwise $t$ stands for a type constructor that accepts type arguments as described by the type parameter clause. 

A {\em type alias} \lstinline@type $t$ := $T$@ defines $t$ to be an alias name for the type $T$. Since---for type safety and consistence reasons---types are constant and can not be replaced by another type when bound to a constant name, type aliases are permanent. A type remembers the first given constant name, no alias can change that. The left hand side of a type alias may have a type parameter clause, e.g. \lstinline@type $t$:[$tps$] := $T$@. The scope of a type parameter extends over to the right hand side $T$ and the type parameter clause $tps$ itself. 

It is an error if a type alias refers recursively to the defined type constructor itself. 

\example The following are legal type declarations and aliases:
\begin{lstlisting}[escapechar=@]
type Integer_List := List:[Integer]
type T <: Comparable:[T]
type Two:[@\$@A] := Tuple_2:[@\$@A, @\$@A]
type My_Collection:[+@\$@X] <: Iterable:[@\$@X]
\end{lstlisting}

\section{Type Parameters}

\syntax\begin{lstlisting}
Type_Param_Clause  ::= ':[' Variant_Type_Param 
                     {',' Variant_Type_Param} ']'
Variant_Type_Param ::= {Annotation} ['+' | '-'] Type_Param
Type_Param         ::= (constant_id | '_') [Type_param_Clause]
                     ['>:' Type] ['<:' Type]
\end{lstlisting}

Type parameters appear in type definitions, class definitions and function definitions. 

The most general form of a first-order type parameter is ~\lstinline!@[$a_1$]$\ldots$@[$a_n]$ $\pm$ $t$ >: $L$ <: $U$!. $L$ is a lower bound and $U$ is an upper bound. These bounds constrain possible type arguments for the parameter. It is an error if $L$ does not conform to $U$.\footnote{This is sometimes detectable as soon as during compilation.} Then, $\pm$ is a {\em variance} (\sref{sec:variance-of-type-parameters}), i.e. an optional prefix of either \lstinline@+@ or \lstinline@-@. The type parameter may be preceded by one or more annotation applications (\sref{sec:annotated-exprs} \& \sref{sec:annotations}).

\example The following are some well-formed type parameter clauses:
\begin{lstlisting}[escapechar=`]
:[`\$`S, `\$`T]
:[@[Specialized] `\$`S, `\$`T]
:[`\$`Ex <: Raisable]
:[`\$`A <: Comparable:[`\$`B], `\$`B <: `\$`A]
\end{lstlisting}

% TBD! Not complete.

\section{Variance of Type Parameters}
\label{sec:variance-of-type-parameters}

Variance annotations indicate how instances of parameterised types relate with respect to subtyping (\sref{sec:conformance}). A ``\lstinline!+!'' variance indicates a covariant dependency, a ``\lstinline!-!'' variance indicates a contravariant dependency, and an empty variance indicates an invariant dependency. 

A variance annotation constrains the way the annotated type variable may appear in the type or class which binds the type parameter. 

% TBD! Far from complete, variance is a complex topic. 

\section{Function Declarations \& Definitions}

\syntax\begin{lstlisting}[escapechar=`]
Dcl           ::= 'def' Fun_Dcl 'end' ['def']
                | 'message' Fun_Dcl 'end' ['message']
                | 'function' Fun_Dcl 'end' ['function']
Fun_Dcl       ::= Fun_Sig ':' Type
Def           ::= 'def' Fun_Def 'end' ['def']
                | 'def' Fun_Alt_Def
                | 'method' Fun_Def 'end' ['method']
                | 'method' Fun_Alt_Def
                | 'function' Fun_Def 'end' ['function']
                | 'function' Fun_Alt_Def
Fun_Def       ::= Fun_Sig [':' Type] [Fun_Dec] semi Expr
Fun_Alt_Def   ::= Fun_Sig [':' Type] ':=' Expr
Fun_Dec       ::= [semi] 'declare' Expr [semi] 'begin'
Fun_Sig       ::= Function_Path [Fun_Tpc] Param_Clauses
Fun_Tpc       ::= ':[' Type_Param {',' Type_Param} ']'
Function_Path ::= function_id
                | 'self' '.' function_id
                | variable_id '.' function_id
Param_Clauses ::= {Param_Clause} ['(' 'implicit' Params ')']
Param_Clause  ::= '(' [Params] ')'
Params        ::= Param {',' Param}
Param         ::= {Annotation} [Param_Extra] variable_id 
                [':' Param_Type] [':=' Expr]
                | Literal
Param_Extra   ::= [Param_Io] [Param_Rw] ['*' | '**' | '&'] [':']
Param_Io      ::= 'in' | 'out' | 'in' '+' 'out'
Param_Rw      ::= 'val' | 'var'
Param_Type    ::= Type | '`\$`' constant_id | '=>' [Type | '_']
\end{lstlisting}

% TBD: update Fun_Def to include the optional rescue ... rescue ... ensure

A function declaration has the form of \lstinline@def $f$ $psig$: $T$@, where $f$ is the function's name, $psig$ is its parameter signature and $T$ is its return type. 

A function definition \lstinline@def $f$ $psig$: $T$ := $e$@ also includes a {\em function body} $e$, i.e. an expression which defines the functions's return value. A parameter signature consists of an optional type parameter clause \lstinline@:[$tps$]@, followed by zero or more value parameter clauses \lstinline@($ps_1$)$\ldots$($ps_n$)@. Such a declaration or definition introduces a value with a (possibly polymorphic) method type, whose parameter types and return types are as given. 

Multiple parameter clauses render curried functions. 

The type of the function body is expected to conform (\sref{sec:conformance}) to the function's declared result type, if one is given. 

An optional type parameter clause $tps$ introduces one or more type parameters, possibly with bounds. The scope of a type parameter includes the whole signature, including any of the type parameter bounds as well as the function body, if present. 

A value parameter clause $ps$ consists of zero or more formal parameter bindings, such as \lstinline@$x$: $T$@ or \lstinline@$x$: $T$ := $e$@, which bind value parameters and associate them with their types. Each value parameter declaration may optionally define a default value expression. The value expression is represented internally by an invisible function, which gets called when the function matched the function call and an explicit value for the parameter was not provided.

The order in which different kinds of value parameters may appear is as follows:
\begin{enumerate}
\item $n$ mandatory positional parameters (\sref{sec:positional-parameters}): \lstinline@$x$: $T$@, where $n \ge 0$.

\item $n$ optional positional parameters (\sref{sec:optional-parameters}): \lstinline@$x$: $T$ := $e$@, where $n \ge 0$. 

\item $n$ repeated parameters (\sref{sec:repeated-parameters}): \lstinline@*$x$: $T$@, where $0 \le n \le 1$. 

\item $n$ post mandatory positional parameters (\sref{sec:positional-parameters}): \lstinline@$x$: $T$@, where $n \ge 0$.

\item $n$ named parameters (\sref{sec:named-parameters}): \lstinline@:$x$ : $T$@ or \lstinline@:$x$ : $T$ := $e$@, where $n \ge 0$. 

\item $n$ captured named parameters (\sref{sec:captured-named-parameters}): \lstinline@**$x$: $T$@, where $0 \le n \le 1$. 

\item $n$ captured block parameters (\sref{sec:captured-block-parameter}): \lstinline@&$x$: $T$@, where $0 \le n \le 1$.
\end{enumerate}

For every parameter $p_{i,j}$ with a default value expression, a function named 
\begin{lstlisting}[escapechar=`]
default`\$`$n$
\end{lstlisting}
is generated inside the function, inaccessible for user programs. Here, $n$ denotes the parameter's position in the method declaration. These methods are parameterized by the type parameter clause \lstinline@:[$tps$]@ and all value parameter clauses \lstinline@($ps_1$)$\ldots$($ps_{i-1}$)@ preceeding $p_{i,j}$.

The scope of a formal value parameter name $x$ comprises all subsequent parameter clauses, as well as the method return type and the function body, if they are given.

\example In the method
\begin{lstlisting}[escapechar=`]
def compare:[`\$`T](a: `\$`T := 0)(b: `\$`T := a) := (a = b)
\end{lstlisting}
the default expression \code{0} is type-checked with an undefined expected type. When applying \lstinline@compare()@\footnote{Without any explicit arguments.}, the default value \code{0} is inserted and \code{T} is instantiated to \code{Number}. The functions computing the default arguments have the forms\footnote{See, at the moment \lstinline[mathescape=false]!default$2! is called, the parameter \code{a} is already computed and passed as an argument to it.}:
\begin{lstlisting}[escapechar=`]
def default`\$`1:[`\$`T]: Number := 0
def default`\$`2:[`\$`T](a: `\$`T): `\$`T := a
\end{lstlisting}

Parameters may be optionally flagged with \code{var} and \code{val} keywords, modifying their mutability inside the method. Some combinations are disallowed, as explained in the following sections. All parameters are implicitly \code{val}-flagged, unless the parameter kind implies a \code{var} flag, such as an output parameter (\sref{sec:io-parameters}).

\subsection{By-Name Parameters}
\label{sec:by-name-parameters}

\syntax\begin{lstlisting}
Param_Type ::= '=>' [Type | '_']
\end{lstlisting}

The type of a value parameter may be prefixed by ``\lstinline@=>@'', e.g. \lstinline@$x$: => $T$@. This indicates that the corresponding argument is not evaluated at the point of function application, but instead is evaluated at each use within the function. That is, the argument is evaluated using {\em call-by-name}. 

The by-name modifier is disallowed for output parameters (\sref{sec:io-parameters} \& \sref{sec:io-arguments}) and for implicit parameters (\sref{sec:implicit-parameters}). The by-name modifier implies \code{val} parameter and is disallowed for \code{var} parameters. 

By-name parameters require a specific application (\sref{sec:by-name-arguments}). A by-name parameter bound to a wildcard type ``\lstinline!_!'' matches any type of by-name argument. 

By-name parameters with default value expressions evaluate the default value expression each time the parameter is accessed, unlike optional parameters that evaluate the default value expression only once. 

By-name parameters imply the \code{val} flag, and disallow the \code{var} flag. 

\subsection{Explicit Parameters}
\label{sec:explicit-parameters}

\syntax\begin{lstlisting}
Param ::= Literal
\end{lstlisting}

The parameter may be specified by its literal value. Such parameters may only appear where positional parameters may appear. The type of the parameter is the type of the literal value. Methods with explicit parameters are preferred during method resolution to methods with the same parameter types (\sref{sec:function-applications}), but it is an error if more than one method with explicit parameters match the function application. 

The recommendation for usage of these parameters are: 
\begin{itemize}
\item Use explicit parameters with unary methods only. 
\item If the value is a collection, use an empty collection literal only. 
\end{itemize}

\example Sample methods that use explicit parameters:
\begin{lstlisting}
def factorial (0) := 1
def factorial (x) := x * factorial(x - 1)
\end{lstlisting}

Since the parameter has no name to bind to, it is not accessible inside the method body. 

\subsection{Input \& Output Parameters}
\label{sec:io-parameters}

\syntax\begin{lstlisting}
Param_Io ::= 'in' | 'out' | 'in' '+' 'out'
\end{lstlisting}

If no input/output parameter specifier is explicitly available, then the parameter is implicitly an input parameter. Output parameters require a specific application (\sref{sec:io-arguments}).

Output parameters imply \code{var} parameter and is disallowed for \code{val} parameters. Input parameters that are not output parameters at the same time can be both \code{var} and \code{val}. 

\subsection{Positional Parameters}
\label{sec:positional-parameters}

Positional parameters are of the forms:
\begin{lstlisting}
$x$: $T$
var $x$: $T$
val $x$: $T$
in $x$: $T$
in var $x$: $T$
in val $x$: $T$
out $x$: $T$
out var $x$: $T$
in+out $x$: $T$
in+out var $x$: $T$
$x$: => $T$
val $x$: => $T$
in $x$: => $T$
in val $x$: => $T$
\end{lstlisting}

Positional parameters may not have any modifiers, except for input/output modifiers (\sref{sec:io-parameters}) and by-name (\sref{sec:by-name-parameters}). Positional parameters can't have any default value expressions. 

\subsection{Optional Parameters}
\label{sec:optional-parameters}

Optional parameters are of the forms:
\begin{lstlisting}
$x$: $T$ := $e$
var $x$: $T$ := $e$
val $x$: $T$ := $e$
in $x$: $T$ := $e$
in var $x$: $T$ := $e$
in val $x$: $T$ := $e$
$x$: => $T$ := $e$
val $x$: => $T$ := $e$
in $x$: => $T$ := $e$
in val $x$: => $T$ := $e$
\end{lstlisting}

Optional parameters may not have any modifiers, except for input/output modifiers (\sref{sec:io-parameters})\footnote{Optional parameters are always ``input'', so that declaration is always redundant.} and by-name modifier (\sref{sec:by-name-parameters}). Optional parameters have a {\em default value expressions} and may appear between positional parameters, being followed by any number of positional parameters (including no more positional parameters at all), or being followed by repeated parameters and then positional parameters (\sref{sec:named-optional-arguments}). Optional parameters are disallowed for output parameters and repeated parameters. 

\subsection{Repeated Parameters}
\label{sec:repeated-parameters}

Repeated parameters are of the forms:
\begin{lstlisting}
*$x$: $T$
var *$x$: $T$
val *$x$: $T$
in *$x$: $T$
in var *$x$: $T$
in val *$x$: $T$
\end{lstlisting}

Between optional parameters and the tailing positional parameters may be a value parameter prefixed by ``\lstinline!*!'', e.g. \lstinline!($\ldots$, *$x$: $T$)!. The type of such a {\em repeated} parameter inside the method is then a list type \lstinline!List:[$T$]!. Methods with repeated parameters take a variable number of arguments of type $T$ between the optional parameters block and the last positional parameters block, including no arguments at all (an empty list is then its value). 

If a repeated parameter is flagged with \code{val}, the parameter itself is immutable, not the elements of the list. Repeated parameters are \code{val}-flagged implicitly, unless explicitly flagged as \code{var}, to protect the captured elements from accidental overwrite. 

\example The following method definition computes the sum of the squares of a variable number of integer arguments.
\begin{lstlisting}
def sum (*args: Integer): Integer
declare
  var result := 0
begin
  for arg in args loop
    result += arg ** 2
  end loop
  
  result
end
\end{lstlisting}
The following applications of this method yield \code{0}, \code{1}, \code{14}, in that order.
\begin{lstlisting}
sum
sum 1
sum 1, 2, 3
\end{lstlisting}
Furthermore, assume the definition:
\begin{lstlisting}
val xs := %[1, 2, 3]
\end{lstlisting}
The following application of the method \code{sum} is not resolved:\footnote{Unless there is an overloaded version of the method that accepts a list of integers as its parameter.}
\begin{lstlisting}
sum xs // Error: method match not found, wrong arguments
\end{lstlisting}
By contrast, the following application is well-formed and yields again the result \code{14}:
\begin{lstlisting}
sum *xs
\end{lstlisting}

\subsection{Named Parameters}
\label{sec:named-parameters}
\label{sec:captured-named-parameters}

Named parameters are of the forms:
\begin{lstlisting}
:$x$ : $T$
var :$x$ : $T$
val :$x$ : $T$
in :$x$ : $T$
in var :$x$ : $T$
in val :$x$ : $T$
out :$x$ : $T$
out var :$x$ : $T$
in+out :$x$ : $T$
in+out var :$x$ : $T$
:$x$ : $T$ := $e$
var :$x$ : $T$ := $e$
val :$x$ : $T$ := $e$
in :$x$ : $T$ := $e$
in var :$x$ : $T$ := $e$
in val :$x$ : $T$ := $e$
:$x$ : => $T$
val :$x$ : => $T$
in :$x$ : => $T$
in val :$x$ : => $T$
:$x$ : => $T$ := $e$
val :$x$ : => $T$ := $e$
in :$x$ : => $T$ := $e$
in val :$x$ : => $T$ := $e$
\end{lstlisting}

Captured named parameters are of the form: 
\begin{lstlisting}
**$x$ : $T$
var **$x$ : $T$
val **$x$ : $T$
in **$x$ : $T$
in var **$x$ : $T$
in val **$x$ : $T$
\end{lstlisting}

Named parameters are a way of allowing users of the method to write down arguments in any order, provided that their name is given at function application (\sref{sec:function-applications} \& \sref{sec:named-optional-arguments}). Named parameters may have a default value expression and may be both input and output. Named parameters are disallowed for repeated parameters. Named parameters inside the method is then accessible the same way as a positional parameter. 

Captured named parameters are capturing any other applied named parameters that were not captured by their explicit declaration (\sref{sec:named-optional-arguments}). They are declared after the block of named parameters, prefixed by ``\lstinline!**!'', e.g. \lstinline!($\ldots$, **$x$: $T$)!. The type of such a captured named parameter inside the method is then a dictionary type \lstinline!Dictionary:[Symbol, $T$]!. Methods with captured named parameters take a variable number of named arguments of type $T$ mixed with other named arguments and before the captured block parameter. Captured named parameters are disallowed for repeated parameters, output parameters and by-name parameters. 

If a captured named parameter is flagged with \code{val}, the parameter itself is immutable, not the elements of the dictionary. Captured named parameters are \code{val}-flagged implicitly, unless explicitly flagged as \code{var}, to protect the captured elements from accidental overwrite. 

\subsection{Captured Block Parameter}
\label{sec:captured-block-parameter}

Captured block parameters are of the forms:
\begin{lstlisting}
&$x$
&$x$: $T$
in &$x$
in var &$x$
in val &$x$
in &$x$: $T$
in var &$x$: $T$
in val &$x$: $T$
\end{lstlisting}

Captured block parameter is a way to capture an applied block that is otherwise passed in implicitly as a function into \code{yield} expressions . The forms of captured block parameters explicitly denote the case without the block's function type, since block parameters receive any arguments and those missing are implicitly set to \code{nil}. The function type of the block may be used to further constrain the applied block argument, but is not used during method resolution (\sref{sec:function-applications}). 

It is an error if a block parameter type $T$ is provided and it is not a function type (\sref{sec:function-types}). It is also an error if the applied block argument does not accept the arguments declared by the type $T$, or if the block would not return a value conforming to the return type required by the type $T$. The applied block argument may accept more arguments than required by $T$, however, these will be set implicitly to \code{nil}. Also, the applied block argument may itself require less constrained parameter types, in which case the arguments applied to it must (and will) always conform (\sref{sec:conformance}) to the block's parameter requirements. Whether the function type $T$ has a return type or not is irrelevant. 

If a block parameter type $T$ is given, then the applied block argument must accept parameters, such that the parameter constrains declared by the function type $T$ conform to the parameter constrains declared by the applied block: the parameters of the applied block must be the same or less restrictive than those declared by $T$ -- they must be pairwise contravariant or invariant, never covariant (\sref{sec:variance-of-type-parameters}). 

\subsection{Parameter Kind Combinations}

This section is {\em normative}. 

Users should design their functions in a way that makes them having as few parameters as possible. 

In this spirit, an ideal count of parameters lies between 0 and 2 (nullary, unary and binary functions). Named parameters should be used with only up to one positional\footnote{In this sense, optional and repeated parameters are also positional, because they are applied on a particular numbered position rather than named.} parameter. Functions with more than 4 different parameters should be avoided. 

\subsection{Method Types Inference}
\label{sec:method-types-inference}

\paragraph{\em Parameter Type Inference}
Functions that are members of a class $C$ may define parameters without type annotations. The types of such parameters are inferred as follows. Say, a~method $m$ in a class $C$ has a parameter $p$ which does not have a type annotation. We first determine methods $m'$ in $C$ that might be overridden (\sref{sec:overriding}) by $m$, assuming that appropriate types are assigned to all parameters of $m$ whose types are missing. If there is exactly one such method, the type of the parameter corresponding to $p$ in that method---seen as a member of $C$---is assigned to $p$. It is an error if there are several such overridden methods $m'$. If there is none\footnote{Detected at compile-time. Dynamically added overridden methods are not used with type inference.} ($m$ does not override any $m'$ known at compile-time), then the parameters are inferred to be of type \code{Object}.

\example Assume the following definitions:
\begin{lstlisting}[escapechar=`]
protocol I:[`\$`A]
  def f(x: `\$`A)(y: `\$`A): `\$`A
end
class C
  implements I:[Integer]
  def f(x)(y) := x + y
end
\end{lstlisting}
Here, the parameter and return types of \lstinline@f@ in \lstinline@C@ are
inferred from the corresponding types of \lstinline@f@ in \lstinline@I@. The 
signature of \lstinline@f@ in \lstinline@C@ is thus inferred to be
\begin{lstlisting}
  def f(x: Integer)(y: Integer): Integer
\end{lstlisting}

\paragraph{\em Return Type Inference}
A class member definition $m$ that overrides some other function $m'$ in a base class of $C$ may leave out the return type, even if it is recursive. In this case, the return type $R'$ of the overridden function $m'$---seen as a member of $C$---is taken as the return type of $m$ for each recursive invocation of $m$. That way, a type $R$ for the right-hand side of $m$ can be determined, which is then taken as the return type of $m$. Note that $R$ may be different from $R'$, as long as $R$ conforms to $R'$. If $m$ does not override any $m'$, then its return type is inferred to be of type \code{Object}. 

\example Assume the following definitions:
\begin{lstlisting}
protocol I
  def factorial(x: Integer): Integer
end
class C 
  implements I
  def factorial(x: Integer) := {
    if x = 0 then 1 else x * factorial(x - 1) end
  }
end
\end{lstlisting}
Here, it is ok to leave out the return type of \lstinline@factorial@
in \lstinline@C@, even though the method is recursive. 

For any index $i$ let $fsig_i$ be a function signature consisting of a function
name, an optional type parameter section, and zero or more parameter
sections. Then a function declaration 
~\lstinline@def $fsig_1 \commadots fsig_n$: $T$@~ 
is a shorthand for the sequence of function
declarations ~\lstinline@def $fsig_1$: $T$; $\ldots$; def $fsig_n$: $T$@.  
A function definition ~\lstinline@def $fsig_1 \commadots fsig_n$ := $e$@~ is a
shorthand for the sequence of function definitions 
~\lstinline@def $fsig_1$ := $e$; $\ldots$; def $fsig_n$ := $e$@.  
A function definition
~\lstinline@def $fsig_1 \commadots fsig_n: T$ = $e$@~ is a shorthand for the
sequence of function definitions 
~\lstinline@def $fsig_1: T$ := $e$; $\ldots$; def $fsig_n: T$ := $e$@.

\section{Overloaded Declarations \& Definitions}
\label{sec:overloaded-definitions}

An overloaded definition is a set of $n > 1$ function
definitions in the same statement sequence that define the same name,
binding it to types ~\lstinline@$T_1 \commadots T_n$@, respectively.
The individual definitions are called {\em alternatives}. Overloaded
definitions may only appear in the expression sequence of a class-level block.
Alternatives always need not to specify the type of the defined entity
completely.

Overloaded function definitions have strong impact on method resolution. It is an error if a single set of arguments may be applied type-safely to multiple overloaded functions -- to resolve this, explicit argument types have to be applied (\sref{sec:function-applications}).

Overloaded functions generate new functions that internally merge the overloaded functions into one, which then resolves the correct overloaded function based on the applied types.

\example Assume the following overloaded declarations
\begin{lstlisting}
def double (arg: Number): Number
def double (arg: Integer): Integer
\end{lstlisting}
Now, the following method application is invalid, because two functions resolve to the same arguments set: 
\begin{lstlisting}
// variable-less:
double 42
\end{lstlisting}
Now, with explicitly applied argument types, the following method applications are correct:
\begin{lstlisting}
// variable-less:
double 42 as Integer

// with a variable:
var number: Integer := 42
double number

var number := 42 // the type is inferred
double number
\end{lstlisting}

\section{Use Clauses}
\label{sec:use-clauses}

\syntax\begin{lstlisting}
Use             ::= 'use' Use_Expr
Use_Expr        ::= (Container_Path | Stable_Id) '::' Import_Expr
Import_Expr     ::= Single_Import
                  | '{' Import_Exprs '}'
                  | '_'
Import_Exprs    ::= Single_Import {',' Single_Import} [',' '_']
Single_Import   ::= importable_id ['as' [constant_id | '_']]
Container_Path  ::= Module_Path ['::' Constant_Path]
                  | Constant_Path
Module_Path     ::= Module_Selector {'::' Module_Selector}
Constant_Path   ::= Const_Selector {'::' Const_Selector}
Module_Selector ::= constant_id [Vendor_Arg]
Const_Selector  ::= constant_id
Vendor_Arg      ::= '~[' vendor_domain ']'
\end{lstlisting}

A use clause has the form \lstinline!use $p$::$I$!, where $p$ is a path to the containing type of the imported entity (either a module or another class), and $I$ is an import expression. The import expression determines a set of names (or just one name) of {\em importable members}\footnote{Dynamically created members are not importable, since the compiler has no way to predict their existence.} of $p$, which are made available without full qualification, e.g. as an unqualified name. A member $m$ of $p$ is {\em importable}, if it is {\em visible} from the import scope and not object-private (\sref{sec:modifiers}). The most general form of an import expression is a list of {\em import selectors}
\begin{lstlisting}
{ $x_1$ as $y_1$ $\commadots$ $x_n$ as $y_n$, _ }
\end{lstlisting}
for $n \ge 0$, where the final wildcard ``\lstinline!_!'' may be absent. It makes available each importable member \lstinline!$p$::$x_i$! under the unqualified name $y_i$. I.e. every import selector \lstinline!$x_i$ as $y_i$! renames (aliases) \lstinline!$p$::$x_i$! to $y_i$. If a final wildcard is present, all importable members $z$ of $p$ other than $x_1 \commadots x_n, y_1 \commadots y_n$ are also made available under their own unqualified names. 

Import selectors work in the same way for type and term members. For instance, a use clause \lstinline!use $p$::{$x$ as $y$}! renames the term name \lstinline!$p$::$x$! to the term name $y$ and the type name \lstinline!$p$::$x$! to the type name $y$. At least one of these two names must reference an importable member of $p$. 

If the target name in an import selector is a wildcard, the import selector hides access to the source member. For instance, the import selector \lstinline!$x_i$ as _! ``renames'' $x$ to the wildcard symbol, which basically means discarding the name, since \lstinline!_! is not a readable name\footnote{Meaning, it is not possible to use ``\lstinline!_!'' as a variable to read from, it never has any value.}, and thereby effectively prevents unqualified access to $x$. This is useful if there is a final wildcard in the same import selector list, which imports all members not mentioned in previous import selectors, to selectively not import some members. 

The scope of a binding introduced by an import-clause starts immediately after the import clause and extends to the end of the enclosing scope and all nested scopes. 

Several shorthands exists. An import selector may be just a simple name $x$, in which case, $x$ is imported without renaming, so the import selector is equivalent to \lstinline!$x$ as $y$!. Furthermore, it is possible to replace the whole import selector list by a single identifier of wildcard. The use clause \lstinline!use $p$::$x$! is equivalent to \lstinline!use $p$::{$x$}!, i.e. it makes available without qualification the member $x$ of $p$. The use clause \lstinline!use $p$::_! is equivalent to \lstinline!use $p$::{_}!, i.e. it makes available without qualification all importable members of $p$ (this is analogous to \lstinline[language=Java]!import $p$.*! in Java or \lstinline[language=Java]!import $p$._! in Scala). 

\example Consider the object definition:
\begin{lstlisting}
object M
  def z := 0
  def one := 1
  def add (x: Integer, y: Integer): Integer := x + y
end
\end{lstlisting}
Then the block
\begin{lstlisting}
{ use M::{one, z as zero, _}; add (zero, one) }
\end{lstlisting}
is equivalent to the block
\begin{lstlisting}
{ M.add (M.z, M.one) } .
\end{lstlisting}


\chapter{Classes \& Objects}

\syntax\begin{lstlisting}
Const_Def ::= {Annotation} 'class' Class_Def 'end' ['class']
            | {Annotation} 'object' Obj_Def 'end' ['object']
            | {Annotation} 'module' Module_Def 'end' ['module']
            | {Annotation} 'mixin' Mixin_Def 'end' ['mixin']
            | {Annotation} 'protocol' Pro_Def 'end' ['protocol']
            | {Annotation} 'interface' Ifc_Def 'end' ['interface']
            | {Annotation} 'type' Const_Type_Def 'end' ['type']
\end{lstlisting}

Classes (\sref{sec:class-definitions}), objects (\sref{sec:object-definitions}), modules (\sref{sec:module-definitions} \& \sref{sec:modules}), mixins (\sref{sec:mixins}), protocols (\sref{sec:protocols}), interfaces (\sref{sec:interfaces}) and constant types (unions \sref{sec:unions}, enums \sref{sec:enums}, range types \sref{sec:range-types}, units of measure \sref{sec:units-of-measure}, record types \sref{sec:record-types} \& struct types \sref{sec:struct-types}) are all defined in terms of {\em class-level blocks} (\sref{sec:class-level-blocks}). Their definitions are basically a function that handles internally the definition of each type. As such, these class-level blocks can even have local variables that may appear in closures. 

\section{Class Definitions}
\label{sec:class-definitions}

\syntax\begin{lstlisting}
Class_Def  ::= constant_id [Type_Param_Clause] [Superclass] [semi]
               {Class_Expr}
Superclass ::= ':' Compound_Type
Class_Expr ::= Ctor_Expr
             | Dtor_Expr
             | Clone_Expr
             | Includes_Expr
             | Prepend_Expr
             | Implements_Expr
             | Expr
             | {Annotation} 'class' Class_Def 'end' ['class']
             | {Annotation} 'object' Obj_Def 'end' ['object']
             | {Annotation} 'mixin' Mixin_Def 'end' ['mixin']
             | {Annotation} 'protocol' Pro_Def 'end' ['protocol']
             | {Annotation} 'interface' Ifc_Def 'end' 
               ['interface']
             | {Annotation} 'type' Const_Type_Def 'end' ['type']
\end{lstlisting}

A class definition defines the type signature, behavior and initial state of a class of objects (the instances of the defined class) and of the class object, which is the class instance itself, with behavior defined in its metaclass (\sref{sec:metaclasses}). 

A class' type signature consists of the class name (the first \code{constant_id} before type parameters clause), the type parameters, the superclass, included and prepended mixins and implemented protocols. 

Expressions in the class-level block may define new members or overwrite members in the parent classes or included mixins. The whole class-level block serves as a constructor for the defined class, so the expressions may contain regular function applications, even some that may dynamically define new members (e.g. in a DSL fashion). 

For superclasses, the following statements hold:
\begin{itemize}
\item The superclass is implicitly \code{Object}, if no explicit superclass is given. 
\item Explicitly given superclass $T$, if $T$ is a single class, is that single class. 
\item Explicitly given superclass $T$, if $T$ is a compound type with a class member (\sref{sec:compound-types}), is the class member of $T$ and all other members of the compound type are mixed in (\sref{sec:mixins}). 
\item Explicitly given superclass $T$, if $T$ is a compound type without a class member (\sref{sec:compound-types}), is implicitly \code{Object} and all other members of the compound type are mixed in (\sref{sec:mixins}) if no member of the compound type has a class as its superclass, or that superclass of one of the members. If there are more members with a class-superclass, there must exist an ordering of these class-superclasses $C_1 \commadots C_n$, such that for each $i, 1 \le i \le n-1$: \lstinline!$C_i$ <: $C_{i+1}$!. It is an error if no such ordering exists. If such ordering exists, the superclass is implied to be $C_1$. 
\item Superclass is never a function type (\sref{sec:function-types}). 
\item Superclass is never a special type, i.e. unions (\sref{sec:unions}), enums (\sref{sec:enums}), range types (\sref{sec:range-types}), units of measure (\sref{sec:units-of-measure}), record types (\sref{sec:record-types}) \& struct types (\sref{sec:struct-types}). 
\item Superclass is always a class, never a mixin (\sref{sec:mixins}), a protocol (\sref{sec:protocols}) or an interface (\sref{sec:interfaces}). 
\item Every single class has at most one direct superclass. Only one class has no superclass: \code{Object}, no other class can be without a superclass. 
\end{itemize}

It is an error if any of the mixed in mixins from a compound type has a class-superclass and yet the defined class does not conform to that superclass. 

\example Consider the following class definitions:
\begin{lstlisting}
class Base : Object refine {}
mixin Mixin : Base refine {}
object O : Mixin refine {}
\end{lstlisting}
In this case, the definition of \code{O} is implied to be:
\begin{lstlisting}
object O : Base with Mixin refine {}
\end{lstlisting}

\subsection{Metaclasses \& Eigenclasses}
\label{sec:metaclasses}
\label{sec:eigenclasses}

\paragraph{\em Metaclasses}
A {\em metaclass} is a class whose instances are classes. Just as an ordinary class defines the behavior and properties of its instances, a metaclass defines the behavior of its class. Classes are first-class citizens in Coral. 

Everything is an object in Coral. Every object has a class that defines the structure (i.e. the instance variables) and behavior of that object (i.e. the messages the object can receive and the way it responds to them). Together this implies that a class is an object and therefore a class needs to be an instance of a class (called metaclass). 

Class methods actually belong to the metaclass, just as instance methods actually belong to the class. All metaclasses are instances of only one class called \code{Metaclass}, which is a subclass of the class \code{Class}. 

In Coral, every class (except for the root class \code{Object}) has a superclass. The base superclass of all metaclasses is the class \code{Class}, which describes the general nature of classes. 

The superclass hierarchy for metaclasses parallels that for classes, except for the class \code{Object}. The following holds for the class \code{Object}:
\begin{lstlisting}[deletekeywords={class}]
Object.class = Class
Object.superclass = nil
\end{lstlisting}

Classes and metaclasses are ``born together''. Every \code{Metaclass} instance has a method \code{this_class}, which returns the conjoined class. 

\paragraph{\em Eigenclasses}
Coral further purifies the concept of metaclasses by introducing {\em eigenclasses}, borrowed from Ruby, but keeping the \code{Metaclass} known from Smalltalk-80. Every metaclass is an eigenclass, either to a class, to a terminal object, or to another eigenclass\footnote{Eigenclasses of eigenclasses (``higher-order'' eigenclasses) are supposed to be rarely needed, but are there for conceptual integrity, establishing infinite regress.}. 

\begin{table}[ht]
  \centering
  \caption{Of objects, classes \& eigenclasses}
  \renewcommand{\arraystretch}{1.7}
  \begin{tabular}{ | >{\centering}m{3.5cm} | >{\centering}m{3.5cm} | >{\centering\arraybackslash}m{6cm} | }
  	\hline
    Classes & Eigenclasses of classes & \multirow{2}{*}{Eigenclasses of eigenclasses} \\ \cline{1-2}
    Terminal objects & Eigenclasses of terminal objects & \\
    \hline
  \end{tabular}
\end{table}

Eigenclasses are manipulated indirectly through various syntax features of Coral, or directly using the \code{eigenclass} method. This method can possibly trigger creation of an eigenclass, if the receiver of the \code{eigenclass} message did not previously have its own (singleton) eigenclass (because it was a terminal object whose eigenclass was a regular class, or the reciever was an eigenclass itself). 

Another way to access an eigenclass is to use the \lstinline!class << obj; $\ldots$; end! construct. The block of code inside runs is evaluated in the scope of the eigenclass of \code{obj}. 

\example Direct access to the eigenclass of any object, here a class' eigenclass:
\begin{lstlisting}
class A
  class << self
    def a_class_method
      "A.a_class_method"
    end def
  end
end class
\end{lstlisting}
Class \code{A} uses the \lstinline!class << obj; $\ldots$; end! construct to get direct access to the eigenclass. The keyword \code{self} inside the block is bound to the eigenclass object. 

\example Alternative direct access to the eigenclass of any object, here a class' eigenclass:
\begin{lstlisting}
class B
  self.eigenclass do
    def a_class_method
      "B.a_class_method"
    end def
  end
end class
\end{lstlisting}
Class \code{B} uses the \code{eigenclass} method, which---given a block---evaluates the block in the scope of the eigenclass of \code{self}, which is bound to the class \code{B}. The keyword \code{self} inside the block is again bound directly to the eigenclass object. 

\example Indirect access to the eigenclass using a singleton method definition:
\begin{lstlisting}
class C
  def self.a_class_method
    "C.a_class_method"
  end def
end class
\end{lstlisting}
Class \code{C} uses singleton method definition to add methods to the eigenclass of the class \code{C}. The keyword \code{self} is bound to the class object in the class-level block and in the new method as well, but the eigenclass is accessed only indirectly. 

\example Indirect access to the eigenclass using a class object definition:
\begin{lstlisting}
class D
  object D
    def a_class_method
      "D.a_class_method"
    end def
  end object
end class
\end{lstlisting}
Class \code{D} uses the recommended approach, utilizing standard ways of adding methods to the eigenclass of the class \code{D}. Here, the eigenclass instance itself is not accessed directly.  

\example Alternative indirect access to the eigenclass using a class object definition:
\begin{lstlisting}
object E
  def a_class_method
    "E.a_class_method"
  end def
end object
\end{lstlisting}
Class \code{E} uses a similar recommended approach, utilizing standard ways of adding methods to the eigenclass of the class \code{E} and neither declaring nor defining anything for its own instances. Here, the eigenclass instance itself is not accessed directly. 

\subsection{Class Linearization}
\label{sec:class-linearization}

The classes reachable through transitive closure of the direct inheritance relation from a class $C$ are called the {\em base classes} of $C$. Because of mixins, the inheritance relationship on base classes forms in general a directed acyclic graph. A linearization of this graph is defined as follows. 

\newcommand{\uright}{\;\vec +\;}
\newcommand{\lin}[1]{{\cal L}(#1)}

\begin{definition}
Let base classes of a class $C$ be the list of every superclass of $C$ with every mixin that these classes include and/or prepend and every protocol that these classes implement. Let $C$ be a class with base classes ~\lstinline!$C_1$ with $C_2$ with $\ldots$ with $C_n$!. The {\em linearization} of $C$, $\lin C$ is defined as follows:
\bda{rcl}
\lin C &=& C\ , \ \lin{C_n} \uright \ldots \uright \lin{C_1}
\eda
Here $\uright$ denotes concatenation, where elements of the right operand replace identical elements of the left operand:
\bda{lcll}
\{a, A\} \uright B &=& a, (A \uright B)  &{\bf if}~a \not\in B \\
                 &=& A \uright B       &{\bf if}~a \in B
\eda
\end{definition}

\example Consider the following class definitions.\footnote{Here we say ``class'', but that term includes now mixins as well.}
\begin{lstlisting}
class Abstract_Iterator : Object; $\ldots$ end
mixin Rich_Iterator : Abstract_Iterator; $\ldots$ end
class String_Iterator : Abstract_Iterator; $\ldots$ end
class Iterator : String_Iterator with Rich_Iterator; $\ldots$ end
\end{lstlisting}
Then the linearization of class \code{Iterator} is
\begin{lstlisting}
{ Iterator, Rich_Iterator, String_Iterator, Abstract_Iterator, 
  Object }
\end{lstlisting}

Note that the linearization of a class refines the inheritance relation: if $C$ is a subclass of $D$, then $C$ precedes $D$ in any linearization where both $C$ and $D$ occur. Also note that whether a mixin is included or prepended is irrelevant to linearization, but essential to function applications (\sref{sec:function-applications}).

\subsection{Inheritance Trees \& Include Classes}
\label{sec:inheritance-trees}
\label{sec:include-classes}

\paragraph{\em Include classes}
A mechanism that allows arbitrary including and prepending of mixins into classes and inheritance binary trees\footnote{Yes, trees, not chains: prepended mixins make the inheritance game stronger by forking the inheritance chain at each class with prepended mixins, forming a shape similar to a rake.} uses a transparent structure called {\em include class}. Include classes are always defined indirectly.

Every class has a link to its superclass. In fact, the link is made up of an include class structure, which itself holds an actual link to the superclass. That superclass has its own link to its superclass and this chain goes forever until the \code{Object} class is encountered, which has no superclass. 

\paragraph{\em Included mixins}
When a mixin $M$ is included into a class, a new include class $Im_i$ is inserted between the target class and the include class $Is$ that holds a link to its superclass (or to a previously included mixin $Im_{i+1}$). This include class $Im_i$ then holds a link to the included mixin. Every class that includes the mixin $M$ is available via the \code{included_in} method of $M$. 

If a mixin $M$ is already (included in or prepended to)\footnote{This is important since both included and prepended mixins act like superclasses to every subclass.} any of the superclasses, then it is not included again. Included mixins act like superclasses of the class they are included in, and they {\em overlay} the superclasses. 

\example A sample mixin schema:
\begin{lstlisting}
class C : D with Some_Mixin
end

C $\rightarrow$ [Some_Mixin] $\rightarrow$ [D]
D $\rightarrow$ [Object]
\end{lstlisting}
Include classes are depicted by the brackets, with their link value inside. Note that include classes only know their super-type (depicted by the arrow ``$\rightarrow$'') and their link value (inside brackets). 

\paragraph{\em Prepended mixins}
When a mixin $M$ is prepended to a class, a new include class $Im_i$ is inserted between the target class and its last prepended mixin, if any. Prepended mixins are stored in a secondary inheritance chain just for prepended mixins, forming an inheritance tree. Every class that has $M$ prepended is available via the \code{prepended_in} method of $M$. The effect of prepending a mixin in a class or a mixin is named {\em overlaying}. 

If a mixin $M$ is already prepended to any of the superclasses, it has to be prepended again, since the already prepended mixins of superclasses are in super-position to the class or mixin that gets $M$ prepended. Prepended mixins of superclasses do not {\em overlay} child classes. Prepended mixins are inserted into the inheritance tree more like subclasses than superclasses. 

\paragraph{\em Nested includes}
When a mixin $M$ itself includes one or more mixins $M_1 \commadots M_n$, then these included mixins are inserted between the included mixin $M$ and the superclass, unless they are already respectively included by any of the superclasses. If $M$ with included $M_1 \commadots M_n$ is prepended to $C$, then $M_1 \commadots M_n$ are inserted before the superclass of $C$, if not already included in any of the superclasses. It is an error if nested includes form a dependency cycle: any {\em auto-included}\footnote{Unlike in Ruby, Coral does not need concerns to employ automatic injection of dependencies. Every mixin in Coral is a concern.} mixin must not require to include a mixin that triggered the auto-include. 

\paragraph{\em Nested prepends}
When a mixin $M$ itself prepends one or more mixins $M_1 \commadots M_n$, then nothing happens to the class or the mixin that $M$ is included in. If $M$ is prepended to $C$, then every prepended mixin in $M_1 \commadots M_n$ is prepended to $C$ in this way:
\begin{enumerate}
\item $M$ is inserted as the head of the prepend chain in an include class. 
\item For each $1 \le i \le n$, $M$ is switched with previously prepended mixins until $M_i$ is closer to the chain head than $M$, if $M_i$ is contained in the chain, or else $M_i$ is inserted as the head of the prepend chain. 
\item If $M_i$ includes any other mixins, these are included in the same way as nested included mixins. 
\item Check for prepend cycles -- if any {\em auto-prepended}\footnote{Again, this is unlike in Ruby, which does not automatically prepend mixins.} mixin requires to prepend a mixin that triggered the auto-prepend, then it is an error. 
\end{enumerate}

\paragraph{\em Mixins \& Metaclasses}
Since mixins may contain ``class'' methods as well as instance methods, all the operations with include classes are mirrored on the respective metaclasses.\footnote{This makes Coral in no need of constructs like \lstinline[language=Ruby]!module ClassMethods!, known from Ruby.}

\subsection{Class Members}
\label{sec:class-members}

A class $C$ defined by class definition can define members in its class-level block, can inherit members from all parent classes\footnote{Including an interface and any number of protocols.} and included mixins, and can have its members overlayed by all prepended mixins. 

Member definitions fall basically into two categories: {\em concrete} \& {\em abstract}. Members of the class $C$ are either {\em directly defined}, {\em overlayed} or {\em inherited}. 

Concrete members are those that have a definition, abstract members are those that are only declared without any subsequent or preceding definition.\footnote{There is a special case, when a protocol introduces an abstract member, but the class that implements this protocol already inherited or directly defined the matching member.}

Members are instance variables, class instance variables, methods \& messages. 

\subsection{Class-Level Blocks}
\label{sec:class-level-blocks}

Class-level blocks are multi-constructors for class objects. A single class may have one or more class-level blocks spread across multiple source files. A single class may have multiple class-level blocks in the same source file as well. 

Class-level blocks work like functions that construct the class object, including declarations and definitions of its instances as well as the class object itself, and can work with metaclasses (\sref{sec:metaclasses}) like any other function. Their execution order is derived from the order in which the containing source files are executed (\sref{sec:compilation-units}). 

An object definition (\sref{sec:object-definitions}) inside a class-level block for the same name as the name of the enclosing class defines the object of the enclosing class itself, and moreover, does not need to need to specify the superclass. It is an error if the enclosing class does not need specify a superclass and the nested object definition does specify a superclass -- it must be the other way around. The nested object definition has \lstinline!include $M$!, \lstinline!prepend $M$! and \lstinline!implements $M$! expressions relative to the defined object, not to the enclosing class, which has several implications: 
\begin{itemize}
\item There is no way to include (or prepend) only class methods from a mixin directly into the defined object -- the instance methods of the mixin are included in the defined object and the class methods go to the metaclass of the defined object. 
\item Since the defined object is always an instance of \lstinline!Class:[$C$]!, the mixin must require any class of the receiver or a class that conforms to \lstinline!Class:[$C$]!, not $C$ directly. 
\item It is advised to not give any class methods to mixins (or protocols) that are to be included (prepended, or implemented) in a defined object, since methods from its metaclass are not easy to invoke. 
\end{itemize}

\example Given the following object definition inside a class definition:
\begin{lstlisting}
class $C$
  object $C$
    $\ldots$
  end object
end class
\end{lstlisting}
The object definition for $C$ does \textbf{not} create an object \lstinline!$C$::$C$!, but defines the class object of the class $C$. However, the following object definition:
\begin{lstlisting}
class $C$
  object $D$
    $\ldots$
  end object
end class
\end{lstlisting}
does define an object \lstinline!$C$::$D$!, because it has a different name, and is thus unrelated to $C$ in any other way than being enclosed in $C$ (and having inheritance closure in $C$ -- \sref{sec:inheritance-closure}). 

Since class-level blocks are basically functions, the members defined inside of them can closure local variables inside the block (\sref{sec:local-variable-closure}). Any member defined outside of the class-level block can not closure its local variables. 

\subsection{Constructor \& Destructor Definitions}
\label{sec:constructor-destructor-def}

\syntax\begin{lstlisting}
Ctor_Def     ::= 'constructor' Ctor_Fun_Def 'end' ['constructor']
               | 'constructor' Ctor_Alt_Def
Ctor_Fun_Def ::= [Fun_Tpc] [Param_Clause] [Fun_Dec] semi Expr
Ctor_Alt_Def ::= [Fun_Tpc] [Param_Clause] [Fun_Dec] ':=' Expr
Dtor_Def     ::= 'destructor' Dtor_Fun_Def 'end' ['destructor']
Dtor_Fun_Def ::= [Fun_Dec] semi Expr
\end{lstlisting}

Constructors and destructors can only be defined inside of class-level blocks (\sref{sec:class-level-blocks}). Constructors are functions that can never be called by a name, instead, they are invoked indirectly by creating a new instance of a class (an object value), from the \lstinline!allocate! method of \code{Class}. Destructors are invoked indirectly when an object is to be deallocated, that is, when its reference count reaches \code{0} and all its soft references are released. 

Constructors can have any number of parameters, including none at all. Every constructor has a special behavior that invokes its super-constructor with matching parameters before any other code, unless explicitly invoked. It is an error if a constructor invokes a super-constructor more than 1 times. If a constructor does not have a matching super-constructor, then a {\em default constructor} or an {\em implicit constructor} is used.

A different constructor of the same class may be invoked by using the \code{self} keyword as a function name. If a constructor invokes a different constructor of the same class this way, the super-constructor is not implicitly invoked (since it is invoked in the other constructors). 

\paragraph{\em Default constructor}
A default constructor of a class is the explicit parameterless constructor. This differs from Java or C\#. 

\paragraph{\em Implicit constructor}
An implicit constructor is an automatically generated bridge constructor to the parameterless default constructor. This is what Java and C\# call ``default constructor''. An implicit constructor ``does nothing'' but invokes the super-constructor and initializes all members specific to the constructed object to their default values (either implicit one, which is \code{nil}, or explicit ones used in their definitions). 

\paragraph{\em Convenience constructor}
A convenience constructor is any other constructor than the parameterless default constructor. 

\paragraph{\em Accessibility of constructors}
Constructors may have modified accessibility, so that only certain functions can invoke them indirectly. The accessibility is then transitioned from the calling context. 

\example An example of a convenience constructor of class $C$.
\begin{lstlisting}
class $C$
  constructor (param)
    // super is invoked implicitly here
    val @resource := param
  end constructor
end class
\end{lstlisting}

\example An example of a pair of constructors of class $C$. 
\begin{lstlisting}
class $C$
  constructor := self(42)
  constructor (param)
    // super is invoked implicitly here
    val @resource := param
  end constructor
end class
\end{lstlisting}

\paragraph{\em Explicit destructor}
An explicit destructor does not have any accessibility. The super-destructor is invoked implicitly at the end of its execution, unless explicitly invoked earlier. Destructors are parameterless and have a further requirement that they can not increment the reference count of the object being destructed -- doing so could result in zombie objects. 

\paragraph{\em Implicit destructor}
An implicit destructor is an automatically generated bridge destructor to the parameterless super-destructor. An implicit destructor ``does nothing'' but release all members specific to the destructed object and invoke super-destructor afterwards. The destructor of \code{Object} releases every remaining member of the destructed object. A class can only have a single destructor, either an explicit or an implicit one. 

\paragraph{\em Accessibility of destructors}
Destructors, unlike constructors, can not have any accessibility modifiers. They ignore the current accessibility flag of their class-block and trigger a warning if a modifier is used directly with the destructor. Destructors may be invoked independently on the context in which the object is destructed. 

\example An example of an explicit destructor of class $C$. 
\begin{lstlisting}
class $C$
  destructor
    @resource.close unless @resource.closed?
    // super is invoked implicitly here
  end destructor
end class
\end{lstlisting}

\subsection{Clone Constructor Definitions}
\label{sec:clone-def}

\syntax\begin{lstlisting}
CCtor_Def     ::= 'clone' CCtor_Fun_Def 'end' ['clone']
                | 'clone' CCtor_Alt_Def
CCtor_Fun_Def ::= [Fun_Tpc] [Param_Clause] [Fun_Dec] semi Expr
CCtor_Alt_Def ::= [Fun_Tpc] [Param_Clause] [Fun_Dec] ':=' Expr
\end{lstlisting}

Clone constructors are pretty much like constructor, except for they are not invoked indirectly by \code{allocate} on \code{Class}, but by \code{clone} on the cloned instance. Regular constructors are not invoked on the cloned objects, since they were already invoked on the original object. 

Clone constructor implicitly returns the new cloned object, unless returning explicitly a different object. The original object is available with the \code{self} and \code{this} keywords, the new cloned object is available as the \code{cloned} keyword. The \code{cloned} keyword is only recognized as a keyword in a body of the clone constructor. 

Clone constructors pass on the eigenclass (if any) of the original object to the cloned object, thus elevating it to an almost regular class -- a prototype class, a class that resides not in a constant, but in a class instance, in an object (but that original object may be still assigned to a constant anyway). 

A different clone constructor of the same class may be invoked by using the \code{self} keyword as a function name. If a clone constructor invokes a different clone constructor of the same class this way, the super-clone-constructor is not implicitly invoked (since it is invoked in the other clone constructors). 

\paragraph{\em Default clone constructor}
A default clone constructor of a class is the explicit parameterless clone constructor. 

\paragraph{\em Implicit clone constructor}
An implicit clone constructor is an automatically generated bridge clone constructor to the parameterless default clone constructor. An implicit clone constructor ``does nothing'' but invokes the super-clone-constructor and makes a shallow copy of every member specific to the cloned object. 

\paragraph{\em Convenience clone constructor}
A convenience clone constructor is any other clone constructor than the parameterless default clone constructor. The \code{clone} method of objects can accept any number of arguments that are then passed into the clone constructor and the clone constructor is resolved based on these passed arguments. 

\paragraph{\em Accessibility of clone constructors}
Clone constructors may have modified accessibility, so that only certain functions can invoke them indirectly. The accessibility is then transitioned from the calling context. 

\example An example of a default clone constructor of class $C$, performing a deep copy. 
\begin{lstlisting}
class $C$
  clone
    // super is invoked implicitly here
    cloned.resource := self.resource.clone
  end constructor
end class
\end{lstlisting}

\subsection{Overriding}
\label{sec:overriding}

A member $M$ of a class $C$ that matches a member $M'$ of a base class of $C$ is said to override that member. In this case the binding of the overriding member $M$ must conform (\sref{sec:conformance}) to the binding of the overridden member $M'$. Furthermore, the following restrictions on modifiers apply to $M$ and $M'$: 
\begin{itemize}
\item If $M$ is labeled \lstinline!private:[$C$]! for some enclosing class or module $C$, then $M'$ must be labeled \lstinline!private:[$C'$]!, where $C'$ equals $C$ or $C$ is contained in $C'$. % review the last few words
\item If $M$ is labeled \lstinline!protected!, then $M'$ must also be labeled \lstinline!protected!. 
\item If $M'$ is labeled \lstinline!protected!, then $M'$ must also be labeled \lstinline!protected! or \lstinline!public!. 
\item If $M'$ is labeled \lstinline!private!, then $M'$ must be labeled \lstinline!private!, \lstinline!protected! or \lstinline!public!. 
\item If $M'$ is not an abstract member, then $M$ may be annotated with \lstinline!@[Override]!. 
\end{itemize}

To generalize the conditions, the modifier of $M$ must be the same or less restrictive than the modifier of $M'$. 

\subsection{Inheritance Closure}
\label{sec:inheritance-closure}

\newcommand{\inheritclosure}{{\cal S}}

Let $C$ be a class type. The {\em inheritance closure} of $C$ is the smallest set $\inheritclosure$ of types such that
\begin{itemize}
\item If $T$ is in $\inheritclosure$, then every type $T'$ which forms syntactically a part of $T$ is also in $\inheritclosure$. 
\item If $T$ is a class type in $\inheritclosure$, then all parents of $T$ are also in $\inheritclosure$. 
\end{itemize}
It is an error if the inheritance closure of a class type consists of an infinite number of types. 

\subsection{Modifiers}
\label{sec:modifiers}

\syntax\begin{lstlisting}
Modifier         ::= Local_Modifier
                   | Access_Modifier
                   | 'override'
Local_Modifier   ::= 'implicit'
                   | 'lazy'
                   | 'final'
                   | 'sealed'
                   | 'abstract'
Access_Modifier  ::= 'public'
                   | ('protected' | 'private') [Access_Qualifier]
Access_Qualifier ::= ':[' (constant_id | 'self') ']'
\end{lstlisting}

Access modifiers may appear in two forms:

\paragraph{\em Accessibility flag modifier}
Such a modifier appears in a class-level block (\sref{sec:class-level-blocks}) alone on a single line. All subsequent members in the same class-level block than have accessibility of this modifier applied to them, if allowed to (does not apply to destructors). Modifiers \code{implicit} and \code{lazy} can not be used this way. 

\paragraph{\em Directly applied modifier}
Such a modifier appears on a line preceding a member to which the modifier is solely applied, or a list of arguments with symbols that the modifier will be applied to. A directly applied modifier expression has a return type of \code{Symbol}, so that it may be used as a regular function and chained. 

\example An example of an accessibility flag modifier:
\begin{lstlisting}
class C
  public
    def hello; end
  private
    def private_hello; end
end class
\end{lstlisting}

\example An example of directly applied modifier:
\begin{lstlisting}
class C
  def hello; end
  def private_hello; end
  def salute; end
  public :hello
  private :private_hello, :salute
  protected def goodbye; end
end class
\end{lstlisting}

By default\footnote{That is, without any explicit modifier being applied.}, the \code{public} access modifier affects every member of the class type, except for instance variables and class instance variables, which are object-private (\lstinline!private:[self]!). 

Modifiers affect the accessibility and usage of the identifiers bound by them. If several modifiers are given, their order does not matter, but the same modifier may not occur more than once and combinations of \code{public}, \code{protected} \& \code{private} are not allowed (using them as accessibility flag modifiers overwrites the previous accessibility, not combines them). If a member declaration has a modifier applied to it, then the subsequent member definition has the same modifier already applied to it as well, without the need to explicitly state that. It is an error if the modifier applied to the member definition would contradict the modifier applied to the member declaration. 

Accessibility modifiers can not be applied to instance variables and class instance variables (both declarations and definitions). These are by default {\em instance-private}. This is a sort of relaxation in access restriction, say, every method that is at least {\em public} and at most {\em object-private} restricted, and that has the instance as a receiver, can access the instance variable or the class instance variable. Any other method that does not have the particular instance as the receiver, does not have any access to the instance variable or the class instance variable, even if the method is a method of the same class as the particular instance. 

The rules governing the validity and meaning of a modifier are as follows: 
\begin{itemize}
\item
The \code{private} access modifier can be used with any declaration or definition in a class. Such members can be accessed only from within the directly enclosing class, the class object (\sref{sec:object-definitions}) and any member of the directly enclosing class, including inner classes. They are not inherited by subclasses and they may not override definitions in parent classes. 

The modifier may be {\em qualified} with an identifier $C$ (e.g. \lstinline!private:[$C$]!) that must denote a class or a module enclosing the declaration or definition. Members labeled with such a modifier are accessible respectively only from code inside the module $C$ or only from code inside the class $C$ and the class object $C$. 

A different form of qualification is \lstinline!private:[self]!. A member $M$ marked with this modifier is called {\em object-private}; it can be accessed only from within the object in which it is defined. That is, a selection \lstinline!$p$.$M$! is only legal if the prefix ends with \code{this} or \code{self}. Moreover, the restrictions for unqualified \code{private} apply as well. 

Members marked \code{private} without any qualifier are called {\em class-private}. A member {\em is private} if it is either class-private or object-private, but not if it is marked \lstinline!private:[$C$]!, where $C$ is an identifier, in the latter case the member is called {\em qualified private}. 

Class-private and object-private members must not be \code{abstract}, since there is no way to provide a concrete implementation for them, as private members are not inherited. Moreover, modifiers \code{protected} \& \code{public} can not be applied to them (that would be a contradiction\footnote{E.g., a member can not be public and private at the same time.}), and the modifier \code{override} can not be applied to them as well\footnote{Otherwise, if a private member could override an inherited member, that would mean there is an inherited member that could be overridden, but private members can not override anything: only protected and public members can be overridden. If a member was overriding an inherited member, the parent class would {\em lose access} to it.}. 

\item
The \code{protected} access modifier can be used with any declaration or definition in a class. Protected members of a class can be accessed from within: 
\begin{itemize}
\item the defining class
\item all classes that have the defining class as a base class
\item all class objects of any of those classes
\end{itemize}

\end{itemize}

A rule for access modifiers in scope of overriding: Any overriding member may be defined with the same access modifier, or with a less restrictive access modifier. No overriding member can have more restrictive access modifier, since the parent class would {\em lose access} to the member, and that is unacceptable. 
\begin{itemize}
\item Modifier \code{public} is less restrictive than any other access modifier. 
\item Qualified modifier \code{protected} is less restrictive than an unqualified \code{protected}, only if the class that the modifier is qualified with is among base classes of the original class -- the original class must not lose access. 
\item Qualified modifier \code{protected} is less restrictive than object-protected, only if the class that the modifier is qualified with is among base classes of the original class -- the original class must not lose access. 
\item While \code{protected} is certainly less restrictive than \code{private}, private members are not inherited and thus can not be overridden. 
\item While qualified \code{private} is certainly less restrictive than unqualified \code{private}, private members are not inherited and thus can not be overridden. 
\end{itemize}
The relaxations of access modifiers for overriding members are then available as follows: 
\begin{itemize}
\item \lstinline!protected:[self] $\rightarrow$ {protected, protected:[$C$], public}!
\item \lstinline!protected $\rightarrow$ {protected:[$C$], public}!
\item \lstinline!protected:[$C$] $\rightarrow$ {public}!
\item \lstinline!protected:[$C$] $\rightarrow$ {protected:[$D$], public}!

This is only for the case where $C$ is accessible from within $D$. 
\item \lstinline!public $\rightarrow$ {public}!
\end{itemize}

\section{Object Definitions}
\label{sec:object-definitions}

\syntax\begin{lstlisting}
Obj_Def  ::= constant_id [Superclass] [semi]
           | {Object_Expr}
Obj_Expr ::= Clone_Expr
           | Includes_Expr
           | Prepend_Expr
           | Implements_Expr
           | Expr
           | {Annotation} 'class' Class_Def 'end' ['class']
           | {Annotation} 'object' Obj_Def 'end' ['object']
           | {Annotation} 'mixin' Mixin_Def 'end' ['mixin']
           | {Annotation} 'protocol' Pro_Def 'end' ['protocol']
           | {Annotation} 'interface' Ifc_Def 'end' 
             ['interface']
           | {Annotation} 'type' Const_Type_Def 'end' ['type']
\end{lstlisting}

Object definitions emphasize the fact that classes in Coral are also objects. Every object defined by an object definition $C$ is a singleton instance of \lstinline!Class:[$C$]!. Such an object may itself implement protocols and include mixins, if desirable. The class defined by an object definition is empty and inherits from its superclasses. When accompanied by a non-empty class, the object definition is also called the {\em class object}, and may have methods defined by other means as well (see examples in \sref{sec:metaclasses}).

Object definition is almost the same as a class definition, except that members defined in it and \code{clone}, \code{include}, \code{prepend} and \code{implements} expressions are relative to the class object, and not the class itself -- that is, every member defined in an object definition is a class member, not a class instance member. Types defined in the object definition are equivalent to types defined in a class definition. 

Modifiers (\sref{sec:modifiers}) are available in the same way as in class definitions. 

If an object definition is preceded by a class definition of the same name in the same source file, the superclass is transferred from the class definition and need not be explicitly stated. It is an error if the superclasses differ. It is also an error if the object definition has no explicit superclass (which is then implicitly \code{Object}), and a class with an explicit superclass other than \code{Object} is loaded dynamically -- since then the superclasses would differ again. 

\section{Module Definitions}
\label{sec:module-definitions}

\section{Mixins}
\label{sec:mixins}

\subsection{Refinements}
\label{sec:refinements}

\section{Protocols}
\label{sec:protocols}

\section{Interfaces}
\label{sec:interfaces}

\section{Unions}
\label{sec:unions}

\section{Enums}
\label{sec:enums}

\section{Range Types}
\label{sec:range-types}

\section{Units of Measure}
\label{sec:units-of-measure}

\section{Record Types}
\label{sec:record-types}

\section{Struct Types}
\label{sec:struct-types}


\chapter{Expressions}

\section{Expression Typing}

\section{Literals}

\section{The Nil Value}

\section{Designators}

\section{Self, This \& Super}

\section{Function Applications}
\label{sec:function-applications}

\subsection{Named and Optional Arguments}
\label{sec:named-optional-arguments}

\subsection{By-Name Arguments}
\label{sec:by-name-arguments}

\subsection{Input \& Output Arguments}
\label{sec:io-arguments}

\subsection{Function Compositions \& Pipelines}

\section{Method Values}

\section{Type Applications}

\section{Tuples}

\section{Instance Creation Expressions}

\section{Blocks}

\subsection{Local Variable Closure}
\label{sec:local-variable-closure}

\section{Prefix \& Infix Operations}

\subsection{Prefix Operations}

\subsection{Infix Operations}

\subsection{Assignment Operators}

\section{Typed Expressions}

\section{Annotated Expressions}
\label{sec:annotated-exprs}

\section{Assignments}

\section{Conditional Expressions}

\section{Loop Expressions}

\subsection{Classic For Expressions}

\subsection{Iterable For Expressions}

\subsection{Basic Loop Expressions}

\subsection{While \& Until Loop Expressions}

\subsection{Conditions in Loop Expressions}

\section{Collection Comprehensions}

\section{Return Expressions}

\subsection{Implicit Return Expressions}

\subsection{Explicit Return Expressions}

\subsection{Structured Return Expressions}

\section{Raise Expressions}

\section{Rescue \& Ensure Expressions}

\section{Throw \& Catch Expressions}

\section{Anonymous Functions}

\section{Conversions}

\subsection{Type Casting}

\section{Workflows}
\label{sec:workflows}

\chapter{Implicit Parameters \& Views}

\section{The Implicit Modifier}

\section{Implicit Parameters}
\label{sec:implicit-parameters}

\section{Views}

\chapter{Pattern Matching}

\section{Patterns}
\label{sec:patterns}

\subsection{Variable Patterns}

\subsection{Typed Patterns}

\subsection{Literal Patterns}

\subsection{Constructor Patterns}

\subsection{Tuple Patterns}

\subsection{Extractor Patterns}

\subsection{Pattern Alternatives}

\subsection{Regular Expression Patterns}

\section{Type Patterns}

\section{Pattern Matching Expressions}

\section{Pattern Matching Anonymous Functions}

\chapter{Top-Level Definitions}

\section{Compilation Units}
\label{sec:compilation-units}

\section{Modules}
\label{sec:modules}

\section{Module References}

\section{Top-Level Classes}

\section{Programs}

\chapter{Annotations}
\label{sec:annotations}

\chapter{Naming Guidelines}

\chapter{The Coral Standard Library}

\section{Root Classes}

\subsection{The Object Class}

\subsection{The Nothing Class}

\section{Value Classes}

\section{Standard Reference Classes}



















